<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Equipo Baloncesto - Pasarela (Cloud)</title>

    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAAbaUEbPjltfQrDethVojxoxD1gj4AC0w",
            authDomain: "basketmanager-ed370.firebaseapp.com",
            projectId: "basketmanager-ed370",
            storageBucket: "basketmanager-ed370.firebasestorage.app",
            messagingSenderId: "177594386006",
            appId: "1:177594386006:web:8eef1b258c8dc6b395ddf7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Expose DB and Auth to window for React component to use
        window.db = db;
        window.auth = auth;
        window.firebaseMethods = {
            collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query, orderBy, where,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged,
            GoogleAuthProvider, signInWithPopup
        };
    </script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            touch-action: manipulation;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Logic & Types ---
        const TOTAL_PERIODS = 8;
        const APP_VERSION = '1.4.0';
        const CHECK_PERIOD = 6;
        const MIN_PLAY = 2;
        const MIN_REST = 2;

        const DEFAULT_ROLES = {
            'receptor': { label: 'Receptor', order: 1, color: 'text-blue-600', bg: 'bg-blue-50' },
            'medio': { label: 'Medio', order: 2, color: 'text-green-600', bg: 'bg-green-50' },
            'largo': { label: 'Largo', order: 3, color: 'text-purple-600', bg: 'bg-purple-50' },
            'sacador': { label: 'Sacador', order: 4, color: 'text-orange-600', bg: 'bg-orange-50' }
        };

        const getRoles = (team) => team?.roles || DEFAULT_ROLES;

        const COLORS = [
            { id: 'blue', label: 'Azul', text: 'text-blue-600', bg: 'bg-blue-50' },
            { id: 'green', label: 'Verde', text: 'text-green-600', bg: 'bg-green-50' },
            { id: 'purple', label: 'Violeta', text: 'text-purple-600', bg: 'bg-purple-50' },
            { id: 'orange', label: 'Naranja', text: 'text-orange-600', bg: 'bg-orange-50' },
            { id: 'red', label: 'Rojo', text: 'text-red-600', bg: 'bg-red-50' },
            { id: 'pink', label: 'Rosa', text: 'text-pink-600', bg: 'bg-pink-50' },
            { id: 'yellow', label: 'Amarillo', text: 'text-yellow-600', bg: 'bg-yellow-50' },
            { id: 'slate', label: 'Gris', text: 'text-slate-600', bg: 'bg-slate-50' },
            { id: 'cyan', label: 'Cian', text: 'text-cyan-600', bg: 'bg-cyan-50' },
        ];

        const updateTeamInDb = async (teamId, updates) => {
            const { updateDoc, doc } = window.firebaseMethods;
            const db = window.db;
            const teamRef = doc(db, "teams", teamId);
            await updateDoc(teamRef, updates);
        };

        const TeamDetailView = ({ team, matches, setView, setActiveMatchId, updateTeamInDb, getRoles }) => {
            const [newPlayerName, setNewPlayerName] = useState('');
            const [newPlayerNumber, setNewPlayerNumber] = useState('');
            const [newRoleName, setNewRoleName] = useState('');
            const [newRoleColor, setNewRoleColor] = useState('blue');
            const [isEditingName, setIsEditingName] = useState(false);
            const [tempName, setTempName] = useState(team?.name || '');

            useEffect(() => {
                setTempName(team?.name || '');
            }, [team]);

            const saveTeamName = async () => {
                if (!tempName.trim() || tempName === team.name) {
                    setIsEditingName(false);
                    return;
                }
                await updateTeamInDb(team.id, { name: tempName.trim() });
                setIsEditingName(false);
            };
            useEffect(() => {
                lucide.createIcons();
            }, [team, matches]);

            const players = team?.players || [];

            const addPlayer = async (e) => {
                e.preventDefault();
                if (!newPlayerName.trim() || !newPlayerNumber.trim()) return;
                const newPlayer = {
                    id: Date.now().toString(),
                    name: newPlayerName.trim(),
                    number: newPlayerNumber.trim(),
                    role: 'receptor'
                };
                const updatedPlayers = [...players, newPlayer];
                await updateTeamInDb(team.id, { players: updatedPlayers });
                setNewPlayerName('');
                setNewPlayerNumber('');
            };

            const deletePlayer = async (teamId, playerId) => {
                if (!confirm('¿Seguro que quieres eliminar este jugador?')) return;
                const updatedPlayers = players.filter(p => p.id !== playerId);
                await updateTeamInDb(teamId, { players: updatedPlayers });
            };

            const updatePlayerRole = async (playerId, newRole) => {
                const updatedPlayers = players.map(p => p.id === playerId ? { ...p, role: newRole } : p);
                await updateTeamInDb(team.id, { players: updatedPlayers });
            };

            const roles = getRoles(team);

            if (!team) return <div className="p-4">Error: Equipo no encontrado. <button onClick={() => setView('teams-list')}>Volver</button></div>;

            const teamMatches = matches.filter(m => m.teamId === team.id);

            return (
                <div className="p-4 max-w-md mx-auto pb-24">
                    <header className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-2 flex-1">
                            <button onClick={() => setView('teams-list')} className="p-2 -ml-2 text-slate-400 hover:text-slate-800 transition-colors"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span></button>
                            {isEditingName ? (
                                <div className="flex items-center gap-2 flex-1">
                                    <input
                                        autoFocus
                                        className="text-xl font-bold bg-slate-50 border-b-2 border-blue-500 outline-none w-full"
                                        value={tempName}
                                        onChange={e => setTempName(e.target.value)}
                                        onBlur={saveTeamName}
                                        onKeyDown={e => e.key === 'Enter' && saveTeamName()}
                                    />
                                </div>
                            ) : (
                                <div className="flex items-center gap-3">
                                    <h1 className="text-2xl font-bold text-slate-800">{team.name}</h1>
                                    <button onClick={() => { setTempName(team.name); setIsEditingName(true); }} className="p-1.5 text-slate-300 hover:text-blue-500 transition-colors">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="edit-3" class="w-4 h-4"></i>' }}></span>
                                    </button>
                                </div>
                            )}
                        </div>
                    </header>
                    <div className="grid grid-cols-2 gap-3 mb-8">
                        <button
                            onClick={() => setView('manage-players')}
                            className="flex flex-col items-center justify-center p-4 bg-white border border-slate-200 rounded-2xl shadow-sm hover:shadow-md hover:border-blue-200 transition-all group"
                        >
                            <div className="w-10 h-10 bg-blue-50 text-blue-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition-transform">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="users" class="w-5 h-5"></i>' }}></span>
                            </div>
                            <span className="font-bold text-slate-700 text-sm">Jugadores</span>
                        </button>
                        <button
                            onClick={() => setView('manage-roles')}
                            className="flex flex-col items-center justify-center p-4 bg-white border border-slate-200 rounded-2xl shadow-sm hover:shadow-md hover:border-amber-200 transition-all group"
                        >
                            <div className="w-10 h-10 bg-amber-50 text-amber-600 rounded-full flex items-center justify-center mb-2 group-hover:scale-110 transition-transform">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="settings" class="w-5 h-5"></i>' }}></span>
                            </div>
                            <span className="font-bold text-slate-700 text-sm">Posiciones</span>
                        </button>
                    </div>

                    <div className="space-y-8">
                        <section>
                            <div className="flex justify-between items-center mb-3">
                                <h3 className="font-bold text-slate-800">Partidos</h3>
                                <button
                                    onClick={() => setView('match-setup')}
                                    className="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold"
                                >
                                    + Nuevo Partido
                                </button>
                            </div>
                            <div className="space-y-2">
                                {teamMatches.length === 0 && <p className="text-sm text-slate-400">Sin partidos registrados.</p>}
                                {teamMatches.map(m => (
                                    <div
                                        key={m.id}
                                        onClick={() => { setActiveMatchId(m.id); setView('active-match'); }}
                                        className="bg-white p-3 rounded-lg border border-slate-200 flex justify-between items-center cursor-pointer hover:bg-slate-50"
                                    >
                                        <div>
                                            <p className="font-bold text-slate-800">vs {m.opponent}</p>
                                            <p className="text-xs text-slate-500">
                                                {m.date} {m.time ? `• ${m.time}` : ''} • {m.state === 'finished' ? (
                                                    <span className={m.result === 'won' ? 'text-green-600 font-bold' : (m.result === 'lost' ? 'text-red-500 font-bold' : '')}>
                                                        {m.result === 'won' ? 'Victoria' : (m.result === 'lost' ? 'Derrota' : 'Finalizado')}
                                                        {m.score ? ` (${m.score.local}-${m.score.visitor})` : ''}
                                                    </span>
                                                ) : `P${m.currentPeriod}`}
                                                {m.matchDay ? ` • J${m.matchDay}` : ''}
                                                {m.isHome !== undefined ? (m.isHome ? ' • Local' : ' • Visitante') : ''}
                                            </p>
                                        </div>
                                        <div className={`w-3 h-3 rounded-full ${m.state === 'finished' ? 'bg-green-500' : 'bg-blue-500 animate-pulse'}`}></div>
                                    </div>
                                ))}
                            </div>
                        </section>
                    </div>
                </div>
            );
        };

        const EditMatchView = ({ match, onSave }) => {
            const [opponent, setOpponent] = useState(match.opponent || '');
            const [matchDate, setMatchDate] = useState(match.date || '');
            const [matchTime, setMatchTime] = useState(match.time || '');
            const [matchDay, setMatchDay] = useState(match.matchDay || '');
            const [isHome, setIsHome] = useState(match.isHome !== undefined ? match.isHome : true);
            const [observations, setObservations] = useState(match.observations || '');
            const [localScore, setLocalScore] = useState(match.score?.local || '');
            const [visitorScore, setVisitorScore] = useState(match.score?.visitor || '');
            const [result, setResult] = useState(match.result || '');

            useEffect(() => {
                lucide.createIcons();
            }, []);

            return (
                <div className="bg-white p-4 rounded-xl border border-slate-200 space-y-4">
                    <div>
                        <label className="block text-sm font-bold text-slate-700 mb-1">Rival</label>
                        <input
                            className="w-full p-3 text-lg border rounded-xl"
                            placeholder="Nombre del rival"
                            value={opponent}
                            onChange={e => setOpponent(e.target.value)}
                        />
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">Fecha</label>
                            <input type="date" className="w-full p-2 border rounded-xl" value={matchDate} onChange={e => setMatchDate(e.target.value)} />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">Hora</label>
                            <input type="time" className="w-full p-2 border rounded-xl" value={matchTime} onChange={e => setMatchTime(e.target.value)} />
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">Jornada</label>
                            <input type="text" className="w-full p-2 border rounded-xl" placeholder="Ej. 1, 2..." value={matchDay} onChange={e => setMatchDay(e.target.value)} />
                        </div>
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-1">Local/Visitante</label>
                            <div className="flex border rounded-xl overflow-hidden">
                                <button className={`flex-1 p-2 text-sm font-bold ${isHome ? 'bg-blue-600 text-white' : 'bg-slate-50 text-slate-600'}`} onClick={() => setIsHome(true)}>Local</button>
                                <button className={`flex-1 p-2 text-sm font-bold ${!isHome ? 'bg-blue-600 text-white' : 'bg-slate-50 text-slate-600'}`} onClick={() => setIsHome(false)}>Visit.</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-bold text-slate-700 mb-1">Observaciones</label>
                        <textarea className="w-full p-2 border rounded-xl text-sm" rows="3" placeholder="Notas sobre el partido..." value={observations} onChange={e => setObservations(e.target.value)}></textarea>
                    </div>
                    <div className="bg-white p-4 rounded-xl border border-slate-200">
                        <h3 className="font-bold text-slate-700 mb-3 block">Resultado (Opcional)</h3>
                        <div className="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Local</label>
                                <input type="number" className="w-full p-2 border rounded-lg text-center font-bold" value={localScore} onChange={e => setLocalScore(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">Visitante</label>
                                <input type="number" className="w-full p-2 border rounded-lg text-center font-bold" value={visitorScore} onChange={e => setVisitorScore(e.target.value)} />
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold text-slate-500 mb-1">Estado Resultado</label>
                            <select className="w-full p-2 border rounded-lg" value={result} onChange={e => setResult(e.target.value)}>
                                <option value="">-- Automático / Ninguno --</option>
                                <option value="won">Victoria</option>
                                <option value="lost">Derrota</option>
                                <option value="draw">Empate</option>
                            </select>
                        </div>
                    </div>
                    <button
                        onClick={() => {
                            const scoreObj = (localScore !== '' && visitorScore !== '') ? { local: parseInt(localScore), visitor: parseInt(visitorScore) } : null;
                            let derivedResult = result;
                            if (!derivedResult && scoreObj) {
                                const we = isHome ? scoreObj.local : scoreObj.visitor;
                                const they = isHome ? scoreObj.visitor : scoreObj.local;
                                derivedResult = we > they ? 'won' : (we < they ? 'lost' : 'draw');
                            }
                            onSave({ opponent, date: matchDate, time: matchTime, matchDay, isHome, observations, score: scoreObj, result: derivedResult });
                        }}
                        className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 mt-4"
                    >
                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="save"></i>' }}></span> Guardar Cambios
                    </button>
                </div>
            );
        };

        const SubstitutionView = ({ players, currentP, localHistory, onCancel, onConfirm }) => {
            const pData = localHistory[currentP] || {};
            const currentPeriodData = Array.isArray(pData) ? pData.reduce((acc, id) => ({ ...acc, [id]: 'receptor' }), {}) : pData;
            const currentIds = Object.keys(currentPeriodData);
            const candidatesOut = players.filter(p => currentIds.includes(p.id));
            const candidatesIn = players.filter(p => !currentIds.includes(p.id) && !p.disabled);
            const [selectedOut, setSelectedOut] = useState(null);
            const [selectedIn, setSelectedIn] = useState(null);

            useEffect(() => {
                lucide.createIcons();
            }, []);

            return (
                <div className="p-4 max-w-md mx-auto">
                    <h2 className="font-bold text-lg mb-4 text-red-600 flex items-center gap-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="activity" class="w-5 h-5"></i>' }}></span> Sustitución por Lesión (P{currentP})</h2>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-2">Sale (Lesionado)</label>
                            <div className="grid grid-cols-2 gap-2">
                                {candidatesOut.map(p => (
                                    <button key={p.id} onClick={() => setSelectedOut(p.id)} className={`p-3 border rounded-xl text-left ${selectedOut === p.id ? 'bg-red-50 border-red-500 ring-1 ring-red-500' : 'bg-white border-slate-200'}`}>
                                        <span className="font-bold text-slate-700">#{p.number}</span> <span className="text-sm">{p.name}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="flex justify-center text-slate-300"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="arrow-down" class="w-6 h-6"></i>' }}></span></div>
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-2">Entra (Sustituto)</label>
                            <div className="grid grid-cols-2 gap-2">
                                {candidatesIn.map(p => (
                                    <button key={p.id} onClick={() => setSelectedIn(p.id)} className={`p-3 border rounded-xl text-left ${selectedIn === p.id ? 'bg-green-50 border-green-500 ring-1 ring-green-500' : 'bg-white border-slate-200'}`}>
                                        <span className="font-bold text-slate-700">#{p.number}</span> <span className="text-sm">{p.name}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-2 mt-8">
                        <button onClick={onCancel} className="p-3 border rounded-xl font-bold text-slate-500">Cancelar</button>
                        <button onClick={() => onConfirm(selectedOut, selectedIn)} disabled={!selectedOut || !selectedIn} className="p-3 bg-red-600 text-white rounded-xl font-bold disabled:opacity-50">Confirmar Cambio</button>
                    </div>
                </div>
            );
        };

        const ActiveMatchView = ({ match, teams, updateMatchInDb, setView, setActiveMatchId, getRoles }) => {
            if (!match) return <div className="p-4">Cargando partido...</div>;
            const [localHistory, setLocalHistory] = useState(match?.history || {});
            const [mode, setMode] = useState('matrix');
            const [matchInjuries, setMatchInjuries] = useState(match?.injuries || []);
            const [sortBy, setSortBy] = useState('role');
            const [editAllMode, setEditAllMode] = useState(false);
            const [forceEdit, setForceEdit] = useState(false);
            const [showFinishModal, setShowFinishModal] = useState(false);
            const [finalScore, setFinalScore] = useState({ local: '', visitor: '' });

            useEffect(() => {
                if (showFinishModal && match?.score) {
                    setFinalScore({
                        local: match.score.local || '',
                        visitor: match.score.visitor || ''
                    });
                }
            }, [showFinishModal, match?.score]);

            const currentP = match?.currentPeriod || 1;
            const isFinished = match?.state === 'finished';
            const isLocked = isFinished && !forceEdit;
            const totalRenderedPeriods = Math.max(TOTAL_PERIODS, currentP);
            const periodsArray = Array.from({ length: totalRenderedPeriods }, (_, i) => i + 1);

            const team = teams.find(t => t.id === match?.teamId);
            const roles = getRoles(team);
            const roleKeys = Object.keys(roles);

            useEffect(() => {
                if (match?.history) {
                    const sanitizedHistory = { ...match.history };
                    Object.keys(sanitizedHistory).forEach(p => {
                        if (Array.isArray(sanitizedHistory[p])) {
                            const asObj = {};
                            sanitizedHistory[p].forEach(pid => {
                                const pObj = match.players?.find(pl => pl.id === pid);
                                asObj[pid] = pObj?.role || 'receptor';
                            });
                            sanitizedHistory[p] = asObj;
                        }
                    });
                    setLocalHistory(sanitizedHistory);
                }
                if (match?.injuries) setMatchInjuries(match.injuries);
            }, [match]);

            useEffect(() => {
                lucide.createIcons();
            });

            const togglePlay = async (period, playerId) => {
                if (isLocked) return;
                const isEditable = editAllMode || period === currentP;
                if (!isEditable) return;

                const pData = localHistory[period];
                let currentRole = null;
                if (Array.isArray(pData)) {
                    if (pData.includes(playerId)) currentRole = (match.players.find(p => p.id === playerId)?.role) || 'receptor';
                } else if (pData && pData[playerId]) {
                    currentRole = pData[playerId];
                }

                const periodState = { ...(localHistory[period] && !Array.isArray(localHistory[period]) ? localHistory[period] : {}) };
                if (Array.isArray(localHistory[period])) {
                    localHistory[period].forEach(pid => periodState[pid] = (match.players.find(p => p.id === pid)?.role) || 'receptor');
                }

                if (!currentRole) {
                    if (Object.keys(periodState).length >= 5) {
                        alert("Máximo 5 jugadores por periodo");
                        return;
                    }
                }

                await handleToggle(period, playerId, currentRole, periodState);
            };

            const handleToggle = async (period, playerId, currentRole, periodState) => {
                let nextRole = null;
                const teamPlayer = team.players?.find(p => p.id === playerId);
                const defaultRole = teamPlayer?.role || roleKeys[0] || 'receptor';

                // Sequence logic:
                // 1. If not playing (no currentRole) -> Default Role
                // 2. If currentRole is ANY role except the last in our cycle -> Next Role
                // 3. If currentRole is the last available role -> Remove (nextRole = null)

                // Create a rotation list that starts with defaultRole, then all other roles order
                const otherRoles = roleKeys.filter(r => r !== defaultRole);
                const rotationCycle = [defaultRole, ...otherRoles];

                if (!currentRole) {
                    nextRole = defaultRole;
                } else {
                    const currentIndex = rotationCycle.indexOf(currentRole);
                    if (currentIndex !== -1 && currentIndex < rotationCycle.length - 1) {
                        nextRole = rotationCycle[currentIndex + 1];
                    } else {
                        nextRole = null;
                    }
                }

                const newPeriodState = { ...periodState };
                if (nextRole) {
                    newPeriodState[playerId] = nextRole;
                } else {
                    delete newPeriodState[playerId];
                }

                const newHistory = { ...localHistory, [period]: newPeriodState };
                setLocalHistory(newHistory);
                await updateMatchInDb(match.id, { history: newHistory });
            };

            const clearPlay = async (e, period, playerId) => {
                e.preventDefault();
                if (isLocked) return;
                const status = getPeriodStatus(period);
                const isEditable = editAllMode || status === 'active';
                if (!isEditable || (match.players.find(p => p.id === playerId)?.disabled)) return;

                const newPeriodState = { ...(localHistory[period] && !Array.isArray(localHistory[period]) ? localHistory[period] : {}) };
                if (Array.isArray(localHistory[period])) {
                    localHistory[period].forEach(pid => newPeriodState[pid] = (match.players.find(p => p.id === pid)?.role) || 'receptor');
                }

                if (!newPeriodState[playerId]) return;

                delete newPeriodState[playerId];
                const newHistory = { ...localHistory, [period]: newPeriodState };
                setLocalHistory(newHistory);
                await updateMatchInDb(match.id, { history: newHistory });
            };

            const getPeriodStatus = (period) => {
                if (period < currentP) return 'past';
                if (period === currentP) return 'active';
                return 'future';
            };

            const getStats = (playerId) => {
                let played = 0;
                for (let i = 1; i <= totalRenderedPeriods; i++) {
                    const pData = localHistory[i];
                    let inPeriod = false;
                    if (Array.isArray(pData)) inPeriod = pData.includes(playerId);
                    else if (pData) inPeriod = !!pData[playerId];

                    if (inPeriod) {
                        const isInjured = matchInjuries.find(inj => inj.period === i && (inj.playerOut === playerId || inj.playerIn === playerId));
                        if (!isInjured) played++;
                    }
                }
                return { played };
            };

            const getValidationState = () => {
                const errors = [];
                const warnings = [];
                const historyArray = {};
                for (let i = 1; i <= totalRenderedPeriods; i++) {
                    const pData = localHistory[i];
                    historyArray[i] = Array.isArray(pData) ? pData : (pData ? Object.keys(pData) : []);
                }

                (match.players || []).forEach(p => {
                    if (p.disabled) return;

                    let playedInFirst6 = 0;
                    let restedInFirst6 = 0;
                    let limboInFirst6 = 0;

                    for (let i = 1; i <= 6; i++) {
                        const isInjured = matchInjuries.find(inj => inj.period === i && (inj.playerOut === p.id || inj.playerIn === p.id));
                        if (isInjured) {
                            limboInFirst6++;
                            continue;
                        }

                        if (i <= currentP) {
                            if (historyArray[i]?.includes(p.id)) playedInFirst6++;
                            else restedInFirst6++;
                        }
                    }

                    const remainingPeriods = 6 - Math.min(6, currentP);
                    const maxPossiblePlayed = playedInFirst6 + remainingPeriods;
                    const maxPossibleRested = restedInFirst6 + remainingPeriods;

                    if (playedInFirst6 > 4) errors.push(`${p.name} excede 4 periodos en los primeros 6.`);

                    if (maxPossiblePlayed < 2) {
                        errors.push(`¡Error Pasarela!: Es matemáticamente imposible que ${p.name} juegue los 2 periodos mínimos (solo llegaría a ${maxPossiblePlayed}).`);
                    } else if (playedInFirst6 < 2 && (isFinished || currentP >= 6)) {
                        errors.push(`${p.name} no cumple el mínimo de 2 periodos en los primeros 6.`);
                    }

                    if (maxPossibleRested < 2) {
                        errors.push(`¡Error Pasarela!: Es matemáticamente imposible que ${p.name} descanse los 2 periodos mínimos (solo llegaría a ${maxPossibleRested}).`);
                    } else if (restedInFirst6 < 2 && (isFinished || currentP >= 6)) {
                        errors.push(`${p.name} no cumple el mínimo de 2 periodos de descanso en los primeros 6.`);
                    }
                });
                return { errors, warnings };
            };

            const validations = getValidationState();

            const confirmPeriod = async () => {
                const pData = localHistory[currentP];
                const count = pData ? Object.keys(pData).length : 0;
                if (count !== 5) {
                    if (!confirm(`Has seleccionado ${count} jugadores. ¿Seguro que quieres cerrar el periodo?`)) return;
                }
                if (currentP >= TOTAL_PERIODS) {
                    setShowFinishModal(true);
                    return;
                }
                await updateMatchInDb(match.id, {
                    currentPeriod: currentP + 1,
                    history: localHistory,
                    state: 'active'
                });
            };

            const deleteMatch = async () => {
                if (!confirm("¿Eliminar este partido permanentemente?")) return;
                const { deleteDoc, doc } = window.firebaseMethods;
                const db = window.db;
                await deleteDoc(doc(db, "matches", match.id));
                setView("team-detail");
                setActiveMatchId(null);
            };

            const addLatePlayer = () => setMode("add-player");

            const confirmAddPlayer = async (player) => {
                const updatedPlayers = [...(match.players || []), player];
                await updateMatchInDb(match.id, { players: updatedPlayers });
                setMode('matrix');
            };

            const togglePlayerActiveStatus = async (playerId, playerName, currentDisabled) => {
                const action = currentDisabled ? "habilitar" : "deshabilitar";
                if (!confirm(`¿Deseas ${action} a ${playerName} para este partido?`)) return;
                const updatedPlayers = (match.players || []).map(p =>
                    p.id === playerId ? { ...p, disabled: !currentDisabled } : p
                );
                await updateMatchInDb(match.id, { players: updatedPlayers });
            };

            const handleSubstitution = async (playerOutId, playerInId) => {
                if (!playerOutId || !playerInId) return;
                const newInjury = { period: currentP, playerOut: playerOutId, playerIn: playerInId, timestamp: new Date().toISOString() };
                const updatedInjuries = [...matchInjuries, newInjury];
                const updatedHistory = { ...localHistory };
                const currentPeriodData = { ...(updatedHistory[currentP] || {}) };
                const outgoingRole = currentPeriodData[playerOutId];
                delete currentPeriodData[playerOutId];
                const playerIn = team.players?.find(p => p.id === playerInId);
                currentPeriodData[playerInId] = outgoingRole || playerIn?.role || 'receptor';
                updatedHistory[currentP] = currentPeriodData;
                await updateMatchInDb(match.id, { injuries: updatedInjuries, history: updatedHistory });
                setMode('matrix');
            };

            if (mode === 'add-player') {
                const currentIds = (match.players || []).map(p => p.id);
                const availablePlayers = (team.players || []).filter(p => !currentIds.includes(p.id));
                return (
                    <div className="p-4 max-w-md mx-auto">
                        <h2 className="font-bold text-lg mb-4">Añadir Jugador Tardío</h2>
                        <div className="space-y-2">
                            {availablePlayers.map(p => (
                                <button key={p.id} onClick={() => confirmAddPlayer(p)} className="w-full text-left p-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 flex justify-between items-center">
                                    <span className="font-bold">#{p.number} {p.name}</span>
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="plus-circle" class="text-green-600"></i>' }}></span>
                                </button>
                            ))}
                        </div>
                        <button onClick={() => setMode('matrix')} className="mt-4 w-full py-3 text-slate-500 font-bold border rounded-xl">Cancelar</button>
                    </div>
                );
            }

            if (mode === 'summary') {
                return (
                    <div className="p-4 max-w-md mx-auto">
                        <header className="mb-6 flex items-center gap-2">
                            <button onClick={() => setView('team-detail')} className="p-2 -ml-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span></button>
                            <h1 className="text-2xl font-bold">Resumen</h1>
                        </header>
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                                    <tr><th className="p-3">Jugador</th><th className="p-3 text-center">Total Jugados</th></tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {(match.players || []).map(p => (
                                        <tr key={p.id}><td className="p-3 font-medium">{p.number} - {p.name}</td><td className="p-3 text-center">{getStats(p.id).played}</td></tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            }

            if (mode === 'substitution') return <SubstitutionView players={match.players || []} currentP={currentP} localHistory={localHistory} onCancel={() => setMode('matrix')} onConfirm={handleSubstitution} />;

            if (mode === 'edit-match') {
                return (
                    <div className="p-4 max-w-md mx-auto">
                        <header className="mb-6 flex items-center gap-2">
                            <button onClick={() => setMode('matrix')} className="p-2 -ml-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span></button>
                            <h1 className="text-2xl font-bold">Editar Partido</h1>
                        </header>
                        <EditMatchView match={match} onSave={async (updates) => { await updateMatchInDb(match.id, updates); setMode('matrix'); }} />
                    </div>
                );
            }

            const players = match.players || [];
            if (sortBy === 'role') {
                players.sort((a, b) => {
                    const roleA = (team.players || []).find(p => p.id === a.id)?.role || 'receptor';
                    const roleB = (team.players || []).find(p => p.id === b.id)?.role || 'receptor';
                    const orderA = roles[roleA]?.order || 99;
                    const orderB = roles[roleB]?.order || 99;
                    return orderA - orderB || parseInt(a.number) - parseInt(b.number);
                });
            } else {
                players.sort((a, b) => parseInt(a.number) - parseInt(b.number));
            }

            return (
                <div className="p-2 md:p-4 max-w-4xl mx-auto pb-24">
                    <header className="mb-4">
                        <div className="flex items-center justify-between mb-2">
                            <button onClick={() => setView('team-detail')} className="p-2 -ml-2 text-slate-600 hover:text-slate-900"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left" class="w-6 h-6"></i>' }}></span></button>
                            <div className="text-center">
                                <h1 className="text-lg font-bold text-slate-800 leading-tight">vs {match.opponent}</h1>
                                <p className="text-xs text-slate-500">{match.date} • {isLocked ? 'Finalizado' : `P${currentP}`} • {match.score ? `(${match.score.local}-${match.score.visitor})` : ''}</p>
                            </div>
                            <div className="flex items-center gap-1">
                                {isFinished && isLocked && <button onClick={() => setForceEdit(true)} className="p-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors" title="Habilitar Edición"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="lock" class="w-5 h-5"></i>' }}></span></button>}
                                <button onClick={() => setEditAllMode(!editAllMode)} disabled={isLocked} className={`p-2 rounded-lg transition-colors border ${isLocked ? 'bg-slate-50 text-slate-300 opacity-50 cursor-not-allowed border-transparent' : (editAllMode ? 'bg-amber-100 text-amber-700 border-amber-300' : 'bg-slate-100 text-slate-500 border-transparent hover:bg-slate-200')}`} title="Modo Edición Total"><span dangerouslySetInnerHTML={{ __html: `<i data-lucide="${editAllMode ? 'unlock' : 'lock'}" class="w-5 h-5"></i>` }}></span></button>
                                <button onClick={addLatePlayer} disabled={isLocked} className={`p-2 rounded-lg transition-colors ${isLocked ? 'bg-slate-50 text-slate-300 opacity-50 cursor-not-allowed' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`} title="Añadir Convocado"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="user-plus" class="w-5 h-5"></i>' }}></span></button>
                                <button onClick={() => setMode('edit-match')} className="p-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition-colors" title="Configurar Partido"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="settings" class="w-5 h-5"></i>' }}></span></button>
                                <button onClick={deleteMatch} disabled={isLocked} className={`p-2 rounded-lg transition-colors ${isLocked ? 'bg-slate-50 text-slate-300 opacity-50 cursor-not-allowed' : 'bg-red-50 text-red-600 hover:bg-red-100'}`} title="Eliminar Partido"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="trash-2" class="w-5 h-5"></i>' }}></span></button>
                            </div>
                        </div>
                    </header>
                    {(validations.errors.length > 0 || validations.warnings.length > 0) && (
                        <div className="mb-4 bg-red-50 border-l-4 border-red-500 p-3 rounded-r-md text-sm shadow-sm">
                            {validations.errors.map((e, i) => <div key={`err-${i}`} className="text-red-700 font-bold flex items-center gap-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="alert-triangle" class="w-4 h-4"></i>' }}></span> {e}</div>)}
                            {validations.warnings.map((w, i) => <div key={`warn-${i}`} className="text-amber-700 flex items-center gap-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="info" class="w-4 h-4"></i>' }}></span> {w}</div>)}
                        </div>
                    )}
                    <div className="overflow-x-auto bg-white rounded-xl shadow-sm border border-slate-200">
                        <table className="w-full text-sm border-collapse">
                            <thead>
                                <tr className="bg-slate-100 text-slate-600">
                                    <th className="p-2 text-left sticky left-0 bg-slate-100 z-10 border-b border-r w-32"><div className="flex items-center justify-between"><span>Jugador</span><button onClick={() => setSortBy(sortBy === 'role' ? 'number' : 'role')} className="p-1 hover:bg-slate-200 rounded transition-colors text-slate-400" title={`Ordenar por ${sortBy === 'role' ? 'Número' : 'Rol'}`}><span dangerouslySetInnerHTML={{ __html: `<i data-lucide="${sortBy === 'role' ? 'users' : 'hash'}" class="w-3 h-3"></i>` }}></span></button></div></th>
                                    {periodsArray.map(p => (<th key={p} className={`p-2 text-center min-w-[40px] border-b ${p === currentP ? 'bg-blue-100/50 text-blue-800 border-blue-200 font-bold ring-2 ring-inset ring-blue-300' : ''}`}>P{p}</th>))}
                                    <th className="p-2 text-center border-b w-12 bg-slate-50">Tot</th>
                                </tr>
                            </thead>
                            <tbody>
                                {players.map(p => {
                                    const isDisabled = p.disabled;
                                    const isPlayingNow = !!(localHistory[currentP]?.[p.id]);
                                    const hasError = validations.errors.some(e => e.includes(p.name));
                                    const defaultRole = (team.players || []).find(tp => tp.id === p.id)?.role;
                                    return (
                                        <tr key={p.id} className={`border-b last:border-0 h-10 group/row ${isDisabled ? 'bg-slate-100 text-slate-400' : (hasError ? 'bg-red-100 border-red-200' : (isPlayingNow ? 'bg-blue-50/30' : 'hover:bg-slate-50'))}`}>
                                            <td className={`p-2 border-r sticky left-0 z-10 font-medium text-xs md:text-sm whitespace-nowrap flex items-center justify-between ${isDisabled ? 'bg-slate-100 text-slate-400' : (hasError ? 'bg-red-100 text-red-900 font-bold' : (isPlayingNow ? 'bg-blue-50 text-blue-900 font-extrabold' : 'bg-white text-slate-800 group-hover/row:bg-slate-50'))}`}>
                                                <div className={isDisabled ? 'line-through decoration-slate-400' : ''}><span className="inline-block w-6">#{p.number}</span><span className="mr-1">{p.name}</span>{!isDisabled && defaultRole && roles[defaultRole] && (<span className={`w-2 h-2 rounded-full inline-block mb-0.5 ${roles[defaultRole].bg.replace('-50', '-400')}`}></span>)}</div>
                                                {!isLocked && (<button onClick={() => togglePlayerActiveStatus(p.id, p.name, isDisabled)} className={`p-1 opacity-0 group-hover/row:opacity-100 transition-opacity ${isDisabled ? 'text-green-500 hover:text-green-700' : 'text-slate-300 hover:text-red-500'}`}><span dangerouslySetInnerHTML={{ __html: `<i data-lucide="${isDisabled ? 'rotate-ccw' : 'ban'}" class="w-3 h-3"></i>` }}></span></button>)}
                                            </td>
                                            {periodsArray.map(period => {
                                                const status = getPeriodStatus(period);
                                                const isEditable = editAllMode || status === 'active';
                                                const pData = localHistory[period];
                                                let isSelected = false; let role = null;
                                                if (pData && pData[p.id]) { isSelected = true; role = pData[p.id]; }
                                                const injuryData = matchInjuries.find(inj => inj.period === period && (inj.playerOut === p.id || inj.playerIn === p.id));
                                                const isOut = injuryData?.playerOut === p.id;
                                                const isIn = injuryData?.playerIn === p.id;

                                                // Special case: if player is OUT due to injury, they should still be considered "selected" for rendering the arrow
                                                const shouldShowCell = isSelected || isOut;
                                                return (
                                                    <td
                                                        key={period}
                                                        onClick={() => { if (!isLocked && isEditable && !isDisabled) togglePlay(period, p.id); }}
                                                        onContextMenu={(e) => clearPlay(e, period, p.id)}
                                                        className={`p-1 text-center border-r last:border-r-0 transition-all select-none relative ${shouldShowCell ? (isDisabled ? 'bg-slate-400' : (role && roles[role] ? roles[role].bg : (isOut ? 'bg-red-50' : 'bg-blue-500'))) : (isEditable && !isDisabled && !isLocked ? 'hover:bg-slate-100 cursor-pointer' : '')} ${!isEditable || isLocked ? 'opacity-80' : ''} ${period === currentP && !shouldShowCell && !isDisabled ? 'bg-blue-50/50' : ''} ${(isOut || isIn) ? '!bg-slate-200' : ''}`}
                                                    >
                                                        {shouldShowCell && (
                                                            <div className={`w-full h-full flex items-center justify-center font-bold text-xs ${isDisabled ? 'text-white' : (role && roles[role] ? roles[role].color : 'text-white')} ${(isOut || isIn) ? '!text-slate-500' : ''}`}>
                                                                {isOut ? (
                                                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="arrow-down" class="w-4 h-4 text-red-500"></i>' }}></span>
                                                                ) : (isIn ? (
                                                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="arrow-up" class="w-4 h-4 text-green-600"></i>' }}></span>
                                                                ) : (role ? role.substring(0, 1).toUpperCase() : (
                                                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="check" class="w-4 h-4"></i>' }}></span>
                                                                )))}
                                                            </div>
                                                        )}
                                                    </td>
                                                );
                                            })}
                                            <td className={`p-2 text-center border-l font-bold ${hasError ? 'bg-red-100 text-red-700' : 'bg-slate-50 text-slate-600'}`}>{getStats(p.id).played}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    {!isLocked && (
                        <div className="mt-4 p-4 bg-blue-50/50 rounded-xl border border-blue-100 animate-in fade-in slide-in-from-bottom-2">
                            <h3 className="text-xs font-bold text-blue-600 uppercase tracking-wider mb-2 flex items-center gap-2">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="users" class="w-4 h-4"></i>' }}></span> En pista ({Object.keys(localHistory[currentP] || {}).length})
                            </h3>
                            <div className="flex flex-wrap gap-2">
                                {players.filter(p => localHistory[currentP]?.[p.id]).map(p => {
                                    const role = localHistory[currentP][p.id];
                                    return (
                                        <span key={p.id} className="bg-white px-3 py-1.5 rounded-full border border-blue-200 text-sm font-bold text-blue-900 shadow-sm flex items-center gap-2 animate-in zoom-in-95">
                                            <span className="opacity-50">#{p.number}</span>
                                            {p.name}
                                            {role && roles[role] && <span className={`w-2 h-2 rounded-full ${roles[role].bg.replace('-50', '-400')}`}></span>}
                                        </span>
                                    );
                                })}
                                {Object.keys(localHistory[currentP] || {}).length === 0 && (
                                    <span className="text-sm text-slate-400 italic">No hay jugadores seleccionados</span>
                                )}
                            </div>
                        </div>
                    )}
                    {!isLocked && (
                        <div className="fixed bottom-4 left-4 right-4 max-w-md mx-auto flex gap-2">
                            <div className="flex-1 bg-white border border-slate-200 p-2 rounded-xl shadow-lg flex items-center justify-between px-4">
                                <div className="flex items-center gap-2">
                                    <button onClick={async () => { if (currentP > 1 && confirm("¿Volver al periodo anterior?")) await updateMatchInDb(match.id, { currentPeriod: currentP - 1 }); }} disabled={currentP <= 1} className="p-2 text-slate-400 hover:text-slate-700 disabled:opacity-30"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="arrow-left" class="w-5 h-5"></i>' }}></span></button>
                                    <span className="font-bold text-slate-700">P{currentP}</span>
                                    <button onClick={() => setMode('substitution')} className="bg-red-50 text-red-600 rounded-full p-1 hover:bg-red-100 ml-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="activity" class="w-4 h-4"></i>' }}></span></button>
                                </div>
                                <div className="text-xs text-slate-400 flex items-center gap-1"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="users" class="w-3 h-3"></i>' }}></span>{Object.keys(localHistory[currentP] || {}).length}/5</div>
                            </div>
                            <button onClick={confirmPeriod} className={`p-4 px-6 rounded-xl shadow-lg flex items-center gap-2 font-bold text-white transition-all ${currentP >= TOTAL_PERIODS ? 'bg-green-600 hover:bg-green-700' : 'bg-slate-900 hover:bg-slate-800'}`}>
                                {currentP >= TOTAL_PERIODS ? <><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="flag"></i>' }}></span> Finalizar</> : <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="arrow-right"></i>' }}></span>}
                            </button>
                        </div>
                    )}
                    {showFinishModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full animate-in zoom-in-95">
                                <h2 className="text-2xl font-bold mb-2">Fin del partido</h2>
                                <p className="text-slate-500 mb-6">Introduce el resultado final.</p>
                                <div className="mb-6 grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Local</label><input type="number" className="w-full p-2 border rounded-lg text-center text-lg font-bold" value={finalScore.local} onChange={e => setFinalScore({ ...finalScore, local: e.target.value })} /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Visitante</label><input type="number" className="w-full p-2 border rounded-lg text-center text-lg font-bold" value={finalScore.visitor} onChange={e => setFinalScore({ ...finalScore, visitor: e.target.value })} /></div>
                                </div>
                                <div className="space-y-3">
                                    <button onClick={async () => {
                                        const score = { local: parseInt(finalScore.local) || 0, visitor: parseInt(finalScore.visitor) || 0 };
                                        let result = null;
                                        if (finalScore.local !== '' && finalScore.visitor !== '') {
                                            const we = match.isHome !== false ? score.local : score.visitor;
                                            const they = match.isHome !== false ? score.visitor : score.local;
                                            result = we > they ? 'won' : (we < they ? 'lost' : 'draw');
                                        }
                                        await updateMatchInDb(match.id, { state: 'finished', history: localHistory, score, result });
                                        setMode('summary'); setShowFinishModal(false);
                                    }} className="w-full p-4 bg-green-600 text-white font-bold rounded-xl flex items-center justify-center gap-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="check-circle"></i>' }}></span> Finalizar Partido</button>
                                    <button onClick={async () => { await updateMatchInDb(match.id, { currentPeriod: currentP + 1, history: localHistory }); setShowFinishModal(false); }} className="w-full p-4 bg-blue-50 text-blue-700 font-bold rounded-xl flex items-center justify-center gap-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="plus-circle"></i>' }}></span> Añadir Prórroga (P{currentP + 1})</button>
                                    <button onClick={() => setShowFinishModal(false)} className="w-full p-2 text-slate-400 font-medium mt-2">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        const TeamsListView = ({ teams, setView, setSelectedTeamId, addDoc, collection, db, deleteDoc, doc, subscription, startCheckout }) => {
            const [newTeamName, setNewTeamName] = useState('');
            const [showForm, setShowForm] = useState(false);

            const createTeam = async (e) => {
                e.preventDefault();
                if (!newTeamName.trim() || !window.auth.currentUser) return;

                // --- Nueva Lógica de Límites ---
                if (teams.length >= 1 && subscription === null) {
                    alert('Límite del Plan Gratuito: Solo puedes gestionar 1 equipo. Pásate a Premium para equipos ilimitados.');
                    startCheckout();
                    return;
                }

                await addDoc(collection(db, 'teams'), {
                    name: newTeamName,
                    players: [],
                    roles: DEFAULT_ROLES,
                    ownerId: window.auth.currentUser.uid,
                    createdAt: new Date().toISOString()
                });
                setNewTeamName('');
                setShowForm(false);
            };

            const deleteTeam = async (id) => {
                if (confirm('¿Eliminar equipo?')) {
                    await deleteDoc(doc(db, 'teams', id));
                }
            };

            useEffect(() => {
                if (window.lucide) lucide.createIcons();
            }, [teams, showForm, subscription]);

            return (
                <div className="p-4 max-w-md mx-auto">
                    <header className="flex justify-between items-center mb-4">
                        <div>
                            <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight">Equipos</h1>
                            <div className="flex items-center gap-2 mt-1">
                                <button onClick={() => window.firebaseMethods.signOut(window.auth)} className="text-[10px] font-bold text-slate-400 hover:text-red-500 uppercase tracking-widest flex items-center gap-1">
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="log-out" class="w-2 h-2"></i>' }}></span> Cerrar Sesión
                                </button>
                                <span className="text-[10px] text-slate-300">•</span>
                                {subscription ? (
                                    <span className="text-[10px] font-bold text-amber-500 uppercase tracking-widest flex items-center gap-1">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="crown" class="w-2 h-2"></i>' }}></span> Premium
                                    </span>
                                ) : (
                                    <button onClick={startCheckout} className="text-[10px] font-bold text-blue-600 hover:underline uppercase tracking-widest flex items-center gap-1">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="zap" class="w-2 h-2"></i>' }}></span> Plan Gratuito
                                    </button>
                                )}
                            </div>
                        </div>
                        <button
                            onClick={() => setShowForm(!showForm)}
                            className={`p-2 rounded-full transition-all ${showForm ? 'bg-slate-200 text-slate-600 rotate-45' : 'bg-slate-800 text-white shadow-lg'}`}
                            title="Añadir Equipo"
                        >
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="plus" class="w-6 h-6"></i>' }}></span>
                        </button>
                    </header>

                    {subscription === null && (
                        <div className="mb-6 p-4 bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl shadow-lg relative overflow-hidden group">
                            <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="crown" class="w-20 h-20 text-white"></i>' }}></span>
                            </div>
                            <div className="relative z-10">
                                <h3 className="text-white font-bold text-lg leading-tight mb-1">Pásate a Premium</h3>
                                <p className="text-blue-100 text-xs mb-3">Gestión de equipos ilimitados, estadísticas avanzadas y más.</p>
                                <button onClick={startCheckout} className="px-4 py-2 bg-white text-blue-600 rounded-lg font-bold text-xs shadow-sm active:scale-95 transition-all">
                                    Desbloquear equipos
                                </button>
                            </div>
                        </div>
                    )}

                    {showForm && (
                        <form onSubmit={createTeam} className="mb-8 flex gap-2 animate-in slide-in-from-top-2 duration-200">
                            <input
                                autoFocus
                                className="flex-1 p-3 border-2 border-slate-200 rounded-xl focus:border-slate-800 outline-none transition-all bg-white"
                                placeholder="Nombre del nuevo equipo..."
                                value={newTeamName}
                                onChange={e => setNewTeamName(e.target.value)}
                            />
                            <button className="bg-slate-800 text-white px-6 rounded-xl font-bold shadow-md hover:bg-slate-900 transition-colors">
                                Crear
                            </button>
                        </form>
                    )}

                    {teams.length === 0 ? (
                        <div className="text-center py-16 bg-white rounded-2xl border-2 border-dashed border-slate-200">
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="shield" class="w-12 h-12 text-slate-200 mx-auto mb-4"></i>' }}></span>
                            <p className="text-slate-400 font-medium">No hay equipos registrados.</p>
                            <button onClick={() => setShowForm(true)} className="text-blue-600 font-bold mt-2 text-sm underline-offset-4 hover:underline">Crear el primero</button>
                        </div>
                    ) : (
                        <div className="grid gap-3">
                            {teams.map(team => (
                                <div key={team.id} className="group bg-white p-4 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all flex justify-between items-center">
                                    <button
                                        onClick={() => { setSelectedTeamId(team.id); setView('team-detail'); }}
                                        className="flex-1 text-left"
                                    >
                                        <p className="font-extrabold text-xl text-slate-800 group-hover:text-blue-600 transition-colors">{team.name}</p>
                                        <p className="text-xs text-slate-400 mt-0.5">{team.players?.length || 0} Jugadores</p>
                                    </button>
                                    <button onClick={() => deleteTeam(team.id)} className="p-2 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all md:opacity-0 group-hover:opacity-100">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="trash-2" class="w-5 h-5"></i>' }}></span>
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const MatchSetupView = ({ team, setView, setActiveMatchId, addDoc, collection, db }) => {
            if (!team) { useEffect(() => setView('teams-list'), []); return null; }
            const [opponent, setOpponent] = useState('');
            const [matchDate, setMatchDate] = useState(new Date().toISOString().split('T')[0]);
            const [matchTime, setMatchTime] = useState(new Date().toTimeString().split(' ')[0].substring(0, 5));
            const [matchDay, setMatchDay] = useState('');
            const [isHome, setIsHome] = useState(true);
            const [observations, setObservations] = useState('');
            const [selectedPlayers, setSelectedPlayers] = useState([]);
            const players = team?.players || [];
            const togglePlayer = (playerId) => {
                setSelectedPlayers(prev =>
                    prev.includes(playerId) ? prev.filter(id => id !== playerId) : [...prev, playerId]
                );
            };
            const createMatch = async () => {
                if (!opponent.trim() || selectedPlayers.length === 0) {
                    alert('Debes ingresar un rival y seleccionar al menos un jugador.');
                    return;
                }
                const fullPlayers = players.filter(p => selectedPlayers.includes(p.id));
                const newMatch = {
                    teamId: team.id,
                    opponent,
                    date: matchDate,
                    time: matchTime,
                    matchDay,
                    isHome,
                    observations,
                    players: fullPlayers,
                    currentPeriod: 1,
                    state: 'active',
                    history: {},
                    injuries: [],
                    score: { local: 0, visitor: 0 },
                    ownerId: window.auth.currentUser.uid,
                    createdAt: new Date().toISOString()
                };
                const docRef = await addDoc(collection(db, 'matches'), newMatch);
                setActiveMatchId(docRef.id);
                setView('active-match');
            };
            useEffect(() => {
                lucide.createIcons();
            }, []);

            return (
                <div className="p-4 max-w-md mx-auto">
                    <header className="flex items-center gap-2 mb-6">
                        <button onClick={() => setView('team-detail')} className="p-2 -ml-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span></button>
                        <h1 className="text-2xl font-bold">Nuevo Partido</h1>
                    </header>
                    <div className="space-y-4 mb-6">
                        <input className="w-full p-3 border rounded-lg" placeholder="Rival" value={opponent} onChange={e => setOpponent(e.target.value)} />
                        <input type="date" className="w-full p-3 border rounded-lg" value={matchDate} onChange={e => setMatchDate(e.target.value)} />
                        <input type="time" className="w-full p-3 border rounded-lg" value={matchTime} onChange={e => setMatchTime(e.target.value)} />
                        <input className="w-full p-3 border rounded-lg" placeholder="Jornada (opcional)" value={matchDay} onChange={e => setMatchDay(e.target.value)} />
                        <div className="flex items-center gap-4">
                            <label className="flex items-center gap-2">
                                <input type="radio" checked={isHome} onChange={() => setIsHome(true)} />
                                <span>Local</span>
                            </label>
                            <label className="flex items-center gap-2">
                                <input type="radio" checked={!isHome} onChange={() => setIsHome(false)} />
                                <span>Visitante</span>
                            </label>
                        </div>
                        <textarea className="w-full p-3 border rounded-lg" placeholder="Observaciones (opcional)" rows="3" value={observations} onChange={e => setObservations(e.target.value)}></textarea>
                    </div>
                    <h3 className="font-bold mb-2">Seleccionar Jugadores</h3>
                    <div className="space-y-2 mb-6">
                        {players.map(p => (
                            <button
                                key={p.id}
                                onClick={() => togglePlayer(p.id)}
                                className={`w-full p-3 rounded-lg border flex items-center justify-between ${selectedPlayers.includes(p.id) ? 'bg-blue-50 border-blue-500' : 'bg-white border-slate-200'}`}
                            >
                                <span className="font-medium">#{p.number} {p.name}</span>
                                {selectedPlayers.includes(p.id) && <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="check" class="w-5 h-5 text-blue-600"></i>' }}></span>}
                            </button>
                        ))}
                    </div>
                    <button onClick={createMatch} className="w-full bg-slate-800 text-white p-4 rounded-lg font-bold">Crear Partido</button>
                </div>
            );
        };

        const ManagePlayersView = ({ team, setView, updateTeamInDb, getRoles }) => {
            if (!team) { useEffect(() => setView('teams-list'), []); return null; }
            const rolesObj = getRoles(team);
            const rolesList = Object.entries(rolesObj).map(([id, info]) => ({ id, ...info }));

            const [newPlayerName, setNewPlayerName] = useState('');
            const [newPlayerNumber, setNewPlayerNumber] = useState('');
            const [newPlayerRole, setNewPlayerRole] = useState(rolesList[0]?.id || 'receptor');
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editNumber, setEditNumber] = useState('');
            const [editRole, setEditRole] = useState('');

            const players = team.players || [];

            const addPlayer = async (e) => {
                e.preventDefault();
                if (!newPlayerName.trim() || !newPlayerNumber.trim()) return;
                const newPlayer = {
                    id: Date.now().toString(),
                    name: newPlayerName.trim(),
                    number: newPlayerNumber.trim(),
                    role: newPlayerRole
                };
                await updateTeamInDb(team.id, { players: [...players, newPlayer] });
                setNewPlayerName('');
                setNewPlayerNumber('');
            };

            const startEditing = (p) => {
                setEditingId(p.id);
                setEditName(p.name || '');
                setEditNumber(String(p.number || ''));
                setEditRole(p.role || rolesList[0]?.id || 'receptor');
            };

            const saveEdit = async () => {
                if (!editName.trim() || !String(editNumber).trim()) return;
                const updatedPlayers = players.map(p =>
                    p.id === editingId ? { ...p, name: editName.trim(), number: String(editNumber).trim(), role: editRole } : p
                );
                await updateTeamInDb(team.id, { players: updatedPlayers });
                setEditingId(null);
            };

            const deletePlayer = async (playerId) => {
                if (!confirm('¿Seguro que quieres eliminar este jugador?')) return;
                await updateTeamInDb(team.id, { players: players.filter(p => p.id !== playerId) });
            };

            useEffect(() => {
                lucide.createIcons();
            }, [editingId, players.length]);

            return (
                <div className="p-4 max-w-md mx-auto">
                    <header className="flex items-center gap-2 mb-6">
                        <button onClick={() => setView('team-detail')} className="p-2 -ml-2 transition-colors hover:bg-slate-100 rounded-lg">
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span>
                        </button>
                        <h1 className="text-2xl font-bold text-slate-800">Gestionar Jugadores</h1>
                    </header>

                    {!editingId && (
                        <form onSubmit={addPlayer} className="mb-6 space-y-2 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            <div className="flex gap-2">
                                <input className="flex-1 p-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:bg-white transition-colors" placeholder="Nombre del jugador" value={newPlayerName} onChange={e => setNewPlayerName(e.target.value)} />
                                <input className="w-20 p-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:bg-white transition-colors text-center" placeholder="Nº" value={newPlayerNumber} onChange={e => setNewPlayerNumber(e.target.value)} />
                            </div>
                            <div className="flex flex-wrap gap-2 pt-1">
                                {rolesList.map(r => (
                                    <button
                                        key={r.id}
                                        type="button"
                                        onClick={() => setNewPlayerRole(r.id)}
                                        className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all border ${newPlayerRole === r.id ? `${r.bg} ${r.color} border-current ring-1 ring-current` : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}`}
                                    >
                                        {r.label || r.name}
                                    </button>
                                ))}
                            </div>
                            <button className="w-full bg-slate-800 hover:bg-slate-900 text-white p-2 rounded-lg font-bold text-sm transition-colors flex items-center justify-center gap-2">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="plus" class="w-4 h-4"></i>' }}></span> Añadir Jugador
                            </button>
                        </form>
                    )}

                    <div className="space-y-3">
                        {players.map(p => (
                            <div key={p.id} className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                                {editingId === p.id ? (
                                    <div className="space-y-3">
                                        <div className="flex gap-2">
                                            <input className="flex-1 p-2 border border-slate-200 rounded-lg text-sm font-bold bg-blue-50" value={editName} onChange={e => setEditName(e.target.value)} />
                                            <input className="w-16 p-2 border border-slate-200 rounded-lg text-sm font-bold text-center bg-blue-50" value={editNumber} onChange={e => setEditNumber(e.target.value)} />
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {rolesList.map(r => (
                                                <button
                                                    key={r.id}
                                                    type="button"
                                                    onClick={() => setEditRole(r.id)}
                                                    className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all border ${editRole === r.id ? `${r.bg} ${r.color} border-current ring-1 ring-current` : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}`}
                                                >
                                                    {r.label || r.name}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={saveEdit} className="flex-1 bg-blue-600 text-white p-2 rounded-lg text-sm font-bold">Guardar</button>
                                            <button onClick={() => setEditingId(null)} className="flex-1 bg-slate-100 text-slate-600 p-2 rounded-lg text-sm font-bold">Cancelar</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <span className="w-9 h-9 flex items-center justify-center bg-slate-100 rounded-full text-slate-700 font-bold text-sm">{p.number}</span>
                                            <div className="flex flex-col">
                                                <span className="font-bold text-slate-800 leading-none">{p.name}</span>
                                                {p.role && rolesObj[p.role] && (
                                                    <span className={`text-[10px] font-bold uppercase mt-1 ${rolesObj[p.role].color}`}>{rolesObj[p.role].label || rolesObj[p.role].name}</span>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button onClick={() => startEditing(p)} className="p-2 text-slate-400 hover:text-blue-600">
                                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="edit-2" class="w-4 h-4"></i>' }}></span>
                                            </button>
                                            <button onClick={() => deletePlayer(p.id)} className="p-2 text-slate-400 hover:text-red-500">
                                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="trash-2" class="w-4 h-4"></i>' }}></span>
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ManageRolesView = ({ team, setView, updateTeamInDb, getRoles }) => {
            if (!team) { useEffect(() => setView('teams-list'), []); return null; }
            const [newRoleName, setNewRoleName] = useState('');
            const [newRoleColor, setNewRoleColor] = useState('blue');
            const [editingRoleId, setEditingRoleId] = useState(null);
            const [editRoleName, setEditRoleName] = useState('');
            const [editRoleColor, setEditRoleColor] = useState('blue');

            const roles = getRoles(team);
            const rolesList = Object.entries(roles).map(([id, info]) => ({
                id,
                name: info.label || info.name,
                color: info.color?.replace('text-', '').replace('-600', '') || info.color || 'slate'
            }));

            const addRole = async (e) => {
                e.preventDefault();
                if (!newRoleName.trim()) return;
                const newRoleId = Date.now().toString();
                const updatedRoles = {
                    ...roles,
                    [newRoleId]: {
                        label: newRoleName.trim(),
                        color: `text-${newRoleColor}-600`,
                        bg: `bg-${newRoleColor}-50`,
                        order: rolesList.length + 1
                    }
                };
                await updateTeamInDb(team.id, { roles: updatedRoles });
                setNewRoleName('');
            };

            const startEditingRole = (r) => {
                setEditingRoleId(r.id);
                setEditRoleName(r.name);
                setEditRoleColor(r.color);
            };

            const saveRoleEdit = async () => {
                if (!editRoleName.trim()) return;
                const updatedRoles = {
                    ...roles,
                    [editingRoleId]: {
                        ...roles[editingRoleId],
                        label: editRoleName.trim(),
                        color: `text-${editRoleColor}-600`,
                        bg: `bg-${editRoleColor}-50`
                    }
                };
                await updateTeamInDb(team.id, { roles: updatedRoles });
                setEditingRoleId(null);
            };

            const deleteRole = async (roleId) => {
                if (!confirm('¿Seguro?')) return;
                const newRoles = { ...roles };
                delete newRoles[roleId];
                await updateTeamInDb(team.id, { roles: newRoles });
            };

            useEffect(() => {
                lucide.createIcons();
            }, [editingRoleId, rolesList.length]);

            return (
                <div className="p-4 max-w-md mx-auto">
                    <header className="flex items-center gap-2 mb-6">
                        <button onClick={() => setView('team-detail')} className="p-2 -ml-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span></button>
                        <h1 className="text-2xl font-bold">Configurar Roles</h1>
                    </header>
                    {!editingRoleId && (
                        <form onSubmit={addRole} className="mb-6 space-y-3 bg-white p-3 rounded-xl border border-slate-200">
                            <input className="w-full p-2 border rounded-lg text-sm" placeholder="Nombre del Rol" value={newRoleName} onChange={e => setNewRoleName(e.target.value)} />
                            <div className="flex flex-wrap gap-2 p-1 bg-slate-50 rounded-lg">
                                {['blue', 'red', 'green', 'orange', 'purple', 'pink', 'slate', 'yellow', 'cyan'].map(color => (
                                    <button key={color} type="button" onClick={() => setNewRoleColor(color)} className={`w-6 h-6 rounded-full bg-${color}-500 border-2 ${newRoleColor === color ? 'border-slate-800 scale-110' : 'border-transparent'}`}></button>
                                ))}
                            </div>
                            <button className="w-full bg-slate-800 text-white p-2 rounded-lg font-bold text-sm">+ Añadir Rol</button>
                        </form>
                    )}
                    <div className="space-y-2">
                        {rolesList.map(r => (
                            <div key={r.id} className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                {editingRoleId === r.id ? (
                                    <div className="space-y-3">
                                        <input className="w-full p-2 border rounded-lg text-sm font-bold" value={editRoleName} onChange={e => setEditRoleName(e.target.value)} />
                                        <div className="flex flex-wrap gap-2 p-1 bg-slate-50 rounded-lg">
                                            {['blue', 'red', 'green', 'orange', 'purple', 'pink', 'slate', 'yellow', 'cyan'].map(color => (
                                                <button key={color} type="button" onClick={() => setEditRoleColor(color)} className={`w-6 h-6 rounded-full bg-${color}-500 border-2 ${editRoleColor === color ? 'border-slate-800 scale-110' : 'border-transparent'}`}></button>
                                            ))}
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={saveRoleEdit} className="flex-1 bg-green-600 text-white p-2 rounded-lg text-sm font-bold">Guardar</button>
                                            <button onClick={() => setEditingRoleId(null)} className="flex-1 bg-slate-100 text-slate-600 p-2 rounded-lg text-sm font-bold">Cancelar</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-3 h-3 rounded-full bg-${r.color}-500`}></div>
                                            <span className="font-bold text-slate-800">{r.name}</span>
                                        </div>
                                        <div className="flex gap-1">
                                            <button onClick={() => startEditingRole(r)} className="p-2 text-slate-400 hover:text-blue-600">
                                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="edit-2" class="w-4 h-4"></i>' }}></span>
                                            </button>
                                            <button onClick={() => deleteRole(r.id)} className="p-2 text-slate-400 hover:text-red-600">
                                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="trash-2" class="w-4 h-4"></i>' }}></span>
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const AuthView = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [error, setError] = useState('');
            const { signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } = window.firebaseMethods;
            const auth = window.auth;

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    let msg = err.message;
                    if (err.code === 'auth/invalid-credential') msg = "Credenciales inválidas";
                    if (err.code === 'auth/email-already-in-use') msg = "El email ya está en uso";
                    if (err.code === 'auth/weak-password') msg = "La contraseña es muy débil";
                    setError(msg);
                }
            };

            useEffect(() => {
                if (window.lucide) lucide.createIcons();
            }, [isLogin]);

            const handleGoogleSignIn = async () => {
                setError('');
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                    <div className="w-full max-w-md bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                        <div className="p-8">
                            <div className="flex justify-center mb-6">
                                <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg transform -rotate-6">
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="trophy" class="w-8 h-8 text-white"></i>' }}></span>
                                </div>
                            </div>
                            <h1 className="text-3xl font-bold text-center text-slate-800 mb-2">Basket Manager</h1>
                            <p className="text-center text-slate-500 mb-8">{isLogin ? 'Inicia sesión para continuar' : 'Crea tu cuenta gratuita'}</p>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1 pl-1">Email</label>
                                    <input type="email" required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none" placeholder="tu@email.com" value={email} onChange={e => setEmail(e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1 pl-1">Contraseña</label>
                                    <input type="password" required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none" placeholder="••••••••" value={password} onChange={e => setPassword(e.target.value)} />
                                </div>

                                {error && <div className="p-3 bg-red-50 text-red-600 text-xs font-bold rounded-xl border border-red-100">{error}</div>}

                                <button type="submit" className="w-full py-4 bg-slate-800 hover:bg-slate-900 text-white rounded-xl font-bold text-lg shadow-lg transition-transform active:scale-[0.98]">
                                    {isLogin ? 'Entrar' : 'Empezar ahora'}
                                </button>
                            </form>

                            <div className="mt-4">
                                <div className="relative flex py-4 items-center">
                                    <div className="flex-grow border-t border-slate-200"></div>
                                    <span className="flex-shrink mx-4 text-slate-400 text-xs font-bold uppercase tracking-widest">O</span>
                                    <div className="flex-grow border-t border-slate-200"></div>
                                </div>

                                <button
                                    onClick={handleGoogleSignIn}
                                    className="w-full py-3 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 rounded-xl font-bold flex items-center justify-center gap-3 transition-all shadow-sm active:scale-[0.98]"
                                >
                                    <svg className="w-5 h-5" viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" />
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                                    </svg>
                                    Continuar con Google
                                </button>
                            </div>

                            <div className="mt-8 text-center pt-6 border-t border-slate-100 flex flex-col items-center gap-2">
                                <p className="text-sm text-slate-500">
                                    {isLogin ? '¿No tienes cuenta?' : '¿Ya eres usuario?'}
                                    <button onClick={() => setIsLogin(!isLogin)} className="ml-2 text-blue-600 font-bold hover:underline">
                                        {isLogin ? 'Regístrate aquí' : 'Inicia sesión'}
                                    </button>
                                </p>
                                <span className="text-[10px] font-bold text-slate-300 uppercase tracking-widest mt-2">v{APP_VERSION}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const { collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query, orderBy, where, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } = window.firebaseMethods || {};
            const db = window.db;

            const [user, setUser] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [subscription, setSubscription] = useState(undefined); // undefined: loading, null: none, 'active'/'trialing': active
            const [checkoutLoading, setCheckoutLoading] = useState(false);
            const [teams, setTeams] = useState([]);
            const [matches, setMatches] = useState([]);
            const [view, setView] = useState('teams-list');
            const [selectedTeamId, setSelectedTeamId] = useState(null);
            const [activeMatchId, setActiveMatchId] = useState(null);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (!window.auth) return;
                return onAuthStateChanged(window.auth, (u) => {
                    setUser(u);
                    setAuthLoading(false);
                    if (!u) setView('teams-list');
                });
            }, []);


            if (!window.firebaseMethods) return <div className="p-8 text-center text-slate-500">Iniciando Firebase...</div>;

            useEffect(() => {
                const handleError = (e) => {
                    console.error("React Error:", e);
                    setError(e.message || "Error desconocido");
                };
                window.addEventListener('error', handleError);
                return () => window.removeEventListener('error', handleError);
            }, []);

            if (error) {
                return (
                    <div className="p-8 text-center">
                        <h1 className="text-xl font-bold text-red-600 mb-4">Algo ha salido mal</h1>
                        <pre className="p-4 bg-slate-100 rounded-lg text-xs overflow-auto mb-4">{error}</pre>
                        <button onClick={() => window.location.reload()} className="bg-slate-800 text-white px-4 py-2 rounded-lg font-bold">Recargar aplicación</button>
                    </div>
                );
            }

            useEffect(() => {
                if (!user) {
                    setTeams([]);
                    return;
                }
                const teamsRef = collection(db, 'teams');
                const q = query(teamsRef, where("ownerId", "==", user.uid));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const teamsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTeams(teamsData);
                });
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (!user) {
                    setMatches([]);
                    return;
                }
                const matchesRef = collection(db, 'matches');
                const q = query(matchesRef, where("ownerId", "==", user.uid));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const matchesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMatches(matchesData);
                });
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (!user) {
                    setSubscription(null);
                    return;
                }
                setSubscription(undefined); // Reset state to loading when user changes to avoid flicker
                const subRef = collection(db, 'customers', user.uid, 'subscriptions');
                const q = query(subRef, where("status", "in", ["active", "trialing"]));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) setSubscription(null);
                    else setSubscription(snapshot.docs[0].data().status);
                });
                return () => unsubscribe();
            }, [user]);

            const startCheckout = async () => {
                setCheckoutLoading(true);
                try {
                    const checkoutRef = collection(db, 'customers', user.uid, 'checkout_sessions');
                    const docRef = await addDoc(checkoutRef, {
                        price: 'price_1T0gwQKPQKkc3mVNhH05plnK', // ID real del producto del usuario
                        success_url: window.location.href,
                        cancel_url: window.location.href,
                    });

                    onSnapshot(docRef, (snap) => {
                        const { url, error } = snap.data();
                        if (url) window.location.assign(url);
                        if (error) {
                            setCheckoutLoading(false);
                            alert(`Error de Stripe: ${error.message}`);
                        }
                    });
                } catch (err) {
                    setCheckoutLoading(false);
                    alert(err.message);
                }
            };

            const getSelectedTeam = () => teams.find(t => t.id === selectedTeamId);
            const getActiveMatch = () => matches.find(m => m.id === activeMatchId);

            const updateTeamInDb = async (teamId, updates) => {
                const teamRef = doc(db, 'teams', teamId);
                await updateDoc(teamRef, updates);
            };

            const updateMatchInDb = async (matchId, updates) => {
                const matchRef = doc(db, 'matches', matchId);
                await updateDoc(matchRef, updates);
            };

            if (authLoading || (user && subscription === undefined)) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50">
                    <div className="flex flex-col items-center gap-4">
                        <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-slate-400 text-xs font-bold uppercase tracking-widest animate-pulse">Cargando perfil...</p>
                    </div>
                </div>
            );

            if (!user) return <AuthView />;

            return (
                <div className="min-h-screen flex flex-col">
                    <div className="flex-grow">
                        {view === 'teams-list' && <TeamsListView teams={teams} setView={setView} setSelectedTeamId={setSelectedTeamId} addDoc={addDoc} collection={collection} db={db} deleteDoc={deleteDoc} doc={doc} subscription={subscription} startCheckout={startCheckout} />}
                        {view === 'team-detail' && <TeamDetailView team={getSelectedTeam()} matches={matches} setView={setView} setActiveMatchId={setActiveMatchId} updateTeamInDb={updateTeamInDb} getRoles={getRoles} />}
                        {view === 'match-setup' && <MatchSetupView team={getSelectedTeam()} setView={setView} setActiveMatchId={setActiveMatchId} addDoc={addDoc} collection={collection} db={db} />}
                        {view === 'active-match' && <ActiveMatchView match={getActiveMatch()} teams={teams} updateMatchInDb={updateMatchInDb} setView={setView} setActiveMatchId={setActiveMatchId} getRoles={getRoles} />}
                        {view === 'manage-players' && <ManagePlayersView team={getSelectedTeam()} setView={setView} updateTeamInDb={updateTeamInDb} getRoles={getRoles} />}
                        {view === 'manage-roles' && <ManageRolesView team={getSelectedTeam()} setView={setView} updateTeamInDb={updateTeamInDb} getRoles={getRoles} />}
                    </div>
                    <footer className="p-4 text-center mt-auto">
                        <span className="text-[10px] font-bold text-slate-300 uppercase tracking-widest">v{APP_VERSION}</span>
                    </footer>

                    {checkoutLoading && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-6 text-center">
                            <div className="bg-white rounded-3xl p-8 max-w-xs w-full shadow-2xl animate-in fade-in zoom-in duration-300">
                                <div className="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">Preparando pago</h3>
                                <p className="text-slate-500 text-sm">Te estamos redirigiendo a la pasarela segura de Stripe...</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registrado', reg))
                    .catch(err => console.log('Error SW', err));
            });
        }
    </script>
</body>

</html>