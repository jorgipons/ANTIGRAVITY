<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Equipo Baloncesto - Pasarela (Cloud)</title>

    <!-- Dependencies -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query, orderBy, where, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAAbaUEbPjltfQrDethVojxoxD1gj4AC0w",
            authDomain: "basketmanager-ed370.firebaseapp.com",
            projectId: "basketmanager-ed370",
            storageBucket: "basketmanager-ed370.firebasestorage.app",
            messagingSenderId: "177594386006",
            appId: "1:177594386006:web:8eef1b258c8dc6b395ddf7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Enable Offline Persistence
        enableIndexedDbPersistence(db)
            .catch((err) => {
                if (err.code == 'failed-precondition') {
                    console.warn('Persistence failed: Multiple tabs open');
                } else if (err.code == 'unimplemented') {
                    console.warn('Persistence not supported by browser');
                }
            });

        // Expose DB and Auth to window for React component to use
        window.db = db;
        window.auth = auth;
        window.firebaseMethods = {
            collection, addDoc, onSnapshot, updateDoc, doc, deleteDoc, query, orderBy, where,
            signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged,
            GoogleAuthProvider, signInWithPopup
        };
    </script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            touch-action: manipulation;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Logic & Types ---
        const APP_VERSION = '1.11.4';
        const RULESETS = {
            'fbcv_8p': {
                id: 'fbcv_8p',
                name: 'FBCV 8 periodos',
                totalPeriods: 8,
                checkPeriod: 6,
                minPlay: 2,
                minRest: 2,
                maxPlay: 4
            },
            'fbcv_6p': {
                id: 'fbcv_6p',
                name: 'FBCV 6 periodos',
                totalPeriods: 6,
                checkPeriod: 5,
                minPlay: 2,
                minRest: 2,
                maxPlay: 3
            }
        };
        const DEFAULT_RULESET = 'fbcv_8p';
        const DEFAULT_ROLES = {
            'receptor': { label: 'Receptor', order: 1, color: 'text-blue-600', bg: 'bg-blue-50' },
            'medio': { label: 'Medio', order: 2, color: 'text-green-600', bg: 'bg-green-50' },
            'largo': { label: 'Largo', order: 3, color: 'text-purple-600', bg: 'bg-purple-50' },
            'sacador': { label: 'Sacador', order: 4, color: 'text-orange-600', bg: 'bg-orange-50' }
        };

        const getRoles = (team) => team?.roles || DEFAULT_ROLES;

        const COLORS = [
            { id: 'blue', label: 'Azul', text: 'text-blue-600', bg: 'bg-blue-50' },
            { id: 'green', label: 'Verde', text: 'text-green-600', bg: 'bg-green-50' },
            { id: 'purple', label: 'Violeta', text: 'text-purple-600', bg: 'bg-purple-50' },
            { id: 'orange', label: 'Naranja', text: 'text-orange-600', bg: 'bg-orange-50' },
            { id: 'red', label: 'Rojo', text: 'text-red-600', bg: 'bg-red-50' },
            { id: 'pink', label: 'Rosa', text: 'text-pink-600', bg: 'bg-pink-50' },
            { id: 'yellow', label: 'Amarillo', text: 'text-yellow-600', bg: 'bg-yellow-50' },
            { id: 'slate', label: 'Gris', text: 'text-slate-600', bg: 'bg-slate-50' },
            { id: 'cyan', label: 'Cian', text: 'text-cyan-600', bg: 'bg-cyan-50' },
        ];

        const updateTeamInDb = async (teamId, updates) => {
            const { updateDoc, doc } = window.firebaseMethods;
            const db = window.db;
            const teamRef = doc(db, "teams", teamId);
            await updateDoc(teamRef, updates);
        };

        const generateConvocatoria = (match, team, lang = 'val') => {
            const date = new Date(match.date);
            const daysVAL = ['Diumenge', 'Dilluns', 'Dimarts', 'Dimecres', 'Dijous', 'Divendres', 'Dissabte'];
            const daysCAS = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            const dayName = lang === 'val' ? daysVAL[date.getDay()] : daysCAS[date.getDay()];

            const rival = match.opponent;
            const teamName = team.name;
            const horaIni = match.time;
            const horaConvo = match.callTime || '---';
            const location = match.location || (match.isHome ? (lang === 'val' ? 'Local' : 'Local') : (lang === 'val' ? 'Visitant' : 'Visitante'));

            const transportIcon = match.transportType === 'bus' ? '🚌' : '🚗';
            const departurePart = (!match.isHome && match.departureTime)
                ? `\n${transportIcon}  ${match.departureTime}h (Eixida: ${match.departureLocation || 'Pavelló'})`
                : '';
            const departurePartCas = (!match.isHome && match.departureTime)
                ? `\n${transportIcon}  ${match.departureTime}h (Salida: ${match.departureLocation || 'Pabellón'})`
                : '';
            const arrivalPart = (!match.isHome && match.arrivalTime)
                ? `\n🏁  ${match.arrivalTime}h (Tornada aprox.)`
                : '';
            const arrivalPartCas = (!match.isHome && match.arrivalTime)
                ? `\n🏁  ${match.arrivalTime}h (Vuelta aprox.)`
                : '';

            if (lang === 'val') {
                return `Bon dia, aquesta és la convocatòria per al pròxim partit:\n\n` +
                    `⚠ IMPORTANT! ⚠\n` +
                    `Avisar perfavor si algú no pot vindre per planificar quant abans millor.\n\n` +
                    `👕  ${teamName} vs ${rival}\n` +
                    `📍  ${location}\n` +
                    `🗓  ${dayName}\n` +
                    (match.isHome ? '' : `${departurePart}${arrivalPart}\n`) +
                    `🤝  ${horaConvo}h (Convocatòria)\n` +
                    `🏀  ${horaIni}h (Inici partit)`;
            } else {
                return `Buenos días, esta es la convocatoria para el próximo partido:\n\n` +
                    `⚠ ¡IMPORTANTE! ⚠\n` +
                    `Avisad por favor si alguien no puede venir para planificar cuanto antes mejor.\n\n` +
                    `👕  ${teamName} vs ${rival}\n` +
                    `📍  ${location}\n` +
                    `🗓  ${dayName}\n` +
                    (!match.isHome ? `${departurePartCas}${arrivalPartCas}\n` : '') +
                    `🤝  ${horaConvo}h (Convocatoria)\n` +
                    `🏀  ${horaIni}h (Inicio partido)`;
            }
        };

        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                alert('¡Convocatoria copiada al portapapeles!');
            }).catch(err => {
                console.error('Error al copiar:', err);
                alert('Error al copiar al portapapeles');
            });
        };

        // Helper to properly decode Base64 as UTF-8
        const decodeBase64UTF8 = (str) => {
            try {
                const binaryString = atob(str);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return new TextDecoder('utf-8').decode(bytes);
            } catch (e) {
                console.error("Base64 decode error:", e);
                return atob(str); // Fallback
            }
        };

        const syncWithFederation = async (federationId) => {
            if (!navigator.onLine) {
                return { success: false, error: 'No tienes conexión a internet. Inténtalo más tarde.' };
            }
            try {
                console.log('🔄 Syncing with federation ID:', federationId);
                const url = `https://esb.optimalwayconsulting.com/fbcv/1/btz38ZsZlAdaODiH2fGsnJC9mZgSNPeR/FCBQWeb/getTeamCard/${federationId}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error('Error al conectar con la federación');
                }

                const base64Data = await response.text();
                console.log('📦 Received base64 data, length:', base64Data.length);

                const jsonData = JSON.parse(decodeBase64UTF8(base64Data));
                console.log('📊 Parsed JSON:', jsonData);

                if (jsonData.result !== 'OK') {
                    throw new Error(jsonData.message || 'Error en la respuesta de la federación');
                }

                const teamData = jsonData.messageData.team;
                const groups = teamData.groups || [];
                console.log('👥 Groups found:', groups.length);

                // Buscar la clasificación del equipo en sus grupos
                let myStanding = null;
                for (const group of groups) {
                    const standings = group.standing || [];
                    console.log('🔍 Searching in group, standings:', standings.length);
                    // Convertir ambos a string para comparación segura
                    const found = standings.find(s => String(s.idTeam) === String(federationId));
                    if (found) {
                        myStanding = found;
                        console.log('✅ Found standing:', myStanding);
                        break;
                    }
                }

                if (!myStanding) {
                    console.warn('⚠️ Standing not found for team ID:', federationId);
                }

                const result = {
                    success: true,
                    data: {
                        clubName: teamData.entityName || null,
                        teamName: teamData.name || null,
                        category: teamData.categoriesRegisteredName || teamData.categoryName || null,
                        logo: teamData.entityLogo || null,
                        field: {
                            name: teamData.fieldName || null,
                            address: teamData.fieldAddress || null,
                            town: teamData.fieldTown || null
                        },
                        standing: myStanding ? {
                            position: parseInt(myStanding.position) || 0,
                            points: parseInt(myStanding.standingScore) || 0,
                            wins: parseInt(myStanding.matchWin) || 0,
                            losses: parseInt(myStanding.matchLost) || 0,
                            played: parseInt(myStanding.matchPlayed) || 0,
                            scoreFavour: parseInt(myStanding.matchScoreFavour) || 0,
                            scoreAgainst: parseInt(myStanding.matchScoreAgainst) || 0
                        } : null,
                        lastSync: new Date().toISOString()
                    }
                };

                console.log('✅ Sync result:', result);
                return result;
            } catch (error) {
                console.error('❌ Error syncing with federation:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        };

        const importFederationMatches = async (federationId, mode = 'smart') => {
            if (!navigator.onLine) {
                alert('No tienes conexión a internet. No se pueden importar partidos.');
                return;
            }
            try {
                console.log(`📥 Importing matches (${mode}) for federation ID:`, federationId);
                const url = `https://esb.optimalwayconsulting.com/fbcv/1/btz38ZsZlAdaODiH2fGsnJC9mZgSNPeR/FCBQWeb/getTeamCard/${federationId}`;
                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error('Error al conectar con la federación');
                }

                const base64Data = await response.text();
                const jsonData = JSON.parse(decodeBase64UTF8(base64Data));

                if (jsonData.result !== 'OK') {
                    throw new Error(jsonData.message || 'Error en la respuesta de la federación');
                }

                const teamData = jsonData.messageData.team;
                const groups = teamData.groups || [];
                console.log('📅 Found groups for team:', groups.length);

                const matchesToImport = [];

                for (const group of groups) {
                    const idGroup = group.idGroup;
                    if (!idGroup) continue;

                    console.log(`🔗 Checking group ${idGroup} (${group.nameGroup || '?'})...`);

                    try {
                        // Primero obtenemos info básica del grupo para saber jornadas
                        const resultsBaseUrl = `https://esb.optimalwayconsulting.com/fbcv/1/btz38ZsZlAdaODiH2fGsnJC9mZgSNPeR/FCBQWeb/resultats/${idGroup}`;
                        const resultsResponse = await fetch(resultsBaseUrl);
                        if (!resultsResponse.ok) continue;

                        const resultsBase64 = await resultsResponse.text();
                        const resultsData = JSON.parse(decodeBase64UTF8(resultsBase64));

                        if (resultsData.result !== 'OK') continue;

                        const totalRounds = parseInt(resultsData.messageData.totalRounds || 0);
                        const lastRound = parseInt(resultsData.messageData.lastRound || 0);

                        let roundsToFetch = [];
                        if (mode === 'total') {
                            for (let i = 1; i <= totalRounds; i++) roundsToFetch.push(i);
                        } else if (mode === 'next') {
                            if (lastRound < totalRounds) roundsToFetch.push(lastRound + 1);
                            else roundsToFetch.push(lastRound); // Si ya terminó, la última
                        } else { // smart: actual + próxima
                            roundsToFetch.push(lastRound);
                            if (lastRound < totalRounds) roundsToFetch.push(lastRound + 1);
                        }

                        console.log(`🏀 Group ${idGroup}: Fetching rounds: ${roundsToFetch.join(', ')}`);

                        for (const roundNum of roundsToFetch) {
                            try {
                                const roundUrl = `${resultsBaseUrl}/${roundNum}`;
                                const roundResponse = await fetch(roundUrl);
                                if (!roundResponse.ok) continue;

                                const roundBase64 = await roundResponse.text();
                                const roundData = JSON.parse(decodeBase64UTF8(roundBase64));

                                if (roundData.result !== 'OK') continue;

                                const rounds = roundData.messageData.rounds || {};
                                const roundInfo = rounds[roundNum] || {};
                                const matches = roundInfo.matches || {};

                                for (const matchId in matches) {
                                    const match = matches[matchId];
                                    const localId = match.idLocalTeam;
                                    const visitorId = match.idVisitorTeam;

                                    // Verificar si nuestro equipo participa en este partido
                                    if (String(localId) !== String(federationId) && String(visitorId) !== String(federationId)) continue;

                                    const isHome = String(localId) === String(federationId);
                                    const opponent = isHome
                                        ? (match.nameVisitorTeam || match.visitorTeam?.name || 'Rival')
                                        : (match.nameLocalTeam || match.localTeam?.name || 'Rival');

                                    let matchDate = '';
                                    let matchTime = '';
                                    if (match.matchDay) {
                                        const parts = match.matchDay.split(' ');
                                        let rawDate = parts[0];
                                        // Normalize DD/MM/YYYY to YYYY-MM-DD
                                        if (rawDate.includes('/')) {
                                            const [d, m, y] = rawDate.split('/');
                                            matchDate = `${y}-${m}-${d}`;
                                        } else {
                                            matchDate = rawDate;
                                        }

                                        if (parts[1]) {
                                            matchTime = parts[1].substring(0, 5); // HH:mm
                                        }
                                    }

                                    const matchDateTime = new Date(match.matchDay?.replace(' ', 'T') || `${matchDate}T${matchTime || '00:00'}:00`);
                                    const isPast = matchDateTime < new Date();

                                    let score = null;
                                    let result = null;

                                    if (match.localScore !== null && match.visitorScore !== null &&
                                        match.localScore !== undefined && match.visitorScore !== undefined &&
                                        match.localScore !== '' && match.visitorScore !== '') {
                                        const lScore = parseInt(match.localScore);
                                        const vScore = parseInt(match.visitorScore);
                                        score = { local: lScore, visitor: vScore };
                                        const ourScore = isHome ? lScore : vScore;
                                        const theirScore = isHome ? vScore : lScore;
                                        if (ourScore > theirScore) result = 'won';
                                        else if (ourScore < theirScore) result = 'lost';
                                        else result = 'draw';
                                    }

                                    // Calculate One Hour Before for Call Time (if Home)
                                    let callTime = '';
                                    if (matchTime && isHome) {
                                        const [h, m] = matchTime.split(':').map(Number);
                                        let callH = h - 1;
                                        if (callH < 0) callH += 24; // Handle midnight edge case just in case
                                        callTime = `${String(callH).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
                                    }

                                    matchesToImport.push({
                                        opponent: opponent,
                                        date: matchDate,
                                        time: matchTime,
                                        callTime: callTime,
                                        location: match.nameField || match.fieldName || '',
                                        matchDay: match.numMatchDay || roundNum || '',
                                        isHome: isHome,
                                        state: (isPast && score) ? 'finished' : 'pending',
                                        score: score,
                                        result: result,
                                        federationMatchId: String(match.idMatch || matchId),
                                        observations: match.observations || ''
                                    });
                                }
                            } catch (e) {
                                console.warn(`⚠️ Error fetching round ${roundNum}:`, e);
                            }
                        }
                    } catch (err) {
                        console.warn(`⚠️ Error processing group ${idGroup}:`, err);
                    }
                }

                console.log(`✅ Prepared ${matchesToImport.length} matches for import`);
                return {
                    success: true,
                    matches: matchesToImport
                };
            } catch (error) {
                console.error('❌ Error importing matches:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        };

        const TopBar = ({ navigate, view, signOut, subscription, isOnline, startTutorial }) => {
            const handleLogout = async () => {
                if (confirm('¿Cerrar sesión?')) {
                    await signOut(window.auth);
                    navigate('teams-list');
                }
            };

            useEffect(() => {
                lucide.createIcons();
            }, [isOnline]); // Re-render icons when online status changes

            return (
                <div className="sticky top-0 z-50 bg-white border-b border-slate-200 shadow-sm">
                    {!isOnline && (
                        <div className="bg-slate-800 text-white text-[10px] font-bold text-center py-1 flex items-center justify-center gap-1.5 animate-in slide-in-from-top">
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="wifi-off" class="w-3 h-3"></i>' }}></span>
                            MODO SIN CONEXIÓN
                        </div>
                    )}
                    <div className="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
                        {/* Left - Premium badge */}
                        <div className="w-10">
                            {subscription === 'active' || subscription === 'trialing' ? (
                                <span className="text-amber-500" title="Premium">
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="crown" class="w-5 h-5"></i>' }}></span>
                                </span>
                            ) : null}
                        </div>

                        {/* Center - Home button */}
                        <button
                            onClick={() => navigate('teams-list')}
                            className={`p-2 rounded-lg transition-all ${view === 'teams-list' ? 'bg-blue-100 text-blue-600' : 'text-slate-400 hover:text-slate-800 hover:bg-slate-100'}`}
                            title="Inicio"
                        >
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="home" class="w-5 h-5"></i>' }}></span>
                        </button>

                        {/* Right - Help button */}
                        <button
                            id="help-btn"
                            onClick={startTutorial}
                            className="p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-all mr-1"
                            title="Ayuda / Tutorial"
                        >
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="circle-help" class="w-5 h-5"></i>' }}></span>
                        </button>

                        {/* Right - Logout button */}
                        <button
                            onClick={handleLogout}
                            className="p-2 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all"
                            title="Cerrar sesión"
                        >
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="log-out" class="w-5 h-5"></i>' }}></span>
                        </button>
                    </div>
                </div>
            );
        };

        const CalendarView = ({ team, matches, navigate }) => {
            const [viewMode, setViewMode] = useState('month'); // 'month', 'week', 'day'
            const [currentDate, setCurrentDate] = useState(new Date());

            useEffect(() => {
                lucide.createIcons();
            }, [viewMode, currentDate]);

            if (!team) return <div className="p-4">Error: Equipo no encontrado. <button onClick={() => navigate('teams-list')}>Volver</button></div>;

            const teamMatches = matches.filter(m => m.teamId === team.id);

            // Helper functions for date manipulation
            const getMonthDays = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const dayOfWeek = firstDay.getDay();
                // Convert Sunday (0) to 6, Monday (1) to 0, etc.
                const startingDayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;

                const days = [];
                // Add empty cells for days before month starts
                for (let i = 0; i < startingDayOfWeek; i++) {
                    days.push(null);
                }
                // Add all days of the month
                for (let day = 1; day <= daysInMonth; day++) {
                    days.push(new Date(year, month, day));
                }
                return days;
            };

            const getWeekDays = (date) => {
                const dayOfWeek = date.getDay();
                const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // adjust when day is sunday
                const monday = new Date(date.setDate(diff));
                const days = [];
                for (let i = 0; i < 7; i++) {
                    const day = new Date(monday);
                    day.setDate(monday.getDate() + i);
                    days.push(day);
                }
                return days;
            };

            const getMatchesForDate = (date) => {
                if (!date) return [];
                // Use local date format to avoid timezone issues
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                return teamMatches.filter(m => m.date === dateStr);
            };

            const formatMonthYear = (date) => {
                const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                return `${months[date.getMonth()]} ${date.getFullYear()} `;
            };

            const formatWeekRange = (days) => {
                const first = days[0];
                const last = days[6];
                return `${first.getDate()} - ${last.getDate()} ${formatMonthYear(first)} `;
            };

            const formatDayDate = (date) => {
                const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                return `${days[date.getDay()]}, ${date.getDate()} de ${formatMonthYear(date)} `;
            };

            const goToToday = () => setCurrentDate(new Date());
            const goToPrevious = () => {
                const newDate = new Date(currentDate);
                if (viewMode === 'month') newDate.setMonth(newDate.getMonth() - 1);
                else if (viewMode === 'week') newDate.setDate(newDate.getDate() - 7);
                else newDate.setDate(newDate.getDate() - 1);
                setCurrentDate(newDate);
            };
            const goToNext = () => {
                const newDate = new Date(currentDate);
                if (viewMode === 'month') newDate.setMonth(newDate.getMonth() + 1);
                else if (viewMode === 'week') newDate.setDate(newDate.getDate() + 7);
                else newDate.setDate(newDate.getDate() + 1);
                setCurrentDate(newDate);
            };

            const MatchCard = ({ match, compact = false }) => (
                <div
                    onClick={() => navigate('active-match', team.id, match.id)}
                    className={`${compact ? 'p-1.5' : 'p-2'} bg-white border-l-4 ${match.isHome ? 'border-blue-500' : 'border-orange-500'} rounded shadow-sm hover:shadow-md transition-all cursor-pointer group`}
                >
                    <p className={`${compact ? 'text-[10px]' : 'text-xs'} font-bold text-slate-800 truncate group-hover:text-blue-600`}>
                        {compact ? match.opponent : `vs ${match.opponent}`}
                    </p>
                    {!compact && (
                        <p className="text-[9px] text-slate-500 mt-0.5">
                            {match.time}h {match.isHome ? '🏠' : '✈️'}
                        </p>
                    )}
                </div>
            );

            return (
                <div className="p-4 max-w-4xl mx-auto pb-24">
                    <header className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigate('team-detail', team.id)} className="p-2 -ml-2 text-slate-400 hover:text-slate-800 transition-colors">
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span>
                        </button>
                        <h1 className="text-2xl font-bold text-slate-800">Calendario</h1>
                    </header>

                    {/* View Mode Selector */}
                    <div className="flex bg-slate-100 p-1 rounded-xl mb-4">
                        <button onClick={() => setViewMode('month')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${viewMode === 'month' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>MES</button>
                        <button onClick={() => setViewMode('week')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${viewMode === 'week' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>SEMANA</button>
                        <button onClick={() => setViewMode('day')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${viewMode === 'day' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>DÍA</button>
                    </div>

                    {/* Navigation Controls */}
                    <div className="flex items-center justify-between mb-6 bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                        <button onClick={goToPrevious} className="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left" class="w-5 h-5"></i>' }}></span>
                        </button>
                        <div className="text-center">
                            <p className="font-bold text-slate-800">
                                {viewMode === 'month' && formatMonthYear(currentDate)}
                                {viewMode === 'week' && formatWeekRange(getWeekDays(currentDate))}
                                {viewMode === 'day' && formatDayDate(currentDate)}
                            </p>
                            <button onClick={goToToday} className="text-[10px] text-blue-600 font-bold hover:underline mt-0.5">Hoy</button>
                        </div>
                        <button onClick={goToNext} className="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-right" class="w-5 h-5"></i>' }}></span>
                        </button>
                    </div>

                    {/* Month View */}
                    {viewMode === 'month' && (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="grid grid-cols-7 bg-slate-50 border-b border-slate-200">
                                {['L', 'M', 'X', 'J', 'V', 'S', 'D'].map((day, i) => (
                                    <div key={i} className="p-2 text-center text-[10px] font-bold text-slate-600">{day}</div>
                                ))}
                            </div>
                            <div className="grid grid-cols-7">
                                {getMonthDays(currentDate).map((day, i) => {
                                    const dayMatches = day ? getMatchesForDate(day) : [];
                                    const isToday = day && day.toDateString() === new Date().toDateString();
                                    return (
                                        <div key={i} className={`min-h-[80px] p-1.5 border-b border-r border-slate-100 ${!day ? 'bg-slate-50' : ''} ${isToday ? 'bg-blue-50' : ''}`}>
                                            {day && (
                                                <>
                                                    <p className={`text-xs font-bold mb-1 ${isToday ? 'text-blue-600' : 'text-slate-700'}`}>{day.getDate()}</p>
                                                    <div className="space-y-1">
                                                        {dayMatches.map(m => <MatchCard key={m.id} match={m} compact={true} />)}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Week View */}
                    {viewMode === 'week' && (
                        <div className="space-y-2">
                            {getWeekDays(currentDate).map((day, i) => {
                                const dayMatches = getMatchesForDate(day);
                                const isToday = day.toDateString() === new Date().toDateString();
                                const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
                                return (
                                    <div key={i} className={`bg-white p-3 rounded-xl border border-slate-200 shadow-sm ${isToday ? 'ring-2 ring-blue-500' : ''}`}>
                                        <div className="flex items-center justify-between mb-2">
                                            <div>
                                                <p className={`font-bold ${isToday ? 'text-blue-600' : 'text-slate-800'}`}>{dayNames[day.getDay()]}</p>
                                                <p className="text-xs text-slate-500">{day.getDate()} {formatMonthYear(day).split(' ')[0]}</p>
                                            </div>
                                            {isToday && <span className="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">HOY</span>}
                                        </div>
                                        {dayMatches.length > 0 ? (
                                            <div className="space-y-2">
                                                {dayMatches.map(m => <MatchCard key={m.id} match={m} />)}
                                            </div>
                                        ) : (
                                            <p className="text-xs text-slate-400 italic">Sin partidos</p>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {/* Day View */}
                    {viewMode === 'day' && (
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            {(() => {
                                const dayMatches = getMatchesForDate(currentDate);
                                return dayMatches.length > 0 ? (
                                    <div className="space-y-3">
                                        {dayMatches.map(m => (
                                            <div key={m.id} onClick={() => navigate('active-match', team.id, m.id)} className="p-4 bg-slate-50 rounded-lg border border-slate-200 hover:border-blue-300 hover:shadow-md transition-all cursor-pointer group">
                                                <div className="flex items-start justify-between mb-2">
                                                    <div>
                                                        <p className="font-bold text-lg text-slate-800 group-hover:text-blue-600">vs {m.opponent}</p>
                                                        <p className="text-xs text-slate-500 mt-1">{m.matchDay || 'Sin jornada'}</p>
                                                    </div>
                                                    <span className={`text-xs px-2 py-1 rounded-full font-bold ${m.isHome ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'}`}>
                                                        {m.isHome ? '🏠 Local' : '✈️ Visitante'}
                                                    </span>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2 text-xs text-slate-600">
                                                    <div className="flex items-center gap-1">
                                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="clock" class="w-3.5 h-3.5"></i>' }}></span>
                                                        <span>{m.time}h</span>
                                                    </div>
                                                    {m.location && (
                                                        <div className="flex items-center gap-1">
                                                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="map-pin" class="w-3.5 h-3.5"></i>' }}></span>
                                                            <span>{m.location}</span>
                                                        </div>
                                                    )}
                                                </div>
                                                {m.state === 'finished' && m.score && (
                                                    <div className="mt-3 pt-3 border-t border-slate-200">
                                                        <p className="text-sm font-bold text-slate-700">
                                                            Resultado: <span className={m.result === 'won' ? 'text-green-600' : 'text-red-500'}>{m.score.local} - {m.score.visitor}</span>
                                                        </p>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <div className="text-center py-12">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="calendar-x" class="w-12 h-12 text-slate-200 mx-auto mb-3"></i>' }}></span>
                                        <p className="text-slate-400 font-medium">No hay partidos programados para este día</p>
                                    </div>
                                );
                            })()}
                        </div>
                    )}
                </div>
            );
        };

        const TeamDetailView = ({ team, matches, navigate, updateTeamInDb, getRoles, addDoc, collection, db }) => {
            const [newPlayerName, setNewPlayerName] = useState('');
            const [newPlayerNumber, setNewPlayerNumber] = useState('');
            const [syncing, setSyncing] = useState(false);
            const [showSyncMenu, setShowSyncMenu] = useState(false);

            const handleSyncFederation = async (silent = false) => {
                if (!team.federationId) return;
                setSyncing(true);
                try {
                    const result = await syncWithFederation(team.federationId);
                    if (result.success) {
                        await updateTeamInDb(team.id, { federationData: result.data });
                        if (!silent) alert('✅ Sincronización completada');
                    } else {
                        if (!silent) alert(`❌ Error: ${result.error} `);
                        console.error("Auto-sync error:", result.error);
                    }
                } catch (error) {
                    console.error('❌ Unexpected error in handleSyncFederation:', error);
                    if (!silent) alert(`❌ Error inesperado: ${error.message} `);
                } finally {
                    setSyncing(false);
                }
            };

            const [importing, setImporting] = useState(false);

            const handleImportMatches = async (mode = 'smart') => {
                if (!team.federationId) return;

                const modeLabels = {
                    'smart': 'Actual + Próxima',
                    'total': 'Temporada completa',
                    'next': 'Solo siguiente'
                };

                if (!confirm(`¿Sincronizar partidos (${modeLabels[mode] || mode})? Se crearán partidos nuevos y se actualizarán marcadores.`)) return;

                setImporting(true);
                try {
                    const result = await importFederationMatches(team.federationId, mode);
                    if (result.success) {
                        const matchesToImport = result.matches;

                        // Partidos que ya existen en nuestra DB para este equipo
                        const existingMatches = matches.filter(m => m.teamId === team.id);

                        let imported = 0;
                        let updated = 0;

                        for (const federatedMatch of matchesToImport) {
                            const existing = existingMatches.find(m => m.federationMatchId === federatedMatch.federationMatchId);

                            if (!existing) {
                                // Es un partido nuevo
                                await addDoc(collection(db, 'matches'), {
                                    ...federatedMatch,
                                    teamId: team.id,
                                    ownerId: window.auth.currentUser.uid,
                                    createdAt: new Date().toISOString()
                                });
                                imported++;
                            } else if (federatedMatch.state === 'finished' && federatedMatch.score) {
                                // Existe. ¿Actualizamos el marcador si ha terminado?
                                const hasScoreChanged = !existing.score ||
                                    existing.score.local !== federatedMatch.score.local ||
                                    existing.score.visitor !== federatedMatch.score.visitor;

                                if (hasScoreChanged || existing.state === 'pending') {
                                    const matchRef = doc(db, 'matches', existing.id);
                                    await updateDoc(matchRef, {
                                        score: federatedMatch.score,
                                        result: federatedMatch.result,
                                        state: 'finished'
                                    });
                                    updated++;
                                }
                            }
                        }

                        alert(`✅ Proceso completado\n\n${imported} partidos nuevos importados\n${updated} marcadores actualizados`);
                    } else {
                        alert(`❌ Error: ${result.error} `);
                    }
                } catch (error) {
                    console.error('❌ Unexpected error in handleImportMatches:', error);
                    alert(`❌ Error inesperado: ${error.message} `);
                } finally {
                    setImporting(false);
                    setShowSyncMenu(false);
                }
            };

            // Sorting matches: Date Descending (Newest/Future first)
            const getSortedMatches = (teamMatches) => {
                return teamMatches.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return dateB - dateA; // Descending
                });
            };

            // Removed old name editing logic
            useEffect(() => {
                lucide.createIcons();
            }, [team, matches]);

            // Auto-Sync Federation Data (15 min cooldown)
            useEffect(() => {
                const autoSync = async () => {
                    if (!team?.federationId) return;

                    const lastSync = team.federationData?.lastSync;
                    const now = Date.now();
                    const COOLDOWN = 24 * 60 * 60 * 1000; // 24 hours

                    const needsSync = !lastSync || (now - new Date(lastSync).getTime() > COOLDOWN);

                    if (needsSync) {
                        console.log("🔄 Auto-syncing federation data (expired or missing)...");
                        // We silence the alert for auto-sync by passing a flag if we wanted, 
                        // but handleSyncFederation currently alerts. 
                        // Let's modify handleSyncFederation to accept 'silent' param.
                        await handleSyncFederation(true);
                    }
                };
                autoSync();
            }, [team?.id]);

            const players = team?.players || [];

            const addPlayer = async (e) => {
                e.preventDefault();
                if (!newPlayerName.trim() || !newPlayerNumber.trim()) return;
                const newPlayer = {
                    id: Date.now().toString(),
                    name: newPlayerName.trim(),
                    number: newPlayerNumber.trim(),
                    role: 'receptor'
                };
                const updatedPlayers = [...players, newPlayer];
                await updateTeamInDb(team.id, { players: updatedPlayers });
                setNewPlayerName('');
                setNewPlayerNumber('');
            };

            const deletePlayer = async (teamId, playerId) => {
                if (!confirm('¿Seguro que quieres eliminar este jugador?')) return;
                const updatedPlayers = players.filter(p => p.id !== playerId);
                await updateTeamInDb(teamId, { players: updatedPlayers });
            };

            const updatePlayerRole = async (playerId, newRole) => {
                const updatedPlayers = players.map(p => p.id === playerId ? { ...p, role: newRole } : p);
                await updateTeamInDb(team.id, { players: updatedPlayers });
            };

            const roles = getRoles(team);

            if (!team) return <div className="p-4">Error: Equipo no encontrado. <button onClick={() => navigate('teams-list')}>Volver</button></div>;

            const teamMatches = matches.filter(m => m.teamId === team.id);

            return (
                <div className="p-4 max-w-md mx-auto pb-24">
                    <header className="flex items-center justify-between mb-6">
                        <div className="flex items-center gap-2 flex-1">
                            <button onClick={() => navigate('teams-list')} className="p-2 -ml-2 text-slate-400 hover:text-slate-800 transition-colors"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span></button>
                            <h1 className="text-2xl font-bold text-slate-800">{team.name}</h1>
                        </div>
                        <button onClick={() => navigate('team-settings', team.id)} className="p-2 text-slate-400 hover:text-slate-800 transition-colors">
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="settings" class="w-6 h-6"></i>' }}></span>
                        </button>
                    </header>

                    {team.federationId && (
                        <div className="mb-6 bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100 shadow-sm">
                            <div className="flex items-center justify-between mb-3">
                                <div className="flex items-center gap-2">
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="link" class="w-4 h-4 text-blue-600"></i>' }}></span>
                                    <h3 className="font-bold text-blue-900 text-sm">Federación FBCV</h3>
                                </div>
                                <div className="flex gap-2 relative">


                                    <div className="flex bg-emerald-600 rounded-lg overflow-hidden shadow-sm">
                                        <button
                                            onClick={() => handleImportMatches('smart')}
                                            disabled={importing}
                                            className={`text-[10px] pl-2.5 pr-1.5 py-1.5 text-white font-bold transition-all flex items-center gap-1.5 border-r border-emerald-500/30 hover:bg-emerald-700 disabled:bg-slate-200 disabled:text-slate-400`}
                                            title="Sincro Actual + Próxima"
                                        >
                                            <span dangerouslySetInnerHTML={{ __html: `<i data-lucide="${importing ? 'loader' : 'zap'}" class="w-3.5 h-3.5 ${importing ? 'animate-spin' : ''}"></i>` }}></span>
                                            {importing ? 'Importando...' : 'Sincro Smart'}
                                        </button>
                                        <button
                                            onClick={() => { setShowSyncMenu(!showSyncMenu); setTimeout(() => lucide.createIcons(), 0); }}
                                            disabled={importing}
                                            className="px-2 py-1.5 text-white hover:bg-emerald-700 transition-all disabled:bg-slate-200 disabled:text-slate-400"
                                        >
                                            <span dangerouslySetInnerHTML={{ __html: `<i data-lucide="chevron-down" class="w-3.5 h-3.5"></i>` }}></span>
                                        </button>
                                    </div>

                                    {showSyncMenu && (
                                        <div className="absolute right-0 top-full mt-2 w-48 bg-white rounded-xl shadow-xl border border-slate-200 overflow-hidden z-[60] animate-in slide-in-from-top-2 duration-150">
                                            <button
                                                onClick={() => handleImportMatches('total')}
                                                className="w-full px-4 py-2.5 text-left text-[11px] font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2 border-b border-slate-50"
                                            >
                                                <span dangerouslySetInnerHTML={{ __html: `<i data-lucide="calendar" class="w-3.5 h-3.5 text-emerald-600"></i>` }}></span>
                                                Temporada Completa
                                            </button>
                                            <button
                                                onClick={() => handleImportMatches('next')}
                                                className="w-full px-4 py-2.5 text-left text-[11px] font-bold text-slate-700 hover:bg-slate-50 flex items-center gap-2"
                                            >
                                                <span dangerouslySetInnerHTML={{ __html: `<i data-lucide="skip-forward" class="w-3.5 h-3.5 text-emerald-600"></i>` }}></span>
                                                Solo Próxima Jornada
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                            {team.federationData ? (
                                <div className="space-y-1.5">
                                    <div className="flex items-center justify-between bg-white/60 p-2 rounded-lg text-[11px]">
                                        <div className="flex items-center gap-1.5">
                                            <span className="text-blue-600 font-bold uppercase tracking-tighter">Posición:</span>
                                            <span className="font-bold text-blue-900 text-sm">{team.federationData.standing?.position}ª</span>
                                        </div>
                                        <div className="flex items-center gap-1.5">
                                            <span className="text-blue-600 font-bold uppercase tracking-tighter">Puntos:</span>
                                            <span className="font-bold text-blue-900 text-sm">{team.federationData.standing?.points}</span>
                                        </div>
                                    </div>
                                    <div className="text-[10px] text-blue-700 bg-white/40 p-2 rounded-lg flex flex-wrap justify-between gap-x-2">
                                        <div className="flex gap-2">
                                            <span><strong>V/D:</strong> {team.federationData.standing?.wins}/{team.federationData.standing?.losses}</span>
                                            <span><strong>PF/PC:</strong> {team.federationData.standing?.scoreFavour}/{team.federationData.standing?.scoreAgainst}</span>
                                        </div>

                                    </div>
                                </div>
                            ) : (
                                <p className="text-xs text-blue-600">Pulsa "Sincronizar" para obtener datos de la federación</p>
                            )}
                        </div>
                    )}

                    {/* Next Match Widget */}
                    {(() => {
                        const nextMatch = teamMatches
                            .filter(m => m.state !== 'finished' && new Date(m.date + 'T' + (m.time || '00:00')) >= new Date())
                            .sort((a, b) => new Date(a.date + 'T' + (a.time || '00:00')) - new Date(b.date + 'T' + (b.time || '00:00')))[0];

                        if (!nextMatch) return null;

                        return (
                            <div onClick={() => navigate('active-match', team.id, nextMatch.id)} className="mb-8 bg-gradient-to-r from-slate-900 to-slate-800 rounded-xl p-0.5 shadow-lg group cursor-pointer active:scale-[0.98] transition-all">
                                <div className="bg-slate-900 rounded-[10px] p-4 relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-3 opacity-10">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="calendar" class="w-24 h-24 text-white"></i>' }}></span>
                                    </div>
                                    <div className="relative z-10">
                                        <h3 className="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-2 flex items-center gap-1.5">
                                            <span className="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>
                                            Próximo Partido
                                        </h3>
                                        <div className="flex items-start justify-between">
                                            <div>
                                                <h2 className="text-xl font-bold text-white mb-1">vs {nextMatch.opponent}</h2>
                                                <p className="text-slate-400 text-xs font-medium flex items-center gap-1.5">
                                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="clock" class="w-3.5 h-3.5"></i>' }}></span>
                                                    {new Date(nextMatch.date).toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}
                                                    {nextMatch.time ? ` • ${nextMatch.time}h` : ''}
                                                </p>
                                            </div>
                                            <div className={`px-2 py-1 rounded-lg text-[10px] font-bold shadow-sm ${nextMatch.isHome ? 'bg-blue-600 text-white border border-blue-500' : 'bg-orange-500 text-white border border-orange-400'}`}>
                                                {nextMatch.isHome ? '🏠 CASA' : '✈️ FUERA'}
                                            </div>
                                        </div>
                                        {nextMatch.location && (
                                            <div className="mt-3 inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full bg-slate-800 border border-slate-700 text-xs text-slate-300">
                                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="map-pin" class="w-3 h-3 text-red-400"></i>' }}></span>
                                                <span className="truncate max-w-[200px]">{nextMatch.location}</span>
                                            </div>
                                        )}
                                        {nextMatch.callTime && nextMatch.isHome && (
                                            <div className="mt-2 text-[10px] text-emerald-400 font-bold flex items-center gap-1.5">
                                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="bell" class="w-3 h-3"></i>' }}></span>
                                                Convocatoria: {nextMatch.callTime}h (1h antes)
                                            </div>
                                        )}
                                    </div>
                                    <div className="absolute bottom-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity transform translate-x-2 group-hover:translate-x-0">
                                        <div className="bg-blue-600 text-white p-1.5 rounded-full shadow-lg">
                                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-right" class="w-4 h-4"></i>' }}></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}
                    <section>
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-slate-800">Partidos</h3>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => navigate('calendar', team.id)}
                                    className="text-sm bg-slate-100 text-slate-700 px-3 py-1 rounded-full font-bold hover:bg-slate-200 transition-colors flex items-center gap-1"
                                    title="Ver Calendario"
                                >
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="calendar" class="w-3.5 h-3.5"></i>' }}></span>
                                </button>
                                <button
                                    onClick={() => navigate('match-setup', team.id)}
                                    className="text-sm bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-bold"
                                >
                                    + Nuevo Partido
                                </button>
                            </div>
                        </div>
                        <div className="space-y-2">
                            {teamMatches.length === 0 && <p className="text-sm text-slate-400">Sin partidos registrados.</p>}
                            {getSortedMatches(teamMatches).map(m => (
                                <div
                                    key={m.id}
                                    className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all flex justify-between items-center group/match"
                                >
                                    <div onClick={() => navigate('active-match', team.id, m.id)} className="flex-1 cursor-pointer">
                                        <p className="font-bold text-slate-800">vs {m.opponent}</p>
                                        <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-0.5">
                                            {m.date} {m.time ? `• ${m.time} h` : ''}
                                            {m.state === 'finished' ? (
                                                <span className={`ml-1 ${m.result === 'won' ? 'text-green-600' : (m.result === 'lost' ? 'text-red-500' : 'text-slate-500')}`}>
                                                    • {m.result === 'won' ? 'Victoria' : (m.result === 'lost' ? 'Derrota' : 'Finalizado')}
                                                    {m.score ? ` (${m.score.local} - ${m.score.visitor})` : ''}
                                                </span>
                                            ) : <span className="text-blue-600 ml-1">• P{m.currentPeriod}</span>}
                                        </p>
                                    </div>
                                    <div className="flex items-center gap-1.5">
                                        {m.state !== 'finished' && (
                                            <div className="flex bg-slate-50 p-1 rounded-lg border border-slate-100 md:opacity-0 md:group-hover/match:opacity-100 transition-opacity">
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); navigate('edit-match', team.id, m.id); }}
                                                    className="p-1 px-1.5 text-blue-600 hover:bg-blue-50 rounded"
                                                    title="Editar Partido"
                                                >
                                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="edit-2" class="w-3.5 h-3.5"></i>' }}></span>
                                                </button>
                                                <div className="w-px h-3 bg-slate-200 mx-0.5"></div>
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); copyToClipboard(generateConvocatoria(m, team, 'val')); }}
                                                    className="p-1 px-1.5 text-[10px] font-bold text-emerald-600 hover:bg-emerald-50 rounded"
                                                    title="Copy VAL"
                                                >
                                                    VAL
                                                </button>
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); copyToClipboard(generateConvocatoria(m, team, 'cas')); }}
                                                    className="p-1 px-1.5 text-[10px] font-bold text-emerald-600 hover:bg-emerald-50 rounded border-l border-slate-200"
                                                    title="Copy CAS"
                                                >
                                                    CAS
                                                </button>
                                            </div>
                                        )}
                                        <div className={`w-2 h-2 rounded-full ${m.state === 'finished' ? 'bg-slate-300' : 'bg-blue-500 animate-pulse'}`}></div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </section>
                </div>
            );
        };



        const SubstitutionView = ({ players, currentP, localHistory, onCancel, onConfirm }) => {
            const pData = localHistory[currentP] || {};
            const currentPeriodData = Array.isArray(pData) ? pData.reduce((acc, id) => ({ ...acc, [id]: 'receptor' }), {}) : pData;
            const currentIds = Object.keys(currentPeriodData);
            const candidatesOut = players.filter(p => currentIds.includes(p.id));
            const candidatesIn = players.filter(p => !currentIds.includes(p.id) && !p.disabled);
            const [selectedOut, setSelectedOut] = useState(null);
            const [selectedIn, setSelectedIn] = useState(null);

            useEffect(() => {
                lucide.createIcons();
            }, []);

            return (
                <div className="p-4 max-w-md mx-auto">
                    <h2 className="font-bold text-lg mb-4 text-red-600 flex items-center gap-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="activity" class="w-5 h-5"></i>' }}></span> Sustitución por Lesión (P{currentP})</h2>
                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-2">Sale (Lesionado)</label>
                            <div className="grid grid-cols-2 gap-2">
                                {candidatesOut.map(p => (
                                    <button key={p.id} onClick={() => setSelectedOut(p.id)} className={`p-3 border rounded-xl text-left ${selectedOut === p.id ? 'bg-red-50 border-red-500 ring-1 ring-red-500' : 'bg-white border-slate-200'}`}>
                                        <span className="font-bold text-slate-700">#{p.number}</span> <span className="text-sm">{p.name}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                        <div className="flex justify-center text-slate-300"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="arrow-down" class="w-6 h-6"></i>' }}></span></div>
                        <div>
                            <label className="block text-sm font-bold text-slate-700 mb-2">Entra (Sustituto)</label>
                            <div className="grid grid-cols-2 gap-2">
                                {candidatesIn.map(p => (
                                    <button key={p.id} onClick={() => setSelectedIn(p.id)} className={`p-3 border rounded-xl text-left ${selectedIn === p.id ? 'bg-green-50 border-green-500 ring-1 ring-green-500' : 'bg-white border-slate-200'}`}>
                                        <span className="font-bold text-slate-700">#{p.number}</span> <span className="text-sm">{p.name}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-2 mt-8">
                        <button onClick={onCancel} className="p-3 border rounded-xl font-bold text-slate-500">Cancelar</button>
                        <button onClick={() => onConfirm(selectedOut, selectedIn)} disabled={!selectedOut || !selectedIn} className="p-3 bg-red-600 text-white rounded-xl font-bold disabled:opacity-50">Confirmar Cambio</button>
                    </div>
                </div>
            );
        };

        const ActiveMatchView = ({ match, teams, updateMatchInDb, navigate, getRoles }) => {
            const [localHistory, setLocalHistory] = useState(match?.history || {});
            const [mode, setMode] = useState('matrix');
            const [matchInjuries, setMatchInjuries] = useState(match?.injuries || []);
            const [sortBy, setSortBy] = useState('role');
            const [editAllMode, setEditAllMode] = useState(false);
            const [forceEdit, setForceEdit] = useState(false);
            const [showFinishModal, setShowFinishModal] = useState(false);
            const [finalScore, setFinalScore] = useState({ local: '', visitor: '' });

            useEffect(() => {
                if (showFinishModal && match?.score) {
                    setFinalScore({
                        local: match.score.local || '',
                        visitor: match.score.visitor || ''
                    });
                }
            }, [showFinishModal, match?.score]);

            const team = teams.find(t => t.id === match?.teamId);
            if (!match || !team) return (
                <div className="p-4 flex flex-col items-center justify-center min-h-[50vh] text-slate-400 gap-4">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
                    <div className="text-center">
                        <p className="font-bold">Cargando datos del partido...</p>
                        <p className="text-[10px] mt-1 opacity-50">Match: {match ? 'OK' : 'Buscando...'} | Team: {team ? 'OK' : 'Buscando...'}</p>
                    </div>
                </div>
            );

            const rulesetId = match?.rulesetId || team?.rulesetId || DEFAULT_RULESET;
            const ruleset = RULESETS[rulesetId] || RULESETS[DEFAULT_RULESET];
            const currentP = match?.currentPeriod || 1;
            const isFinished = match?.state === 'finished';
            const isLocked = isFinished && !forceEdit;
            const totalRenderedPeriods = Math.max(ruleset.totalPeriods, currentP);
            const periodsArray = Array.from({ length: totalRenderedPeriods }, (_, i) => i + 1);

            const roles = getRoles(team);
            const roleKeys = Object.keys(roles);

            useEffect(() => {
                if (match?.history) {
                    const sanitizedHistory = { ...match.history };
                    Object.keys(sanitizedHistory).forEach(p => {
                        if (Array.isArray(sanitizedHistory[p])) {
                            const asObj = {};
                            sanitizedHistory[p].forEach(pid => {
                                const pObj = match.players?.find(pl => pl.id === pid);
                                asObj[pid] = pObj?.role || 'receptor';
                            });
                            sanitizedHistory[p] = asObj;
                        }
                    });
                    setLocalHistory(sanitizedHistory);
                }
                if (match?.injuries) setMatchInjuries(match.injuries);
            }, [match]);

            useEffect(() => {
                lucide.createIcons();
            });

            const togglePlay = async (period, playerId) => {
                if (isLocked) return;
                const isEditable = editAllMode || period === currentP;
                if (!isEditable) return;

                const pData = localHistory[period];
                let currentRole = null;
                if (Array.isArray(pData)) {
                    if (pData.includes(playerId)) currentRole = (match.players.find(p => p.id === playerId)?.role) || 'receptor';
                } else if (pData && pData[playerId]) {
                    currentRole = pData[playerId];
                }

                const periodState = { ...(localHistory[period] && !Array.isArray(localHistory[period]) ? localHistory[period] : {}) };
                if (Array.isArray(localHistory[period])) {
                    localHistory[period].forEach(pid => periodState[pid] = (match.players.find(p => p.id === pid)?.role) || 'receptor');
                }

                if (!currentRole) {
                    if (Object.keys(periodState).length >= 5) {
                        alert("Máximo 5 jugadores por periodo");
                        return;
                    }
                }

                await handleToggle(period, playerId, currentRole, periodState);
            };

            const handleToggle = async (period, playerId, currentRole, periodState) => {
                let nextRole = null;
                const teamPlayer = team.players?.find(p => p.id === playerId);
                const defaultRole = teamPlayer?.role || roleKeys[0] || 'receptor';

                // Sequence logic:
                // 1. If not playing (no currentRole) -> Default Role
                // 2. If currentRole is ANY role except the last in our cycle -> Next Role
                // 3. If currentRole is the last available role -> Remove (nextRole = null)

                // Create a rotation list that starts with defaultRole, then all other roles order
                const otherRoles = roleKeys.filter(r => r !== defaultRole);
                const rotationCycle = [defaultRole, ...otherRoles];

                if (!currentRole) {
                    nextRole = defaultRole;
                } else {
                    const currentIndex = rotationCycle.indexOf(currentRole);
                    if (currentIndex !== -1 && currentIndex < rotationCycle.length - 1) {
                        nextRole = rotationCycle[currentIndex + 1];
                    } else {
                        nextRole = null;
                    }
                }

                const newPeriodState = { ...periodState };
                if (nextRole) {
                    newPeriodState[playerId] = nextRole;
                } else {
                    delete newPeriodState[playerId];
                }

                const newHistory = { ...localHistory, [period]: newPeriodState };
                setLocalHistory(newHistory);
                await updateMatchInDb(match.id, { history: newHistory });
            };

            const clearPlay = async (e, period, playerId) => {
                e.preventDefault();
                if (isLocked) return;
                const status = getPeriodStatus(period);
                const isEditable = editAllMode || status === 'active';
                if (!isEditable || (match.players.find(p => p.id === playerId)?.disabled)) return;

                const newPeriodState = { ...(localHistory[period] && !Array.isArray(localHistory[period]) ? localHistory[period] : {}) };
                if (Array.isArray(localHistory[period])) {
                    localHistory[period].forEach(pid => newPeriodState[pid] = (match.players.find(p => p.id === pid)?.role) || 'receptor');
                }

                if (!newPeriodState[playerId]) return;

                delete newPeriodState[playerId];
                const newHistory = { ...localHistory, [period]: newPeriodState };
                setLocalHistory(newHistory);
                await updateMatchInDb(match.id, { history: newHistory });
            };

            const getPeriodStatus = (period) => {
                if (period < currentP) return 'past';
                if (period === currentP) return 'active';
                return 'future';
            };

            const getStats = (playerId) => {
                let played = 0;
                for (let i = 1; i <= totalRenderedPeriods; i++) {
                    const pData = localHistory[i];
                    let inPeriod = false;
                    if (Array.isArray(pData)) inPeriod = pData.includes(playerId);
                    else if (pData) inPeriod = !!pData[playerId];

                    if (inPeriod) {
                        const isInjured = matchInjuries.find(inj => inj.period === i && (inj.playerOut === playerId || inj.playerIn === playerId));
                        if (!isInjured) played++;
                    }
                }
                return { played };
            };

            const getValidationState = () => {
                const errors = [];
                const warnings = [];
                const historyArray = {};
                for (let i = 1; i <= ruleset.totalPeriods; i++) {
                    const pData = localHistory[i];
                    historyArray[i] = Array.isArray(pData) ? pData : (pData ? Object.keys(pData) : []);
                }

                (match.players || []).forEach(p => {
                    if (p.disabled) return;

                    let playedInCheckRange = 0;
                    let restedInCheckRange = 0;
                    let limboInCheckRange = 0;

                    for (let i = 1; i <= ruleset.checkPeriod; i++) {
                        const isInjured = matchInjuries.find(inj => inj.period === i && (inj.playerOut === p.id || inj.playerIn === p.id));
                        if (isInjured) {
                            limboInCheckRange++;
                            continue;
                        }

                        if (i <= currentP) {
                            if (historyArray[i]?.includes(p.id)) playedInCheckRange++;
                            else restedInCheckRange++;
                        }
                    }

                    const remainingPeriods = ruleset.checkPeriod - Math.min(ruleset.checkPeriod, currentP);
                    const maxPossiblePlayed = playedInCheckRange + remainingPeriods;
                    const maxPossibleRested = restedInCheckRange + remainingPeriods;

                    if (playedInCheckRange > ruleset.maxPlay) {
                        errors.push(`${p.name} excede ${ruleset.maxPlay} periodos en los primeros ${ruleset.checkPeriod}.`);
                    }

                    if (maxPossiblePlayed < ruleset.minPlay) {
                        errors.push(`¡Error Pasarela!: Es matemáticamente imposible que ${p.name} juegue los ${ruleset.minPlay} periodos mínimos(solo llegaría a ${maxPossiblePlayed}).`);
                    } else if (playedInCheckRange < ruleset.minPlay && (isFinished || currentP >= ruleset.checkPeriod)) {
                        errors.push(`${p.name} no cumple el mínimo de ${ruleset.minPlay} periodos en los primeros ${ruleset.checkPeriod}.`);
                    }

                    if (maxPossibleRested < ruleset.minRest) {
                        errors.push(`¡Error Pasarela!: Es matemáticamente imposible que ${p.name} descanse los ${ruleset.minRest} periodos mínimos(solo llegaría a ${maxPossibleRested}).`);
                    } else if (restedInCheckRange < ruleset.minRest && (isFinished || currentP >= ruleset.checkPeriod)) {
                        errors.push(`${p.name} no cumple el mínimo de ${ruleset.minRest} periodos de descanso en los primeros ${ruleset.checkPeriod}.`);
                    }
                });
                return { errors, warnings };
            };

            const validations = getValidationState();

            const confirmPeriod = async () => {
                const pData = localHistory[currentP];
                const count = pData ? Object.keys(pData).length : 0;
                if (count !== 5) {
                    if (!confirm(`Has seleccionado ${count} jugadores. ¿Seguro que quieres cerrar el periodo ? `)) return;
                }
                if (currentP >= ruleset.totalPeriods) {
                    setShowFinishModal(true);
                    return;
                }
                await updateMatchInDb(match.id, {
                    currentPeriod: currentP + 1,
                    history: localHistory,
                    state: 'active'
                });
            };

            const deleteMatch = async () => {
                const teamId = match.teamId; // Capture before deletion
                if (!confirm("¿Eliminar este partido permanentemente?")) return;
                try {
                    const { deleteDoc, doc } = window.firebaseMethods;
                    const db = window.db;
                    navigate('team-detail', teamId); // Navigate immediately to avoid UI errors
                    // Wait a tick to ensure unmount/navigation starts
                    setTimeout(async () => {
                        await deleteDoc(doc(db, "matches", match.id));
                    }, 100);
                } catch (e) {
                    console.error("Error deleting match", e);
                    alert("Error al eliminar el partido");
                }
            };

            const addLatePlayer = () => setMode("add-player");

            const confirmAddPlayer = async (player) => {
                const updatedPlayers = [...(match.players || []), player];
                await updateMatchInDb(match.id, { players: updatedPlayers });
                setMode('matrix');
            };

            const togglePlayerActiveStatus = async (playerId, playerName, currentDisabled) => {
                const action = currentDisabled ? "habilitar" : "deshabilitar";
                if (!confirm(`¿Deseas ${action} a ${playerName} para este partido ? `)) return;
                const updatedPlayers = (match.players || []).map(p =>
                    p.id === playerId ? { ...p, disabled: !currentDisabled } : p
                );
                await updateMatchInDb(match.id, { players: updatedPlayers });
            };

            const handleSubstitution = async (playerOutId, playerInId) => {
                if (!playerOutId || !playerInId) return;
                const newInjury = { period: currentP, playerOut: playerOutId, playerIn: playerInId, timestamp: new Date().toISOString() };
                const updatedInjuries = [...matchInjuries, newInjury];
                const updatedHistory = { ...localHistory };
                const currentPeriodData = { ...(updatedHistory[currentP] || {}) };
                const outgoingRole = currentPeriodData[playerOutId];
                delete currentPeriodData[playerOutId];
                const playerIn = team.players?.find(p => p.id === playerInId);
                currentPeriodData[playerInId] = outgoingRole || playerIn?.role || 'receptor';
                updatedHistory[currentP] = currentPeriodData;
                await updateMatchInDb(match.id, { injuries: updatedInjuries, history: updatedHistory });
                setMode('matrix');
            };

            if (mode === 'add-player') {
                const currentIds = (match.players || []).map(p => p.id);
                const availablePlayers = (team.players || []).filter(p => !currentIds.includes(p.id));
                return (
                    <div className="p-4 max-w-md mx-auto">
                        <div className="flex items-center justify-between mb-4">
                            <h2 className="font-bold text-lg">Añadir Jugador Tardío</h2>
                            <button
                                onClick={async () => {
                                    if (availablePlayers.length === 0) return;
                                    if (confirm(`¿Añadir a TODOS (${availablePlayers.length}) los jugadores disponibles?`)) {
                                        const updatedPlayers = [...(match.players || []), ...availablePlayers];
                                        await updateMatchInDb(match.id, { players: updatedPlayers });
                                        setMode('matrix');
                                    }
                                }}
                                disabled={availablePlayers.length === 0}
                                className="text-xs bg-blue-100 text-blue-700 px-3 py-1.5 rounded-lg font-bold hover:bg-blue-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="users-plus" class="w-3.5 h-3.5 inline-block mr-1"></i>' }}></span>
                                Añadir Todos
                            </button>
                        </div>
                        <div className="space-y-2">
                            {availablePlayers.length === 0 && <p className="text-sm text-slate-400 italic text-center py-8">No hay más jugadores disponibles.</p>}
                            {availablePlayers.map(p => (
                                <button key={p.id} onClick={() => confirmAddPlayer(p)} className="w-full text-left p-3 rounded-xl border border-slate-200 bg-white hover:bg-slate-50 flex justify-between items-center group">
                                    <span className="font-bold text-slate-700 group-hover:text-blue-700">#{p.number} {p.name}</span>
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="plus-circle" class="w-5 h-5 text-green-500 group-hover:text-green-600"></i>' }}></span>
                                </button>
                            ))}
                        </div>
                        <button onClick={() => setMode('matrix')} className="mt-4 w-full py-3 text-slate-500 font-bold border border-slate-200 rounded-xl hover:bg-slate-50">Cancelar</button>
                    </div>
                );
            }

            if (mode === 'summary') {
                return (
                    <div className="p-4 max-w-md mx-auto">
                        <header className="mb-6 flex items-center gap-2">
                            <button onClick={() => navigate('team-detail', match.teamId)} className="p-2 -ml-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span></button>
                            <h1 className="text-2xl font-bold">Resumen</h1>
                        </header>
                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 font-medium border-b border-slate-100">
                                    <tr><th className="p-3">Jugador</th><th className="p-3 text-center">Total Jugados</th></tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100">
                                    {(match.players || []).map(p => (
                                        <tr key={p.id}><td className="p-3 font-medium">{p.number} - {p.name}</td><td className="p-3 text-center">{getStats(p.id).played}</td></tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            }

            if (mode === 'substitution') return <SubstitutionView players={match.players || []} currentP={currentP} localHistory={localHistory} onCancel={() => setMode('matrix')} onConfirm={handleSubstitution} />;

            if (mode === 'edit-match') {
                return (
                    <div className="p-4 max-w-md mx-auto">
                        <header className="mb-6 flex items-center gap-2">
                            <button onClick={() => setMode('matrix')} className="p-2 -ml-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span></button>
                            <h1 className="text-2xl font-bold">Editar Partido</h1>
                        </header>
                        <EditMatchView match={match} team={team} onDelete={deleteMatch} onSave={async (updates) => { await updateMatchInDb(match.id, updates); setMode('matrix'); }} />
                    </div>
                );
            }

            const players = [...(match.players || [])];
            if (sortBy === 'role') {
                players.sort((a, b) => {
                    const roleA = (team.players || []).find(p => p.id === a.id)?.role || 'receptor';
                    const roleB = (team.players || []).find(p => p.id === b.id)?.role || 'receptor';
                    const orderA = roles[roleA]?.order || 99;
                    const orderB = roles[roleB]?.order || 99;
                    return orderA - orderB || parseInt(a.number) - parseInt(b.number);
                });
            } else {
                players.sort((a, b) => parseInt(a.number) - parseInt(b.number));
            }

            return (
                <div className="p-2 md:p-4 max-w-4xl mx-auto pb-24">
                    <header className="mb-4">
                        <div className="flex items-center justify-between mb-2">
                            <button onClick={() => navigate('team-detail', match.teamId)} className="p-2 -ml-2 text-slate-600 hover:text-slate-900"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left" class="w-6 h-6"></i>' }}></span></button>
                            <div className="text-center">
                                <h1 className="text-lg font-bold text-slate-800 leading-tight">vs {match.opponent}</h1>
                                <p className="text-xs text-slate-500">{match.date} • {isLocked ? 'Finalizado' : `P${currentP} `} • {match.score ? `(${match.score.local} - ${match.score.visitor})` : ''}</p>
                            </div>
                            <div className="flex items-center gap-1">
                                {isFinished && isLocked && <button onClick={() => setForceEdit(true)} className="p-2 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors" title="Habilitar Edición"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="lock" class="w-5 h-5"></i>' }}></span></button>}
                                <button id="tutorial-edit-mode" onClick={() => setEditAllMode(!editAllMode)} disabled={isLocked} className={`p-2 rounded-lg transition-colors border ${isLocked ? 'bg-slate-50 text-slate-300 opacity-50 cursor-not-allowed border-transparent' : (editAllMode ? 'bg-amber-100 text-amber-700 border-amber-300' : 'bg-slate-100 text-slate-500 border-transparent hover:bg-slate-200')}`} title="Modo Edición Total"><span dangerouslySetInnerHTML={{ __html: `<i data-lucide="${editAllMode ? 'unlock' : 'lock'}" class="w-5 h-5"></i>` }}></span></button>
                                <button onClick={addLatePlayer} disabled={isLocked} className={`p-2 rounded-lg transition-colors ${isLocked ? 'bg-slate-50 text-slate-300 opacity-50 cursor-not-allowed' : 'bg-blue-50 text-blue-600 hover:bg-blue-100'}`} title="Añadir Convocado"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="user-plus" class="w-5 h-5"></i>' }}></span></button>
                                <button onClick={() => setMode('edit-match')} className="p-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition-colors" title="Configurar Partido"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="settings" class="w-5 h-5"></i>' }}></span></button>

                            </div>
                        </div>
                    </header>
                    {(validations.errors.length > 0 || validations.warnings.length > 0) && (
                        <div className="mb-4 bg-red-50 border-l-4 border-red-500 p-3 rounded-r-md text-sm shadow-sm">
                            {validations.errors.map((e, i) => <div key={`err-${i}`} className="text-red-700 font-bold flex items-center gap-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="alert-triangle" class="w-4 h-4"></i>' }}></span> {e}</div>)}
                            {validations.warnings.map((w, i) => <div key={`warn-${i}`} className="text-amber-700 flex items-center gap-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="info" class="w-4 h-4"></i>' }}></span> {w}</div>)}
                        </div>
                    )}
                    <div className="overflow-x-auto bg-white rounded-xl shadow-sm border border-slate-200">
                        <table className="w-full text-sm border-collapse">
                            <thead>
                                <tr className="bg-slate-100 text-slate-600">
                                    <th className="p-2 text-left sticky left-0 bg-slate-100 z-10 border-b border-r w-32"><div className="flex items-center justify-between"><span>Jugador</span><button onClick={() => setSortBy(sortBy === 'role' ? 'number' : 'role')} className="p-1 hover:bg-slate-200 rounded transition-colors text-slate-400" title={`Ordenar por ${sortBy === 'role' ? 'Número' : 'Rol'}`}><span dangerouslySetInnerHTML={{ __html: `<i data-lucide="${sortBy === 'role' ? 'users' : 'hash'}" class="w-3 h-3"></i>` }}></span></button></div></th>
                                    {periodsArray.map(p => (<th key={p} className={`p-2 text-center min-w-[40px] border-b ${p === currentP ? 'bg-blue-100/50 text-blue-800 border-blue-200 font-bold ring-2 ring-inset ring-blue-300' : ''}`}>P{p}</th>))}
                                    <th className="p-2 text-center border-b w-12 bg-slate-50">Tot</th>
                                </tr>
                            </thead>
                            <tbody>
                                {players.map(p => {
                                    const isDisabled = p.disabled;
                                    const isPlayingNow = !!(localHistory[currentP]?.[p.id]);
                                    const hasError = validations.errors.some(e => e.includes(p.name));
                                    const defaultRole = (team.players || []).find(tp => tp.id === p.id)?.role;
                                    return (
                                        <tr key={p.id} className={`border-b last:border-0 h-10 group/row ${isDisabled ? 'bg-slate-100 text-slate-400' : (hasError ? 'bg-red-100 border-red-200' : (isPlayingNow ? 'bg-blue-50/30' : 'hover:bg-slate-50'))}`}>
                                            <td className={`p-2 border-r sticky left-0 z-10 font-medium text-xs md:text-sm whitespace-nowrap flex items-center justify-between ${isDisabled ? 'bg-slate-100 text-slate-400' : (hasError ? 'bg-red-100 text-red-900 font-bold' : (isPlayingNow ? 'bg-blue-50 text-blue-900 font-extrabold' : 'bg-white text-slate-800 group-hover/row:bg-slate-50'))}`}>
                                                <div className={isDisabled ? 'line-through decoration-slate-400' : ''}><span className="inline-block w-6">#{p.number}</span><span className="mr-1">{p.name}</span>{!isDisabled && defaultRole && roles[defaultRole] && (<span className={`w-2 h-2 rounded-full inline-block mb-0.5 ${roles[defaultRole].bg.replace('-50', '-400')}`}></span>)}</div>
                                                {!isLocked && (<button onClick={() => togglePlayerActiveStatus(p.id, p.name, isDisabled)} className={`p-1 opacity-0 group-hover/row:opacity-100 transition-opacity ${isDisabled ? 'text-green-500 hover:text-green-700' : 'text-slate-300 hover:text-red-500'}`}><span dangerouslySetInnerHTML={{ __html: `<i data-lucide="${isDisabled ? 'rotate-ccw' : 'ban'}" class="w-3 h-3"></i>` }}></span></button>)}
                                            </td>
                                            {periodsArray.map(period => {
                                                const status = getPeriodStatus(period);
                                                const isEditable = editAllMode || status === 'active';
                                                const pData = localHistory[period];
                                                let isSelected = false; let role = null;
                                                if (pData && pData[p.id]) { isSelected = true; role = pData[p.id]; }
                                                const injuryData = matchInjuries.find(inj => inj.period === period && (inj.playerOut === p.id || inj.playerIn === p.id));
                                                const isOut = injuryData?.playerOut === p.id;
                                                const isIn = injuryData?.playerIn === p.id;

                                                // Special case: if player is OUT due to injury, they should still be considered "selected" for rendering the arrow
                                                const shouldShowCell = isSelected || isOut;
                                                return (
                                                    <td
                                                        key={period}
                                                        onClick={() => { if (!isLocked && isEditable && !isDisabled) togglePlay(period, p.id); }}
                                                        onContextMenu={(e) => clearPlay(e, period, p.id)}
                                                        className={`p-1 text-center border-r last:border-r-0 transition-all select-none relative ${shouldShowCell ? (isDisabled ? 'bg-slate-400' : (role && roles[role] ? roles[role].bg : (isOut ? 'bg-red-50' : 'bg-blue-500'))) : (isEditable && !isDisabled && !isLocked ? 'hover:bg-slate-100 cursor-pointer' : '')} ${!isEditable || isLocked ? 'opacity-80' : ''} ${period === currentP && !shouldShowCell && !isDisabled ? 'bg-blue-50/50' : ''} ${(isOut || isIn) ? '!bg-slate-200' : ''}`}
                                                    >
                                                        {shouldShowCell && (
                                                            <div className={`w-full h-full flex items-center justify-center font-bold text-xs ${isDisabled ? 'text-white' : (role && roles[role] ? roles[role].color : 'text-white')} ${(isOut || isIn) ? '!text-slate-500' : ''}`}>
                                                                {isOut ? (
                                                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="arrow-down" class="w-4 h-4 text-red-500"></i>' }}></span>
                                                                ) : (isIn ? (
                                                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="arrow-up" class="w-4 h-4 text-green-600"></i>' }}></span>
                                                                ) : (role ? role.substring(0, 1).toUpperCase() : (
                                                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="check" class="w-4 h-4"></i>' }}></span>
                                                                )))}
                                                            </div>
                                                        )}
                                                    </td>
                                                );
                                            })}
                                            <td className={`p-2 text-center border-l font-bold ${hasError ? 'bg-red-100 text-red-700' : 'bg-slate-50 text-slate-600'}`}>{getStats(p.id).played}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>

                    {!isLocked && (
                        <div className="mt-4 p-4 bg-blue-50/50 rounded-xl border border-blue-100 animate-in fade-in slide-in-from-bottom-2">
                            <h3 className="text-xs font-bold text-blue-600 uppercase tracking-wider mb-2 flex items-center gap-2">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="users" class="w-4 h-4"></i>' }}></span> En pista ({Object.keys(localHistory[currentP] || {}).length})
                            </h3>
                            <div className="flex flex-wrap gap-2">
                                {players.filter(p => localHistory[currentP]?.[p.id]).map(p => {
                                    const role = localHistory[currentP][p.id];
                                    return (
                                        <span key={p.id} className="bg-white px-3 py-1.5 rounded-full border border-blue-200 text-sm font-bold text-blue-900 shadow-sm flex items-center gap-2 animate-in zoom-in-95">
                                            <span className="opacity-50">#{p.number}</span>
                                            {p.name}
                                            {role && roles[role] && <span className={`w-2 h-2 rounded-full ${roles[role].bg.replace('-50', '-400')}`}></span>}
                                        </span>
                                    );
                                })}
                                {Object.keys(localHistory[currentP] || {}).length === 0 && (
                                    <span className="text-sm text-slate-400 italic">No hay jugadores seleccionados</span>
                                )}
                            </div>
                        </div>
                    )}
                    {!isLocked && (
                        <div id="tutorial-period-nav" className="fixed bottom-4 left-4 right-4 max-w-md mx-auto flex gap-2">
                            <div className="flex-1 bg-white border border-slate-200 p-2 rounded-xl shadow-lg flex items-center justify-between px-4">
                                <div className="flex items-center gap-2">
                                    <button onClick={async () => { if (currentP > 1 && confirm("¿Volver al periodo anterior?")) await updateMatchInDb(match.id, { currentPeriod: currentP - 1 }); }} disabled={currentP <= 1} className="p-2 text-slate-400 hover:text-slate-700 disabled:opacity-30"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="arrow-left" class="w-5 h-5"></i>' }}></span></button>
                                    <span className="font-bold text-slate-700">P{currentP}</span>
                                    <button id="tutorial-injury-btn" onClick={() => setMode('substitution')} className="bg-red-50 text-red-600 rounded-full p-1 hover:bg-red-100 ml-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="activity" class="w-4 h-4"></i>' }}></span></button>
                                </div>
                                <div className="text-xs text-slate-400 flex items-center gap-1"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="users" class="w-3 h-3"></i>' }}></span>{Object.keys(localHistory[currentP] || {}).length}/5</div>
                            </div>
                            <button onClick={confirmPeriod} className={`p-4 px-6 rounded-xl shadow-lg flex items-center gap-2 font-bold text-white transition-all ${currentP >= ruleset.totalPeriods ? 'bg-green-600 hover:bg-green-700' : 'bg-slate-900 hover:bg-slate-800'}`}>
                                {currentP >= ruleset.totalPeriods ? <><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="flag"></i>' }}></span> Finalizar</> : <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="arrow-right"></i>' }}></span>}
                            </button>
                        </div>
                    )}
                    {showFinishModal && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full animate-in zoom-in-95">
                                <h2 className="text-2xl font-bold mb-2">Fin del partido</h2>
                                <p className="text-slate-500 mb-6">Introduce el resultado final.</p>
                                <div className="mb-6 grid grid-cols-2 gap-4">
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Local</label><input type="number" className="w-full p-2 border rounded-lg text-center text-lg font-bold" value={finalScore.local} onChange={e => setFinalScore({ ...finalScore, local: e.target.value })} /></div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-1">Visitante</label><input type="number" className="w-full p-2 border rounded-lg text-center text-lg font-bold" value={finalScore.visitor} onChange={e => setFinalScore({ ...finalScore, visitor: e.target.value })} /></div>
                                </div>
                                <div className="space-y-3">
                                    <button onClick={async () => {
                                        const score = { local: parseInt(finalScore.local) || 0, visitor: parseInt(finalScore.visitor) || 0 };
                                        let result = null;
                                        if (finalScore.local !== '' && finalScore.visitor !== '') {
                                            const we = match.isHome !== false ? score.local : score.visitor;
                                            const they = match.isHome !== false ? score.visitor : score.local;
                                            result = we > they ? 'won' : (we < they ? 'lost' : 'draw');
                                        }
                                        await updateMatchInDb(match.id, { state: 'finished', history: localHistory, score, result });
                                        setMode('summary'); setShowFinishModal(false);
                                    }} className="w-full p-4 bg-green-600 text-white font-bold rounded-xl flex items-center justify-center gap-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="check-circle"></i>' }}></span> Finalizar Partido</button>
                                    <button onClick={async () => { await updateMatchInDb(match.id, { currentPeriod: currentP + 1, history: localHistory }); setShowFinishModal(false); }} className="w-full p-4 bg-blue-50 text-blue-700 font-bold rounded-xl flex items-center justify-center gap-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="plus-circle"></i>' }}></span> Añadir Prórroga (P{currentP + 1})</button>
                                    <button onClick={() => setShowFinishModal(false)} className="w-full p-2 text-slate-400 font-medium mt-2">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };


        const AllMatchesCalendarView = ({ teams, matches, navigate }) => {
            const [viewMode, setViewMode] = useState('month'); // 'month', 'week', 'day'
            const [currentDate, setCurrentDate] = useState(new Date());

            useEffect(() => {
                lucide.createIcons();
            }, [viewMode, currentDate]);

            // Helper functions for date manipulation (Reused logic)
            const getMonthDays = (date) => {
                const year = date.getFullYear();
                const month = date.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const dayOfWeek = firstDay.getDay();
                const startingDayOfWeek = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                const days = [];
                for (let i = 0; i < startingDayOfWeek; i++) days.push(null);
                for (let day = 1; day <= daysInMonth; day++) days.push(new Date(year, month, day));
                return days;
            };

            const getWeekDays = (date) => {
                const dayOfWeek = date.getDay();
                const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                const monday = new Date(date.setDate(diff));
                const days = [];
                for (let i = 0; i < 7; i++) {
                    const day = new Date(monday);
                    day.setDate(monday.getDate() + i);
                    days.push(day);
                }
                return days;
            };

            const getMatchesForDate = (date) => {
                if (!date) return [];
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const dateStr = `${year}-${month}-${day}`;
                return (matches || []).filter(m => m.date === dateStr);
            };

            const formatMonthYear = (date) => {
                const months = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
                return `${months[date.getMonth()]} ${date.getFullYear()} `;
            };

            const formatWeekRange = (days) => {
                const first = days[0];
                const last = days[6];
                return `${first.getDate()} - ${last.getDate()} ${formatMonthYear(first)} `;
            };

            const formatDayDate = (date) => {
                const days = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
                return `${days[date.getDay()]}, ${date.getDate()} de ${formatMonthYear(date)} `;
            };

            const goToToday = () => setCurrentDate(new Date());
            const goToPrevious = () => {
                const newDate = new Date(currentDate);
                if (viewMode === 'month') newDate.setMonth(newDate.getMonth() - 1);
                else if (viewMode === 'week') newDate.setDate(newDate.getDate() - 7);
                else newDate.setDate(newDate.getDate() - 1);
                setCurrentDate(newDate);
            };
            const goToNext = () => {
                const newDate = new Date(currentDate);
                if (viewMode === 'month') newDate.setMonth(newDate.getMonth() + 1);
                else if (viewMode === 'week') newDate.setDate(newDate.getDate() + 7);
                else newDate.setDate(newDate.getDate() + 1);
                setCurrentDate(newDate);
            };

            const MatchCard = ({ match, compact = false }) => {
                const team = teams.find(t => t.id === match.teamId);
                const teamName = team ? team.name : 'Equipo Desconocido';

                return (
                    <div
                        onClick={() => navigate('active-match', match.teamId, match.id)}
                        className={`${compact ? 'p-1.5' : 'p-2'} bg-white border-l-4 ${match.isHome ? 'border-blue-500' : 'border-orange-500'} rounded shadow-sm hover:shadow-md transition-all cursor-pointer group`}
                        title={teamName}
                    >
                        <p className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter truncate mb-0.5">{teamName}</p>
                        <p className={`${compact ? 'text-[10px]' : 'text-xs'} font-bold text-slate-800 truncate group-hover:text-blue-600`}>
                            {compact ? match.opponent : `vs ${match.opponent}`}
                        </p>
                        {!compact && (
                            <p className="text-[9px] text-slate-500 mt-0.5">
                                {match.time}h {match.isHome ? '🏠' : '✈️'}
                            </p>
                        )}
                    </div>
                );
            };

            return (
                <div className="p-4 max-w-4xl mx-auto pb-24">
                    <header className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigate('teams-list')} className="p-2 -ml-2 text-slate-400 hover:text-slate-800 transition-colors">
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span>
                        </button>
                        <h1 className="text-2xl font-bold text-slate-800">Calendario Global</h1>
                    </header>

                    <div className="flex bg-slate-100 p-1 rounded-xl mb-4">
                        <button onClick={() => setViewMode('month')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${viewMode === 'month' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>MES</button>
                        <button onClick={() => setViewMode('week')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${viewMode === 'week' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>SEMANA</button>
                        <button onClick={() => setViewMode('day')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${viewMode === 'day' ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>DÍA</button>
                    </div>

                    <div className="flex items-center justify-between mb-6 bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                        <button onClick={goToPrevious} className="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left" class="w-5 h-5"></i>' }}></span>
                        </button>
                        <div className="text-center">
                            <p className="font-bold text-slate-800">
                                {viewMode === 'month' && formatMonthYear(currentDate)}
                                {viewMode === 'week' && formatWeekRange(getWeekDays(currentDate))}
                                {viewMode === 'day' && formatDayDate(currentDate)}
                            </p>
                            <button onClick={goToToday} className="text-[10px] text-blue-600 font-bold hover:underline mt-0.5">Hoy</button>
                        </div>
                        <button onClick={goToNext} className="p-2 text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-right" class="w-5 h-5"></i>' }}></span>
                        </button>
                    </div>

                    {viewMode === 'month' && (
                        <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                            <div className="grid grid-cols-7 bg-slate-50 border-b border-slate-200">
                                {['L', 'M', 'X', 'J', 'V', 'S', 'D'].map((day, i) => (
                                    <div key={i} className="p-2 text-center text-[10px] font-bold text-slate-600">{day}</div>
                                ))}
                            </div>
                            <div className="grid grid-cols-7">
                                {getMonthDays(currentDate).map((day, i) => {
                                    const dayMatches = day ? getMatchesForDate(day) : [];
                                    const isToday = day && day.toDateString() === new Date().toDateString();
                                    return (
                                        <div key={i} className={`min-h-[80px] p-1.5 border-b border-r border-slate-100 ${!day ? 'bg-slate-50' : ''} ${isToday ? 'bg-blue-50' : ''}`}>
                                            {day && (
                                                <>
                                                    <p className={`text-xs font-bold mb-1 ${isToday ? 'text-blue-600' : 'text-slate-700'}`}>{day.getDate()}</p>
                                                    <div className="space-y-1">
                                                        {dayMatches.map(m => <MatchCard key={m.id} match={m} compact={true} />)}
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {viewMode === 'week' && (
                        <div className="space-y-2">
                            {getWeekDays(currentDate).map((day, i) => {
                                const dayMatches = getMatchesForDate(day);
                                const isToday = day.toDateString() === new Date().toDateString();
                                const dayNames = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
                                return (
                                    <div key={i} className={`bg-white p-3 rounded-xl border border-slate-200 shadow-sm ${isToday ? 'ring-2 ring-blue-500' : ''}`}>
                                        <div className="flex items-center justify-between mb-2">
                                            <div>
                                                <p className={`font-bold ${isToday ? 'text-blue-600' : 'text-slate-800'}`}>{dayNames[day.getDay()]}</p>
                                                <p className="text-xs text-slate-500">{day.getDate()} {formatMonthYear(day).split(' ')[0]}</p>
                                            </div>
                                            {isToday && <span className="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full font-bold">HOY</span>}
                                        </div>
                                        {dayMatches.length > 0 ? (
                                            <div className="space-y-2">
                                                {dayMatches.map(m => <MatchCard key={m.id} match={m} />)}
                                            </div>
                                        ) : (
                                            <p className="text-xs text-slate-400 italic">Sin partidos</p>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {viewMode === 'day' && (
                        <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            {(() => {
                                const dayMatches = getMatchesForDate(currentDate);
                                return dayMatches.length > 0 ? (
                                    <div className="space-y-3">
                                        {dayMatches.map(m => {
                                            const team = teams.find(t => t.id === m.teamId);
                                            return (
                                                <div key={m.id} onClick={() => navigate('active-match', m.teamId, m.id)} className="p-4 bg-slate-50 rounded-lg border border-slate-200 hover:border-blue-300 hover:shadow-md transition-all cursor-pointer group">
                                                    <div className="mb-2">
                                                        <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest bg-white border border-slate-200 px-2 py-1 rounded-md">{team ? team.name : 'Equipo Desconocido'}</span>
                                                    </div>
                                                    <div className="flex items-start justify-between mb-2">
                                                        <div>
                                                            <p className="font-bold text-lg text-slate-800 group-hover:text-blue-600">vs {m.opponent}</p>
                                                            <p className="text-xs text-slate-500 mt-1">{m.matchDay || 'Sin jornada'}</p>
                                                        </div>
                                                        <span className={`text-xs px-2 py-1 rounded-full font-bold ${m.isHome ? 'bg-blue-100 text-blue-600' : 'bg-orange-100 text-orange-600'}`}>
                                                            {m.isHome ? '🏠 Local' : '✈️ Visitante'}
                                                        </span>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2 text-xs text-slate-600">
                                                        <div className="flex items-center gap-1">
                                                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="clock" class="w-3.5 h-3.5"></i>' }}></span>
                                                            <span>{m.time}h</span>
                                                        </div>
                                                        {m.location && (
                                                            <div className="flex items-center gap-1">
                                                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="map-pin" class="w-3.5 h-3.5"></i>' }}></span>
                                                                <span>{m.location}</span>
                                                            </div>
                                                        )}
                                                    </div>
                                                    {m.state === 'finished' && m.score && (
                                                        <div className="mt-3 pt-3 border-t border-slate-200">
                                                            <p className="text-sm font-bold text-slate-700">
                                                                Resultado: <span className={m.result === 'won' ? 'text-green-600' : 'text-red-500'}>{m.score.local} - {m.score.visitor}</span>
                                                            </p>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                ) : (
                                    <div className="text-center py-12">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="calendar-x" class="w-12 h-12 text-slate-200 mx-auto mb-3"></i>' }}></span>
                                        <p className="text-slate-400 font-medium">No hay partidos programados para este día</p>
                                    </div>
                                );
                            })()}
                        </div>
                    )}
                </div>
            );
        };


        const TeamsListView = ({ teams, matches, navigate, addDoc, collection, db, doc, subscription, startCheckout }) => {
            const [newTeamName, setNewTeamName] = useState('');
            const [newTeamRuleset, setNewTeamRuleset] = useState(DEFAULT_RULESET);
            const [newTeamFederationId, setNewTeamFederationId] = useState('');
            const [showForm, setShowForm] = useState(false);
            const [showArchived, setShowArchived] = useState(false);

            const activeTeams = teams.filter(t => !t.archived);
            const archivedTeams = teams.filter(t => t.archived);
            const displayedTeams = showArchived ? archivedTeams : activeTeams;

            const createTeam = async (e) => {
                e.preventDefault();
                if (!newTeamName.trim() || !window.auth.currentUser) return;
                // --- Nueva Lógica de Límites ---
                if (teams.length >= 1 && subscription === null) {
                    alert('Límite del Plan Gratuito: Solo puedes gestionar 1 equipo. Pásate a Premium para equipos ilimitados.');
                    startCheckout();
                    return;
                }

                await addDoc(collection(db, 'teams'), {
                    name: newTeamName,
                    rulesetId: newTeamRuleset,
                    federationId: newTeamFederationId.trim() || null,
                    federationData: null,
                    players: [],
                    roles: DEFAULT_ROLES,
                    ownerId: window.auth.currentUser.uid,
                    userId: window.auth.currentUser.uid,
                    createdAt: new Date().toISOString(),
                    archived: false
                });
                setNewTeamName('');
                setNewTeamFederationId('');
                setNewTeamRuleset(DEFAULT_RULESET);
                setShowForm(false);
            };

            useEffect(() => {
                if (window.lucide) lucide.createIcons();
            }, [teams, showForm, subscription, showArchived]);

            return (
                <div className="max-w-md mx-auto">
                    <div className="px-4 pt-6">
                        <header className="flex justify-between items-center mb-8">
                            <div>
                                <h1 className="text-4xl font-extrabold text-slate-900 tracking-tight">Equipos</h1>
                                <p className="text-slate-400 text-xs mt-1 font-medium italic">Selecciona un equipo para gestionar</p>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    id="global-calendar-btn"
                                    onClick={() => navigate('all-matches-calendar')}
                                    className="p-3 rounded-2xl bg-white text-slate-600 shadow-sm border border-slate-200 hover:bg-slate-50 transition-all hover:scale-105 active:scale-95"
                                    title="Calendario Global"
                                >
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="calendar" class="w-7 h-7"></i>' }}></span>
                                </button>
                                <button
                                    id="add-team-btn"
                                    onClick={() => setShowForm(!showForm)}
                                    className={`p-3 rounded-2xl transition-all shadow-lg ${showForm ? 'bg-slate-200 text-slate-600 rotate-45' : 'bg-blue-600 text-white hover:bg-blue-700 hover:scale-105 active:scale-95'}`}
                                    title="Añadir Equipo"
                                >
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="plus" class="w-7 h-7"></i>' }}></span>
                                </button>
                            </div>
                        </header>

                        {subscription === null && (
                            <div className="mb-6 p-4 bg-gradient-to-br from-blue-600 to-blue-700 rounded-2xl shadow-lg relative overflow-hidden group">
                                <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform">
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="crown" class="w-20 h-20 text-white"></i>' }}></span>
                                </div>
                                <div className="relative z-10">
                                    <h3 className="text-white font-bold text-lg leading-tight mb-1">Pásate a Premium</h3>
                                    <p className="text-blue-100 text-xs mb-3">Gestión de equipos ilimitados, estadísticas avanzadas y más.</p>
                                    <button onClick={startCheckout} className="px-4 py-2 bg-white text-blue-600 rounded-lg font-bold text-xs shadow-sm active:scale-95 transition-all">
                                        Desbloquear equipos
                                    </button>
                                </div>
                            </div>
                        )}

                        {showForm && (
                            <div className="mb-8 p-4 bg-white border border-slate-200 rounded-2xl shadow-sm animate-in slide-in-from-top-2 duration-200">
                                <form onSubmit={createTeam}>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1.5 ml-1">Nombre del Equipo</label>
                                            <input
                                                autoFocus
                                                className="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-blue-500 outline-none transition-all bg-slate-50"
                                                placeholder="Ej: Alevín Masculino..."
                                                value={newTeamName}
                                                onChange={e => setNewTeamName(e.target.value)}
                                            />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1.5 ml-1">Reglamento por Defecto</label>
                                            <select
                                                className="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-blue-500 outline-none transition-all bg-slate-50 text-slate-700 font-medium"
                                                value={newTeamRuleset}
                                                onChange={e => setNewTeamRuleset(e.target.value)}
                                            >
                                                {Object.values(RULESETS).map(r => (
                                                    <option key={r.id} value={r.id}>{r.name}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1.5 ml-1">ID Federación (Opcional)</label>
                                            <input
                                                className="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-blue-500 outline-none transition-all bg-slate-50"
                                                placeholder="Ej: 4793"
                                                value={newTeamFederationId}
                                                onChange={e => setNewTeamFederationId(e.target.value)}
                                            />
                                            <p className="text-[10px] text-slate-400 mt-1 ml-1">Encuentra el ID en la web de FBCV para sincronizar partidos</p>
                                        </div>
                                        <button
                                            type="submit"
                                            className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all mt-2"
                                        >
                                            Crear Equipo
                                        </button>
                                    </div>
                                </form>
                            </div>
                        )}

                        <div className="space-y-4">
                            {displayedTeams.length === 0 ? (
                                <div className="text-center py-12 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                                    <div className="bg-white w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-sm">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="layout-grid" class="w-8 h-8 text-slate-300"></i>' }}></span>
                                    </div>
                                    <h3 className="text-slate-900 font-bold text-lg mb-1">{showArchived ? 'No hay equipos archivados' : 'No tienes equipos'}</h3>
                                    <p className="text-slate-500 text-sm max-w-[200px] mx-auto">{showArchived ? 'Tus equipos antiguos aparecerán aquí.' : 'Añade tu primer equipo para empezar a gestionar partidos.'}</p>
                                </div>
                            ) : (
                                <div className="grid gap-4">
                                    {displayedTeams.map(team => {
                                        const teamMatches = (matches || []).filter(m => m.teamId === team.id);
                                        const nextMatch = teamMatches
                                            .filter(m => m.state !== 'finished' && new Date(m.date + 'T' + (m.time || '00:00')) >= new Date())
                                            .sort((a, b) => new Date(a.date + 'T' + (a.time || '00:00')) - new Date(b.date + 'T' + (b.time || '00:00')))[0];

                                        return (
                                            <div
                                                key={team.id}
                                                onClick={() => navigate('team-detail', team.id)}
                                                className="group bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-lg transition-all cursor-pointer overflow-hidden transform hover:-translate-y-1 relative"
                                            >
                                                <div className="p-5">
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div>
                                                            <h3 className="text-xl font-extrabold text-slate-800 tracking-tight group-hover:text-blue-600 transition-colors">
                                                                {team.name}
                                                            </h3>
                                                            <p className="text-xs text-slate-400 font-medium">
                                                                {team.players?.length || 0} Jugadores
                                                            </p>
                                                        </div>
                                                        <div className="w-10 h-10 bg-slate-50 rounded-full flex items-center justify-center text-slate-300 group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">
                                                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-right" class="w-5 h-5"></i>' }}></span>
                                                        </div>
                                                    </div>

                                                    {nextMatch ? (
                                                        <div className="bg-slate-50 rounded-xl p-3 border border-slate-100 group-hover:border-blue-100 transition-colors">
                                                            <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2 flex items-center gap-1.5">
                                                                <span className="w-1.5 h-1.5 rounded-full bg-blue-500 animate-pulse"></span>
                                                                Próximo Partido
                                                            </p>
                                                            <div className="flex justify-between items-center">
                                                                <div>
                                                                    <p className="font-bold text-slate-800 text-sm mb-0.5">vs {nextMatch.opponent}</p>
                                                                    <p className="text-[11px] text-slate-500 capitalize">
                                                                        {new Date(nextMatch.date).toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' })}
                                                                        {nextMatch.time ? ` • ${nextMatch.time}h` : ''}
                                                                    </p>
                                                                </div>
                                                                <span className={`text-[10px] px-2 py-1 rounded-md font-bold ${nextMatch.isHome ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}`}>
                                                                    {nextMatch.isHome ? 'CASA' : 'FUERA'}
                                                                </span>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="bg-slate-50 rounded-xl p-3 border border-slate-100 flex items-center gap-3 opacity-60">
                                                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="calendar-x" class="w-5 h-5 text-slate-300"></i>' }}></span>
                                                            <span className="text-xs text-slate-400 font-medium">Sin partidos próximos</span>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}

                            {archivedTeams.length > 0 && (
                                <div className="pt-8 flex justify-center">
                                    <button
                                        onClick={() => setShowArchived(!showArchived)}
                                        className="text-xs font-bold text-slate-400 hover:text-slate-600 flex items-center gap-2 px-4 py-2 rounded-full hover:bg-slate-100 transition-colors"
                                    >
                                        <span dangerouslySetInnerHTML={{ __html: `<i data-lucide="${showArchived ? 'eye-off' : 'archive'}" class="w-4 h-4"></i>` }}></span>
                                        {showArchived ? 'Ocultar Archivados' : `Ver Archivados (${archivedTeams.length})`}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const MatchSetupView = ({ team, navigate, addDoc, collection, db }) => {
            useEffect(() => {
                if (!team) navigate('teams-list');
            }, [team]);

            if (!team) return null;
            const [opponent, setOpponent] = useState('');
            const [matchDate, setMatchDate] = useState(new Date().toISOString().split('T')[0]);
            const [matchTime, setMatchTime] = useState('');
            const [matchDay, setMatchDay] = useState('');
            const [rulesetId, setRulesetId] = useState(team?.rulesetId || DEFAULT_RULESET);
            const [isHome, setIsHome] = useState(true);
            const [observations, setObservations] = useState('');
            const [selectedPlayers, setSelectedPlayers] = useState([]);
            const [callTime, setCallTime] = useState('');
            const [location, setLocation] = useState('');

            // New fields Phase 11
            const [departureTime, setDepartureTime] = useState('');
            const [departureLocation, setDepartureLocation] = useState('');
            const [transportType, setTransportType] = useState('bus');
            const [arrivalTime, setArrivalTime] = useState('');

            const players = team?.players || [];

            // Auto-set call time to 1 hour before match time for home games
            useEffect(() => {
                if (isHome && matchTime && !callTime) {
                    const [h, m] = matchTime.split(':').map(Number);
                    const callDate = new Date();
                    callDate.setHours(h - 1, m);
                    setCallTime(callDate.toTimeString().substring(0, 5));
                }
            }, [matchTime]);

            const togglePlayer = (playerId) => {
                setSelectedPlayers(prev =>
                    prev.includes(playerId) ? prev.filter(id => id !== playerId) : [...prev, playerId]
                );
            };

            const createMatch = async () => {
                if (!opponent.trim() || selectedPlayers.length === 0) {
                    alert('Debes ingresar un rival y seleccionar al menos un jugador.');
                    return;
                }
                const fullPlayers = players.filter(p => selectedPlayers.includes(p.id));
                const newMatch = {
                    teamId: team.id,
                    opponent,
                    date: matchDate,
                    time: matchTime,
                    callTime,
                    location,
                    matchDay,
                    isHome,
                    observations,
                    players: fullPlayers,
                    currentPeriod: 1,
                    state: 'active',
                    history: {},
                    injuries: [],
                    score: { local: 0, visitor: 0 },
                    rulesetId: rulesetId,
                    ownerId: window.auth.currentUser.uid,
                    createdAt: new Date().toISOString(),
                    departureTime: !isHome ? departureTime : '',
                    departureLocation: !isHome ? departureLocation : '',
                    transportType: !isHome ? transportType : '',
                    arrivalTime: !isHome ? arrivalTime : ''
                };
                const docRef = await addDoc(collection(db, 'matches'), newMatch);
                navigate('active-match', team.id, docRef.id);
            };

            useEffect(() => {
                lucide.createIcons();
            }, []);

            return (
                <div className="p-4 max-w-md mx-auto">
                    <header className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigate('team-detail', team.id)} className="p-2 -ml-2 text-slate-400 hover:text-slate-800 transition-colors"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span></button>
                        <h1 className="text-2xl font-bold text-slate-800">Nuevo Partido</h1>
                    </header>
                    <div className="space-y-4 mb-6">
                        <input className="w-full p-3 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all shadow-sm" placeholder="Rival" value={opponent} onChange={e => setOpponent(e.target.value)} />

                        <div className="grid grid-cols-2 gap-3">
                            <div className="space-y-1">
                                <label className="block text-[10px] font-bold text-slate-400 uppercase ml-1">Fecha</label>
                                <input type="date" className="w-full p-2.5 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all bg-white shadow-sm" value={matchDate} onChange={e => setMatchDate(e.target.value)} />
                            </div>
                            <div className="space-y-1">
                                <label className="block text-[10px] font-bold text-slate-400 uppercase ml-1">Hora Inicio</label>
                                <input type="time" className="w-full p-2.5 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all bg-white shadow-sm" value={matchTime} onChange={e => setMatchTime(e.target.value)} />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <div className="space-y-1">
                                <label className="block text-[10px] font-bold text-slate-400 uppercase ml-1">Convocatoria</label>
                                <input type="time" className="w-full p-2.5 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all bg-white shadow-sm" value={callTime} onChange={e => setCallTime(e.target.value)} />
                            </div>
                            <div className="space-y-1">
                                <label className="block text-[10px] font-bold text-slate-400 uppercase ml-1">Jornada</label>
                                <input className="w-full p-2.5 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all bg-white shadow-sm" placeholder="J1, J2..." value={matchDay} onChange={e => setMatchDay(e.target.value)} />
                            </div>
                        </div>

                        <input className="w-full p-3 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all shadow-sm" placeholder={isHome ? "📍 Lugar (por defecto: Local)" : "📍 Lugar (por defecto: Visitante)"} value={location} onChange={e => setLocation(e.target.value)} />

                        <div className="flex bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setIsHome(true)} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${isHome ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>LOCAL</button>
                            <button onClick={() => setIsHome(false)} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${!isHome ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>VISITANTE</button>
                        </div>

                        {!isHome && (
                            <div className="bg-blue-50/50 p-4 rounded-xl border border-blue-100 space-y-3 animate-in fade-in slide-in-from-top-2 duration-300">
                                <p className="text-[10px] font-extrabold text-blue-600 uppercase tracking-widest flex items-center gap-2">
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="truck" class="w-3 h-3"></i>' }}></span> Desplazamiento
                                </p>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="space-y-1">
                                        <label className="block text-[10px] font-bold text-blue-400 uppercase ml-1">Hora Salida</label>
                                        <input type="time" className="w-full p-2.5 border border-blue-200 rounded-lg focus:border-blue-500 outline-none transition-all bg-white text-sm" value={departureTime} onChange={e => setDepartureTime(e.target.value)} />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="block text-[10px] font-bold text-blue-400 uppercase ml-1">Transporte</label>
                                        <div className="flex bg-white border border-blue-200 rounded-lg p-0.5">
                                            <button onClick={() => setTransportType('bus')} className={`flex-1 py-1.5 rounded-md flex items-center justify-center gap-1 transition-all ${transportType === 'bus' ? 'bg-blue-600 text-white shadow-sm' : 'text-blue-400 hover:bg-blue-50'}`}>
                                                <span className="text-sm">🚌</span>
                                            </button>
                                            <button onClick={() => setTransportType('car')} className={`flex-1 py-1.5 rounded-md flex items-center justify-center gap-1 transition-all ${transportType === 'car' ? 'bg-blue-600 text-white shadow-sm' : 'text-blue-400 hover:bg-blue-50'}`}>
                                                <span className="text-sm">🚗</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="space-y-1">
                                        <label className="block text-[10px] font-bold text-blue-400 uppercase ml-1">Lugar Salida</label>
                                        <input className="w-full p-2.5 border border-blue-200 rounded-lg focus:border-blue-500 outline-none transition-all bg-white text-sm" placeholder="Pabellón..." value={departureLocation} onChange={e => setDepartureLocation(e.target.value)} />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="block text-[10px] font-bold text-blue-400 uppercase ml-1">Hora Llegada</label>
                                        <input type="time" className="w-full p-2.5 border border-blue-200 rounded-lg focus:border-blue-500 outline-none transition-all bg-white text-sm" value={arrivalTime} onChange={e => setArrivalTime(e.target.value)} />
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                            <p className="text-[10px] font-extrabold text-emerald-600 uppercase tracking-widest mb-1 flex items-center gap-2">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="share-2" class="w-3 h-3"></i>' }}></span> Copiar Convocatoria
                            </p>
                            <p className="text-[10px] text-emerald-600/70 mb-3">Copia el mensaje para compartirlo con los padres por WhatsApp</p>
                            <div className="grid grid-cols-2 gap-2">
                                <button
                                    onClick={() => copyToClipboard(generateConvocatoria({ opponent, date: matchDate, time: matchTime, callTime, location, isHome, departureTime, departureLocation, transportType, arrivalTime }, team, 'val'))}
                                    className="bg-white border border-emerald-200 text-emerald-700 py-2.5 rounded-lg font-bold text-xs hover:bg-emerald-100 transition-all flex items-center justify-center gap-1.5 shadow-sm active:scale-95"
                                >
                                    Valencià
                                </button>
                                <button
                                    onClick={() => copyToClipboard(generateConvocatoria({ opponent, date: matchDate, time: matchTime, callTime, location, isHome, departureTime, departureLocation, transportType, arrivalTime }, team, 'cas'))}
                                    className="bg-white border border-emerald-200 text-emerald-700 py-2.5 rounded-lg font-bold text-xs hover:bg-emerald-100 transition-all flex items-center justify-center gap-1.5 shadow-sm active:scale-95"
                                >
                                    Castellano
                                </button>
                            </div>
                        </div>

                        <div className="space-y-1">
                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Reglamento</label>
                            <select
                                className="w-full p-3 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all bg-white text-slate-700 font-medium shadow-sm"
                                value={rulesetId}
                                onChange={e => setRulesetId(e.target.value)}
                            >
                                {Object.values(RULESETS).map(r => (
                                    <option key={r.id} value={r.id}>{r.name}</option>
                                ))}
                            </select>
                        </div>

                        <textarea className="w-full p-3 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all bg-white shadow-sm" placeholder="Observaciones (opcional)" rows="2" value={observations} onChange={e => setObservations(e.target.value)}></textarea>

                        <div className="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
                            <p className="text-[10px] font-extrabold text-emerald-600 uppercase tracking-widest mb-3 flex items-center gap-2">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="share-2" class="w-3 h-3"></i>' }}></span> Copiar Convocatoria
                            </p>
                            <div className="grid grid-cols-2 gap-2">
                                <button
                                    onClick={() => copyToClipboard(generateConvocatoria({ opponent, date: matchDate, time: matchTime, callTime, location }, team, 'val'))}
                                    className="bg-white border border-emerald-200 text-emerald-700 py-2.5 rounded-lg font-bold text-xs hover:bg-emerald-100 transition-all flex items-center justify-center gap-1.5 shadow-sm active:scale-95"
                                >
                                    Valencià
                                </button>
                                <button
                                    onClick={() => copyToClipboard(generateConvocatoria({ opponent, date: matchDate, time: matchTime, callTime, location }, team, 'cas'))}
                                    className="bg-white border border-emerald-200 text-emerald-700 py-2.5 rounded-lg font-bold text-xs hover:bg-emerald-100 transition-all flex items-center justify-center gap-1.5 shadow-sm active:scale-95"
                                >
                                    Castellano
                                </button>
                            </div>
                        </div>
                    </div>

                    <h3 className="font-bold text-slate-800 mb-2 ml-1">Seleccionar Jugadores ({selectedPlayers.length})</h3>
                    <div className="space-y-2 mb-6 max-h-[300px] overflow-y-auto pr-2 no-scrollbar">
                        {players.map(p => (
                            <button
                                key={p.id}
                                onClick={() => togglePlayer(p.id)}
                                className={`w-full p-3 rounded-xl border flex items-center justify-between transition-all ${selectedPlayers.includes(p.id) ? 'bg-blue-50 border-blue-500 ring-1 ring-blue-500' : 'bg-white border-slate-200 hover:border-slate-300'}`}
                            >
                                <span className="font-bold text-slate-700">#{p.number} {p.name}</span>
                                {selectedPlayers.includes(p.id) ? (
                                    <span className="bg-blue-500 text-white rounded-full p-1"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="check" class="w-3 h-3"></i>' }}></span></span>
                                ) : (
                                    <div className="w-5 h-5 rounded-full border-2 border-slate-100"></div>
                                )}
                            </button>
                        ))}
                    </div>
                    <button onClick={createMatch} className="w-full bg-slate-900 text-white p-4 rounded-xl font-extrabold shadow-xl active:scale-[0.98] transition-all flex items-center justify-center gap-2">
                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="play" class="w-5 h-5 fill-white"></i>' }}></span> Empezar Partido
                    </button>
                </div>
            );
        };

        const EditMatchView = ({ match, updateMatchInDb, navigate, team, deleteDoc, doc, db }) => {
            useEffect(() => {
                if (!match || !team) navigate('teams-list');
                if (window.lucide) window.lucide.createIcons();
            }, [match, team]);

            if (!match || !team) return null;

            const [opponent, setOpponent] = useState(match.opponent || '');
            const [matchDate, setMatchDate] = useState(match.date || '');
            const [matchTime, setMatchTime] = useState(match.time || '');
            const [location, setLocation] = useState(match.location || '');
            const [isHome, setIsHome] = useState(match.isHome === false ? false : true);
            const [departureTime, setDepartureTime] = useState(match.departureTime || '');
            const [departureLocation, setDepartureLocation] = useState(match.departureLocation || '');
            const [transportType, setTransportType] = useState(match.transportType || 'car');
            const [arrivalTime, setArrivalTime] = useState(match.arrivalTime || '');
            const [callTime, setCallTime] = useState(match.callTime || '');
            const [matchDay, setMatchDay] = useState(match.matchDay || '');
            const [observations, setObservations] = useState(match.observations || '');

            const handleUpdate = async () => {
                if (!opponent.trim()) return alert('Rival es obligatorio');
                await updateMatchInDb(match.id, {
                    opponent, date: matchDate, time: matchTime, location, isHome,
                    departureTime, departureLocation, transportType, arrivalTime,
                    callTime, matchDay, observations
                });
                alert('Partido actualizado');
                navigate('active-match', team.id, match.id);
            };

            const handleDelete = async () => {
                if (!confirm('¿Eliminar partido?')) return;
                await deleteDoc(doc(db, 'matches', match.id));
                navigate('team-detail', team.id);
            };

            return (
                <div className="p-4 max-w-md mx-auto">
                    <header className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigate('active-match', team.id, match.id)} className="p-2 -ml-2 text-slate-400 hover:text-slate-800 transition-colors"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span></button>
                        <h1 className="text-2xl font-bold text-slate-800">Editar Partido</h1>
                    </header>
                    <div className="space-y-4 mb-6">
                        <input className="w-full p-3 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all shadow-sm" placeholder="Rival" value={opponent} onChange={e => setOpponent(e.target.value)} />

                        <div className="grid grid-cols-2 gap-3">
                            <div className="space-y-1">
                                <label className="block text-[10px] font-bold text-slate-400 uppercase ml-1">Fecha</label>
                                <input type="date" className="w-full p-2.5 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all bg-white shadow-sm" value={matchDate} onChange={e => setMatchDate(e.target.value)} />
                            </div>
                            <div className="space-y-1">
                                <label className="block text-[10px] font-bold text-slate-400 uppercase ml-1">Hora Inicio</label>
                                <input type="time" className="w-full p-2.5 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all bg-white shadow-sm" value={matchTime} onChange={e => setMatchTime(e.target.value)} />
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-3">
                            <div className="space-y-1">
                                <label className="block text-[10px] font-bold text-slate-400 uppercase ml-1">Convocatoria</label>
                                <input type="time" className="w-full p-2.5 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all bg-white shadow-sm" value={callTime} onChange={e => setCallTime(e.target.value)} />
                            </div>
                            <div className="space-y-1">
                                <label className="block text-[10px] font-bold text-slate-400 uppercase ml-1">Jornada</label>
                                <input className="w-full p-2.5 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all bg-white shadow-sm" placeholder="J1, J2..." value={matchDay} onChange={e => setMatchDay(e.target.value)} />
                            </div>
                        </div>

                        <input className="w-full p-3 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all shadow-sm" placeholder={isHome ? "📍 Lugar (por defecto: Local)" : "📍 Lugar (por defecto: Visitante)"} value={location} onChange={e => setLocation(e.target.value)} />

                        <div className="flex bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setIsHome(true)} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${isHome ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>LOCAL</button>
                            <button onClick={() => setIsHome(false)} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${!isHome ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500'}`}>VISITANTE</button>
                        </div>

                        {!isHome && (
                            <div className="bg-blue-50/50 p-4 rounded-xl border border-blue-100 space-y-3">
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="space-y-1">
                                        <label className="block text-[10px] font-bold text-blue-400 uppercase ml-1">Hora Salida</label>
                                        <input type="time" className="w-full p-2.5 border border-blue-200 rounded-lg focus:border-blue-500 outline-none transition-all bg-white text-sm" value={departureTime} onChange={e => setDepartureTime(e.target.value)} />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="block text-[10px] font-bold text-blue-400 uppercase ml-1">Transporte</label>
                                        <div className="flex bg-white border border-blue-200 rounded-lg p-0.5">
                                            <button onClick={() => setTransportType('bus')} className={`flex-1 py-1.5 rounded-md flex items-center justify-center gap-1 transition-all ${transportType === 'bus' ? 'bg-blue-600 text-white shadow-sm' : 'text-blue-400 hover:bg-blue-50'}`}>
                                                <span className="text-sm">🚌</span>
                                            </button>
                                            <button onClick={() => setTransportType('car')} className={`flex-1 py-1.5 rounded-md flex items-center justify-center gap-1 transition-all ${transportType === 'car' ? 'bg-blue-600 text-white shadow-sm' : 'text-blue-400 hover:bg-blue-50'}`}>
                                                <span className="text-sm">🚗</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="space-y-1">
                                        <label className="block text-[10px] font-bold text-blue-400 uppercase ml-1">Lugar Salida</label>
                                        <input className="w-full p-2.5 border border-blue-200 rounded-lg focus:border-blue-500 outline-none transition-all bg-white text-sm" placeholder="Pabellón..." value={departureLocation} onChange={e => setDepartureLocation(e.target.value)} />
                                    </div>
                                    <div className="space-y-1">
                                        <label className="block text-[10px] font-bold text-blue-400 uppercase ml-1">Hora Llegada</label>
                                        <input type="time" className="w-full p-2.5 border border-blue-200 rounded-lg focus:border-blue-500 outline-none transition-all bg-white text-sm" value={arrivalTime} onChange={e => setArrivalTime(e.target.value)} />
                                    </div>
                                </div>
                            </div>
                        )}

                        <textarea className="w-full p-3 border border-slate-200 rounded-xl focus:border-blue-500 outline-none transition-all bg-white shadow-sm" placeholder="Observaciones" rows="2" value={observations} onChange={e => setObservations(e.target.value)}></textarea>

                        <button onClick={handleUpdate} className="w-full bg-slate-900 text-white p-4 rounded-xl font-extrabold shadow-xl active:scale-[0.98] transition-all">Guardar Cambios</button>
                        <button onClick={handleDelete} className="w-full bg-white border border-red-200 text-red-600 p-4 rounded-xl font-bold shadow-sm active:scale-[0.98] transition-all">Eliminar Partido</button>
                    </div>
                </div>
            );
        };

        const ManagePlayersView = ({ team, navigate, updateTeamInDb, getRoles, match, updateMatchInDb }) => {
            useEffect(() => {
                if (!team) navigate('teams-list');
            }, [team]);

            if (!team) return null;
            const rolesObj = getRoles(team);
            const rolesList = Object.entries(rolesObj).map(([id, info]) => ({ id, ...info }));
            const isFromMatch = !!match; // Detectar si venimos desde un partido

            const [newPlayerName, setNewPlayerName] = useState('');
            const [newPlayerNumber, setNewPlayerNumber] = useState('');
            const [newPlayerRole, setNewPlayerRole] = useState(rolesList[0]?.id || 'receptor');
            const [editingId, setEditingId] = useState(null);
            const [editName, setEditName] = useState('');
            const [editNumber, setEditNumber] = useState('');
            const [editRole, setEditRole] = useState('');

            const players = team.players || [];

            const addPlayer = async (e) => {
                e.preventDefault();
                if (!newPlayerName.trim() || !newPlayerNumber.trim()) return;
                const newPlayer = {
                    id: Date.now().toString(),
                    name: newPlayerName.trim(),
                    number: newPlayerNumber.trim(),
                    role: newPlayerRole
                };
                await updateTeamInDb(team.id, { players: [...players, newPlayer] });
                setNewPlayerName('');
                setNewPlayerNumber('');
            };

            const startEditing = (p) => {
                setEditingId(p.id);
                setEditName(p.name || '');
                setEditNumber(String(p.number || ''));
                setEditRole(p.role || rolesList[0]?.id || 'receptor');
            };

            const saveEdit = async () => {
                if (!editName.trim() || !String(editNumber).trim()) return;
                const updatedPlayers = players.map(p =>
                    p.id === editingId ? { ...p, name: editName.trim(), number: String(editNumber).trim(), role: editRole } : p
                );
                await updateTeamInDb(team.id, { players: updatedPlayers });
                setEditingId(null);
            };

            const deletePlayer = async (playerId) => {
                if (!confirm('¿Seguro que quieres eliminar este jugador?')) return;
                await updateTeamInDb(team.id, { players: players.filter(p => p.id !== playerId) });
            };

            useEffect(() => {
                lucide.createIcons();
            }, [editingId, players.length]);

            return (
                <div className="p-4 max-w-md mx-auto">
                    <header className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigate('team-detail', team.id)} className="p-2 -ml-2 transition-colors hover:bg-slate-100 rounded-lg">
                            <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span>
                        </button>
                        <h1 className="text-2xl font-bold text-slate-800">Gestionar Jugadores</h1>
                    </header>

                    {!editingId && (
                        <form onSubmit={addPlayer} className="mb-6 space-y-2 bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            <div className="flex gap-2">
                                <input className="flex-1 p-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:bg-white transition-colors" placeholder="Nombre del jugador" value={newPlayerName} onChange={e => setNewPlayerName(e.target.value)} />
                                <input className="w-20 p-2 border border-slate-200 rounded-lg text-sm bg-slate-50 focus:bg-white transition-colors text-center" placeholder="Nº" value={newPlayerNumber} onChange={e => setNewPlayerNumber(e.target.value)} />
                            </div>
                            <div className="flex flex-wrap gap-2 pt-1">
                                {rolesList.map(r => (
                                    <button
                                        key={r.id}
                                        type="button"
                                        onClick={() => setNewPlayerRole(r.id)}
                                        className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all border ${newPlayerRole === r.id ? `${r.bg} ${r.color} border-current ring-1 ring-current` : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}`}
                                    >
                                        {r.label || r.name}
                                    </button>
                                ))}
                            </div>
                            <div className="flex gap-2">
                                <button className="flex-1 bg-slate-800 hover:bg-slate-900 text-white p-2 rounded-lg font-bold text-sm transition-colors flex items-center justify-center gap-2">
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="plus" class="w-4 h-4"></i>' }}></span> Añadir Jugador
                                </button>
                                {isFromMatch && (
                                    <button
                                        type="button"
                                        onClick={async () => {
                                            const currentPlayerIds = (team.players || []).map(p => p.id);
                                            const matchPlayerIds = match?.players?.map(p => p.id) || [];
                                            const availablePlayers = (team.players || []).filter(p => !matchPlayerIds.includes(p.id));
                                            if (availablePlayers.length === 0) {
                                                alert('No hay jugadores disponibles para añadir.');
                                                return;
                                            }
                                            if (!confirm(`¿Añadir ${availablePlayers.length} jugador(es) al partido?`)) return;
                                            const updatedPlayers = [...(match.players || []), ...availablePlayers];
                                            await updateMatchInDb(match.id, { players: updatedPlayers });
                                            navigate('active-match', team.id, match.id);
                                        }}
                                        className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 p-2 rounded-lg font-bold text-sm transition-colors flex items-center justify-center gap-2"
                                    >
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="users-plus" class="w-4 h-4"></i>' }}></span> Añadir Todos
                                    </button>
                                )}
                            </div>
                        </form>
                    )}

                    <div className="space-y-3">
                        {players.map(p => (
                            <div key={p.id} className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                                {editingId === p.id ? (
                                    <div className="space-y-3">
                                        <div className="flex gap-2">
                                            <input className="flex-1 p-2 border border-slate-200 rounded-lg text-sm font-bold bg-blue-50" value={editName} onChange={e => setEditName(e.target.value)} />
                                            <input className="w-16 p-2 border border-slate-200 rounded-lg text-sm font-bold text-center bg-blue-50" value={editNumber} onChange={e => setEditNumber(e.target.value)} />
                                        </div>
                                        <div className="flex flex-wrap gap-2">
                                            {rolesList.map(r => (
                                                <button
                                                    key={r.id}
                                                    type="button"
                                                    onClick={() => setEditRole(r.id)}
                                                    className={`px-3 py-1.5 rounded-full text-xs font-bold transition-all border ${editRole === r.id ? `${r.bg} ${r.color} border-current ring-1 ring-current` : 'bg-white text-slate-400 border-slate-200 hover:border-slate-300'}`}
                                                >
                                                    {r.label || r.name}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={saveEdit} className="flex-1 bg-blue-600 text-white p-2 rounded-lg text-sm font-bold">Guardar</button>
                                            <button onClick={() => setEditingId(null)} className="flex-1 bg-slate-100 text-slate-600 p-2 rounded-lg text-sm font-bold">Cancelar</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <span className="w-9 h-9 flex items-center justify-center bg-slate-100 rounded-full text-slate-700 font-bold text-sm">{p.number}</span>
                                            <div className="flex flex-col">
                                                <span className="font-bold text-slate-800 leading-none">{p.name}</span>
                                                {p.role && rolesObj[p.role] && (
                                                    <span className={`text-[10px] font-bold uppercase mt-1 ${rolesObj[p.role].color}`}>{rolesObj[p.role].label || rolesObj[p.role].name}</span>
                                                )}
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <button onClick={() => startEditing(p)} className="p-2 text-slate-400 hover:text-blue-600">
                                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="edit-2" class="w-4 h-4"></i>' }}></span>
                                            </button>
                                            <button onClick={() => deletePlayer(p.id)} className="p-2 text-slate-400 hover:text-red-500">
                                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="trash-2" class="w-4 h-4"></i>' }}></span>
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ManageRolesView = ({ team, navigate, updateTeamInDb, getRoles }) => {
            if (!team) { useEffect(() => navigate('teams-list'), []); return null; }
            const [newRoleName, setNewRoleName] = useState('');
            const [newRoleColor, setNewRoleColor] = useState('blue');
            const [editingRoleId, setEditingRoleId] = useState(null);
            const [editRoleName, setEditRoleName] = useState('');
            const [editRoleColor, setEditRoleColor] = useState('blue');

            const roles = getRoles(team);
            const rolesList = Object.entries(roles).map(([id, info]) => ({
                id,
                name: info.label || info.name,
                color: info.color?.replace('text-', '').replace('-600', '') || info.color || 'slate'
            }));

            const addRole = async (e) => {
                e.preventDefault();
                if (!newRoleName.trim()) return;
                const newRoleId = Date.now().toString();
                const updatedRoles = {
                    ...roles,
                    [newRoleId]: {
                        label: newRoleName.trim(),
                        color: `text-${newRoleColor}-600`,
                        bg: `bg-${newRoleColor}-50`,
                        order: rolesList.length + 1
                    }
                };
                await updateTeamInDb(team.id, { roles: updatedRoles });
                setNewRoleName('');
            };

            const startEditingRole = (r) => {
                setEditingRoleId(r.id);
                setEditRoleName(r.name);
                setEditRoleColor(r.color);
            };

            const saveRoleEdit = async () => {
                if (!editRoleName.trim()) return;
                const updatedRoles = {
                    ...roles,
                    [editingRoleId]: {
                        ...roles[editingRoleId],
                        label: editRoleName.trim(),
                        color: `text-${editRoleColor}-600`,
                        bg: `bg-${editRoleColor}-50`
                    }
                };
                await updateTeamInDb(team.id, { roles: updatedRoles });
                setEditingRoleId(null);
            };

            const deleteRole = async (roleId) => {
                if (!confirm('¿Seguro?')) return;
                const newRoles = { ...roles };
                delete newRoles[roleId];
                await updateTeamInDb(team.id, { roles: newRoles });
            };

            useEffect(() => {
                lucide.createIcons();
            }, [editingRoleId, rolesList.length]);

            return (
                <div className="p-4 max-w-md mx-auto">
                    <header className="flex items-center gap-2 mb-6">
                        <button onClick={() => navigate('team-detail', team.id)} className="p-2 -ml-2"><span dangerouslySetInnerHTML={{ __html: '<i data-lucide="chevron-left"></i>' }}></span></button>
                        <h1 className="text-2xl font-bold">Configurar Roles</h1>
                    </header>
                    {!editingRoleId && (
                        <form onSubmit={addRole} className="mb-6 space-y-3 bg-white p-3 rounded-xl border border-slate-200">
                            <input className="w-full p-2 border rounded-lg text-sm" placeholder="Nombre del Rol" value={newRoleName} onChange={e => setNewRoleName(e.target.value)} />
                            <div className="flex flex-wrap gap-2 p-1 bg-slate-50 rounded-lg">
                                {['blue', 'red', 'green', 'orange', 'purple', 'pink', 'slate', 'yellow', 'cyan'].map(color => (
                                    <button key={color} type="button" onClick={() => setNewRoleColor(color)} className={`w-6 h-6 rounded-full bg-${color}-500 border-2 ${newRoleColor === color ? 'border-slate-800 scale-110' : 'border-transparent'}`}></button>
                                ))}
                            </div>
                            <button className="w-full bg-slate-800 text-white p-2 rounded-lg font-bold text-sm">+ Añadir Rol</button>
                        </form>
                    )}
                    <div className="space-y-2">
                        {rolesList.map(r => (
                            <div key={r.id} className="bg-white p-3 rounded-lg border border-slate-200 shadow-sm">
                                {editingRoleId === r.id ? (
                                    <div className="space-y-3">
                                        <input className="w-full p-2 border rounded-lg text-sm font-bold" value={editRoleName} onChange={e => setEditRoleName(e.target.value)} />
                                        <div className="flex flex-wrap gap-2 p-1 bg-slate-50 rounded-lg">
                                            {['blue', 'red', 'green', 'orange', 'purple', 'pink', 'slate', 'yellow', 'cyan'].map(color => (
                                                <button key={color} type="button" onClick={() => setEditRoleColor(color)} className={`w-6 h-6 rounded-full bg-${color}-500 border-2 ${editRoleColor === color ? 'border-slate-800 scale-110' : 'border-transparent'}`}></button>
                                            ))}
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={saveRoleEdit} className="flex-1 bg-green-600 text-white p-2 rounded-lg text-sm font-bold">Guardar</button>
                                            <button onClick={() => setEditingRoleId(null)} className="flex-1 bg-slate-100 text-slate-600 p-2 rounded-lg text-sm font-bold">Cancelar</button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex justify-between items-center">
                                        <div className="flex items-center gap-3">
                                            <div className={`w-3 h-3 rounded-full bg-${r.color}-500`}></div>
                                            <span className="font-bold text-slate-800">{r.name}</span>
                                        </div>
                                        <div className="flex gap-1">
                                            <button onClick={() => startEditingRole(r)} className="p-2 text-slate-400 hover:text-blue-600">
                                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="edit-2" class="w-4 h-4"></i>' }}></span>
                                            </button>
                                            <button onClick={() => deleteRole(r.id)} className="p-2 text-slate-400 hover:text-red-600">
                                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="trash-2" class="w-4 h-4"></i>' }}></span>
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const TeamSettingsView = ({ team, navigate, updateTeamInDb, deleteDoc, doc, db }) => {
            useEffect(() => {
                if (!team) navigate('teams-list');
            }, [team]);

            if (!team) return null;
            const [editTeamName, setEditTeamName] = useState(team.name || '');
            const [editFederationId, setEditFederationId] = useState(team.federationId || '');
            const [editRuleset, setEditRuleset] = useState(team.rulesetId || DEFAULT_RULESET);

            useEffect(() => {
                lucide.createIcons();
            }, []);

            const saveSettings = async (e) => {
                e.preventDefault();
                if (!editTeamName.trim()) return;
                await updateTeamInDb(team.id, {
                    name: editTeamName.trim(),
                    federationId: editFederationId.trim() || null,
                    rulesetId: editRuleset
                });
                alert('✅ Configuración guardada');
            };

            const archiveTeam = async () => {
                if (!confirm(`¿Estás seguro de que quieres archivar el equipo "${team.name}"? Se ocultará de la lista principal pero podrás acceder a él desde el filtro de archivados.`)) return;
                try {
                    await updateTeamInDb(team.id, { archived: true });
                    alert('Equipo archivado correctamente');
                    navigate('teams-list');
                } catch (e) {
                    console.error("Error archiving team", e);
                    alert('Error al archivar el equipo');
                }
            };

            const duplicateTeam = async () => {
                const newName = `${team.name} (Copia)`;
                if (!confirm(`¿Duplicar equipo como "${newName}"?`)) return;

                try {
                    const { addDoc, collection } = window.firebaseMethods;
                    // Create a clean copy without ID
                    const { id, ...teamData } = team;
                    const newTeam = {
                        ...teamData,
                        name: newName,
                        createdAt: new Date().toISOString(),
                        federationId: null, // Reset sync
                        archived: false,
                        season: new Date().getFullYear().toString()
                    };

                    const docRef = await addDoc(collection(db, 'teams'), newTeam);
                    alert('Equipo duplicado correctamente');
                    navigate('teams-list');
                } catch (e) {
                    console.error("Error duplicando equipo", e);
                    alert('Error al duplicar: ' + e.message);
                }
            };

            const deleteTeam = async () => {
                if (!confirm('⚠️ ¿ESTÁS SEGURO? Se eliminará el equipo y todos sus partidos. Esta acción no se puede deshacer.')) return;
                await deleteDoc(doc(db, 'teams', team.id));
                navigate('teams-list');
            };

            return (
                <div className="bg-slate-50 min-h-screen pb-20">
                    <div className="bg-white border-b border-slate-200 sticky top-0 z-10 safe-top">
                        <div className="flex items-center justify-between px-4 py-3">
                            <button onClick={() => navigate('team-detail', team.id)} className="p-2 -ml-2 text-slate-400 hover:text-slate-600">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="arrow-left" class="w-6 h-6"></i>' }}></span>
                            </button>
                            <h1 className="text-lg font-bold text-slate-800">Ajustes del Equipo</h1>
                            <div className="w-10"></div>
                        </div>
                    </div>

                    <div className="p-4 space-y-6 max-w-lg mx-auto">
                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                            <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="settings" class="w-5 h-5 text-blue-600"></i>' }}></span>
                                Configuración General
                            </h2>
                            <form onSubmit={saveSettings} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1.5">Nombre del Equipo</label>
                                    <input
                                        value={editTeamName}
                                        onChange={e => setEditTeamName(e.target.value)}
                                        className="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-blue-500 outline-none transition-all font-bold text-slate-700"
                                    />
                                </div>
                                <button
                                    type="submit"
                                    className="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-200 hover:bg-blue-700 active:scale-95 transition-all"
                                >
                                    Guardar Cambios
                                </button>
                            </form>
                        </div>

                        <div className="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                            <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="calendar-range" class="w-5 h-5 text-indigo-600"></i>' }}></span>
                                Gestión de Temporada
                            </h2>
                            <p className="text-sm text-slate-500 mb-6">Gestiona el ciclo de vida de tu equipo. Archiva temporadas pasadas o comienza una nueva.</p>

                            <div className="space-y-3">
                                <button
                                    onClick={duplicateTeam}
                                    className="w-full py-3 bg-indigo-50 text-indigo-700 border border-indigo-100 rounded-xl font-bold hover:bg-indigo-100 transition-all flex items-center justify-center gap-2"
                                >
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="copy" class="w-4 h-4"></i>' }}></span>
                                    Nueva Temporada (Duplicar)
                                </button>

                                <button
                                    onClick={archiveTeam}
                                    className="w-full py-3 bg-slate-50 text-slate-600 border border-slate-200 rounded-xl font-bold hover:bg-slate-100 transition-all flex items-center justify-center gap-2"
                                >
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="archive" class="w-4 h-4"></i>' }}></span>
                                    Archivar Equipo
                                </button>
                            </div>
                        </div>

                        <div className="bg-red-50 p-5 rounded-2xl border border-red-100">
                            <h2 className="font-bold text-red-900 mb-2 flex items-center gap-2">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="alert-triangle" class="w-5 h-5"></i>' }}></span>
                                Zona de Peligro
                            </h2>

                            <div className="space-y-6">
                                {/* Accesos Directos */}
                                <div className="grid grid-cols-2 gap-3">
                                    <button onClick={() => navigate('manage-players', team.id)} className="p-4 bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-all flex flex-col items-center gap-2">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="users" class="w-6 h-6 text-blue-600"></i>' }}></span>
                                        <span className="font-bold text-sm text-slate-700">Jugadores</span>
                                    </button>
                                    <button onClick={() => navigate('manage-roles', team.id)} className="p-4 bg-white border border-slate-200 rounded-xl shadow-sm hover:shadow-md transition-all flex flex-col items-center gap-2">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="shield" class="w-6 h-6 text-amber-600"></i>' }}></span>
                                        <span className="font-bold text-sm text-slate-700">Roles / Posiciones</span>
                                    </button>
                                </div>

                                {/* Formulario Configuración */}
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="sliders" class="w-4 h-4"></i>' }}></span> General
                                    </h3>
                                    <form onSubmit={saveSettings} className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1.5 ml-1">Nombre</label>
                                            <input className="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-blue-500 outline-none transition-all bg-slate-50" value={editTeamName} onChange={e => setEditTeamName(e.target.value)} required />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1.5 ml-1">ID Federación</label>
                                            <input id="tutorial-fed-id" className="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-blue-500 outline-none transition-all bg-slate-50" value={editFederationId} onChange={e => setEditFederationId(e.target.value)} placeholder="Opcional" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-1.5 ml-1">Reglamento</label>
                                            <select className="w-full p-3 border-2 border-slate-100 rounded-xl focus:border-blue-500 outline-none transition-all bg-slate-50" value={editRuleset} onChange={e => setEditRuleset(e.target.value)}>
                                                {Object.values(RULESETS).map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                            </select>
                                        </div>
                                        <button type="submit" className="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition-all">Guardar Cambios</button>
                                    </form>
                                </div>

                                {/* Zona de Peligro */}
                                <div className="bg-red-50 p-4 rounded-xl border border-red-100">
                                    <h3 className="font-bold text-red-900 mb-2 flex items-center gap-2">
                                        <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="alert-triangle" class="w-4 h-4"></i>' }}></span> Zona de Peligro
                                    </h3>
                                    <p className="text-xs text-red-700/70 mb-4">Eliminar el equipo borrará permanentemente todos sus partidos y estadísticas.</p>
                                    <button onClick={deleteTeam} className="w-full py-3 bg-white border border-red-200 text-red-600 rounded-xl font-bold hover:bg-red-100 transition-all">Eliminar Equipo</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const AuthView = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [isLogin, setIsLogin] = useState(true);
            const [error, setError] = useState('');
            const { signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup } = window.firebaseMethods;
            const auth = window.auth;

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    if (isLogin) {
                        await signInWithEmailAndPassword(auth, email, password);
                    } else {
                        await createUserWithEmailAndPassword(auth, email, password);
                    }
                } catch (err) {
                    let msg = err.message;
                    if (err.code === 'auth/invalid-credential') msg = "Credenciales inválidas";
                    if (err.code === 'auth/email-already-in-use') msg = "El email ya está en uso";
                    if (err.code === 'auth/weak-password') msg = "La contraseña es muy débil";
                    setError(msg);
                }
            };

            useEffect(() => {
                if (window.lucide) lucide.createIcons();
            }, [isLogin]);

            const handleGoogleSignIn = async () => {
                setError('');
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (err) {
                    setError(err.message);
                }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-slate-50">
                    <div className="w-full max-w-md bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden">
                        <div className="p-8">
                            <div className="flex justify-center mb-6">
                                <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg transform -rotate-6">
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="trophy" class="w-8 h-8 text-white"></i>' }}></span>
                                </div>
                            </div>
                            <h1 className="text-3xl font-bold text-center text-slate-800 mb-2">Basket Manager</h1>
                            <p className="text-center text-slate-500 mb-8">{isLogin ? 'Inicia sesión para continuar' : 'Crea tu cuenta gratuita'}</p>

                            <form onSubmit={handleSubmit} className="space-y-4">
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1 pl-1">Email</label>
                                    <input type="email" required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none" placeholder="tu@email.com" value={email} onChange={e => setEmail(e.target.value)} />
                                </div>
                                <div>
                                    <label className="block text-sm font-bold text-slate-700 mb-1 pl-1">Contraseña</label>
                                    <input type="password" required className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none" placeholder="••••••••" value={password} onChange={e => setPassword(e.target.value)} />
                                </div>

                                {error && <div className="p-3 bg-red-50 text-red-600 text-xs font-bold rounded-xl border border-red-100">{error}</div>}

                                <button type="submit" className="w-full py-4 bg-slate-800 hover:bg-slate-900 text-white rounded-xl font-bold text-lg shadow-lg transition-transform active:scale-[0.98]">
                                    {isLogin ? 'Entrar' : 'Empezar ahora'}
                                </button>
                            </form>

                            <div className="mt-4">
                                <div className="relative flex py-4 items-center">
                                    <div className="flex-grow border-t border-slate-200"></div>
                                    <span className="flex-shrink mx-4 text-slate-400 text-xs font-bold uppercase tracking-widest">O</span>
                                    <div className="flex-grow border-t border-slate-200"></div>
                                </div>

                                <button
                                    onClick={handleGoogleSignIn}
                                    className="w-full py-3 bg-white border border-slate-200 hover:bg-slate-50 text-slate-700 rounded-xl font-bold flex items-center justify-center gap-3 transition-all shadow-sm active:scale-[0.98]"
                                >
                                    <svg className="w-5 h-5" viewBox="0 0 24 24">
                                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
                                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
                                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" />
                                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
                                    </svg>
                                    Continuar con Google
                                </button>
                            </div>

                            <div className="mt-8 text-center pt-6 border-t border-slate-100 flex flex-col items-center gap-2">
                                <p className="text-sm text-slate-500">
                                    {isLogin ? '¿No tienes cuenta?' : '¿Ya eres usuario?'}
                                    <button onClick={() => setIsLogin(!isLogin)} className="ml-2 text-blue-600 font-bold hover:underline">
                                        {isLogin ? 'Regístrate aquí' : 'Inicia sesión'}
                                    </button>
                                </p>
                                <span className="text-[10px] font-bold text-slate-300 uppercase tracking-widest mt-2">v{APP_VERSION}</span>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TutorialOverlay = ({ steps, currentStepIndex, onNext, onSkip }) => {
            const [targetRect, setTargetRect] = useState(null);
            const step = steps[currentStepIndex];

            useEffect(() => {
                if (window.lucide) window.lucide.createIcons();
                const updatePosition = () => {
                    if (step.target) {
                        const element = document.querySelector(step.target);
                        if (element) {
                            const rect = element.getBoundingClientRect();
                            setTargetRect({
                                top: rect.top,
                                left: rect.left,
                                width: rect.width,
                                height: rect.height,
                            });
                            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        } else {
                            setTargetRect(null); // Fallback if element not found
                        }
                    } else {
                        setTargetRect(null); // Center modal for no target
                    }
                };

                updatePosition();
                window.addEventListener('resize', updatePosition);
                return () => window.removeEventListener('resize', updatePosition);
            }, [currentStepIndex, step]);

            if (!step) return null;

            return (
                <div className="fixed inset-0 z-[9999] overflow-hidden">
                    {/* Dark Overlay with Cutout */}
                    <div className="absolute inset-0 bg-slate-900/80 mix-blend-hard-light duration-300"></div>

                    {/* Target Highlight */}
                    {targetRect && (
                        <div
                            className="absolute transition-all duration-500 ease-in-out border-4 border-blue-500 rounded-xl shadow-[0_0_0_9999px_rgba(15,23,42,0.8)] pointer-events-none animate-pulse"
                            style={{
                                top: targetRect.top - 8,
                                left: targetRect.left - 8,
                                width: targetRect.width + 16,
                                height: targetRect.height + 16,
                            }}
                        ></div>
                    )}

                    {/* Tooltip Card */}
                    <div
                        className={`absolute transition-all duration-500 ease-in-out max-w-sm w-full p-6 bg-white rounded-2xl shadow-2xl border border-slate-200 ${targetRect ? '' : 'top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2'}`}
                        style={targetRect ? {
                            top: targetRect.top + targetRect.height + 24 > window.innerHeight - 200 ? targetRect.top - 200 : targetRect.top + targetRect.height + 24,
                            left: Math.max(16, Math.min(window.innerWidth - 340, targetRect.left)),
                        } : {}}
                    >
                        <div className="flex justify-between items-start mb-4">
                            <h3 className="text-xl font-extrabold text-slate-800">{step.title}</h3>
                            <button onClick={onSkip} className="text-slate-400 hover:text-slate-600">
                                <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="x" class="w-5 h-5"></i>' }}></span>
                            </button>
                        </div>
                        <p className="text-slate-600 mb-6 leading-relaxed">{step.content}</p>
                        <div className="flex justify-between items-center">
                            <span className="text-xs font-bold text-slate-400 uppercase tracking-widest">
                                Paso {currentStepIndex + 1} de {steps.length}
                            </span>
                            <button
                                onClick={onNext}
                                className="px-6 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 active:scale-95 transition-all shadow-lg shadow-blue-200"
                            >
                                {currentStepIndex === steps.length - 1 ? '¡Listo!' : 'Siguiente'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const { onAuthStateChanged, collection, query, where, onSnapshot, addDoc, updateDoc, doc, deleteDoc, signOut, orderBy } = window.firebaseMethods;
            const [user, setUser] = useState(null);
            const [view, setView] = useState('teams-list');
            const [teams, setTeams] = useState([]);
            const [matches, setMatches] = useState([]);
            const [selectedTeamId, setSelectedTeamId] = useState(null);
            const [activeMatchId, setActiveMatchId] = useState(null);
            const [authLoading, setAuthLoading] = useState(true);
            const [subscription, setSubscription] = useState(undefined); // undefined = loading, null = free, 'active' = premium
            const [checkoutLoading, setCheckoutLoading] = useState(false);
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            // Tutorial State
            const [showTutorial, setShowTutorial] = useState(false);
            const [tutorialStep, setTutorialStep] = useState(0);

            const TUTORIAL_STEPS_MAIN = [
                { target: null, title: "¡Bienviendo a Basket Manager!", content: "Gestiona tus equipos, partidos y jugadores de forma fácil y rápida. Te haremos un breve tour." },
                { target: '#add-team-btn', title: "Crear Equipo", content: "Empieza aquí para añadir tu primer equipo. Podrás configurar jugadores y roles." },
                { target: '#global-calendar-btn', title: "Calendario Global", content: "Consulta de un vistazo todos los partidos de todos tus equipos." },
                { target: '#help-btn', title: "Ayuda", content: "Si necesitas volver a ver este tutorial, pulsa aquí." },
            ];

            const TUTORIAL_STEPS_SETTINGS = [
                { target: '#tutorial-fed-id', title: "Sincronización Federación", content: "Introduce aquí el ID de tu equipo (ej. 1234) para importar partidos y estadísticas automáticamente desde la FBCV." },
                { target: null, title: "Guardar Cambios", content: "Recuerda guardar los cambios para que la sincronización se active." }
            ];

            const TUTORIAL_STEPS_MATCH = [
                { target: '#tutorial-edit-mode', title: "Modo Edición Total", content: "Activa este modo para corregir cualquier evento pasado (cesta, falta, periodo) o modificar el acta libremente." },
                { target: '#tutorial-period-nav', title: "Navegación de Periodos", content: "Usa estas flechas para moverte entre periodos y revisar lo ocurrido o hacer correcciones." },
                { target: '#tutorial-injury-btn', title: "Gestión de Lesiones", content: "Registra aquí las sustituciones por lesión para que consten en el acta y estadísticas." }
            ];

            const currentTutorialSteps = useMemo(() => {
                if (view === 'team-settings') return TUTORIAL_STEPS_SETTINGS;
                if (view === 'active-match') return TUTORIAL_STEPS_MATCH;
                return TUTORIAL_STEPS_MAIN;
            }, [view]);

            useEffect(() => {
                const tutorialCompleted = localStorage.getItem('tutorial_completed');
                if (!tutorialCompleted) {
                    setShowTutorial(true);
                }
            }, []);

            const handleNextTutorial = () => {
                if (tutorialStep < currentTutorialSteps.length - 1) {
                    setTutorialStep(prev => prev + 1);
                } else {
                    completeTutorial();
                }
            };

            const completeTutorial = () => {
                setShowTutorial(false);
                setTutorialStep(0);
                localStorage.setItem('tutorial_completed', 'true');
            };

            const startTutorial = () => {
                setShowTutorial(true);
                setTutorialStep(0);
            };

            useEffect(() => {
                const handleOnline = () => setIsOnline(true);
                const handleOffline = () => setIsOnline(false);
                window.addEventListener('online', handleOnline);
                window.addEventListener('offline', handleOffline);
                return () => {
                    window.removeEventListener('online', handleOnline);
                    window.removeEventListener('offline', handleOffline);
                };
            }, []);

            const navigate = (newView, teamId = null, matchId = null) => {
                setView(newView);
                if (teamId) setSelectedTeamId(teamId);
                if (matchId) setActiveMatchId(matchId);
                window.scrollTo(0, 0);
            };

            useEffect(() => {
                onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setAuthLoading(false);
                    if (!u) {
                        setTeams([]);
                        setMatches([]);
                    }
                });
            }, []);

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'teams'), where('ownerId', '==', user.uid));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const teamsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setTeams(teamsData);
                });
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'matches'), where('ownerId', '==', user.uid));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const matchesData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setMatches(matchesData);
                });
                return () => unsubscribe();
            }, [user]);

            useEffect(() => {
                if (!user) return;
                const subRef = collection(db, 'customers', user.uid, 'subscriptions');
                const q = query(subRef, where('status', 'in', ['active', 'trialing']));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        // Double check just in case sync is slow or user just subscribed
                        // Fallback to check metadata on user object if needed, but for now strict check
                        // Add a small delay/retry logic if needed for newly created subs
                        setTimeout(() => {
                            setSubscription(null);
                        }, 400);
                    } else {
                        setSubscription(snapshot.docs[0].data().status);
                    }
                });
                return () => unsubscribe();
            }, [user]);

            const startCheckout = async () => {
                setCheckoutLoading(true);
                try {
                    const checkoutRef = collection(db, 'customers', user.uid, 'checkout_sessions');
                    const docRef = await addDoc(checkoutRef, {
                        price: 'price_1T0gwQKPQKkc3mVNhH05plnK', // ID real del producto del usuario
                        success_url: window.location.href,
                        cancel_url: window.location.href,
                    });

                    onSnapshot(docRef, (snap) => {
                        const { url, error } = snap.data();
                        if (url) window.location.assign(url);
                        if (error) {
                            setCheckoutLoading(false);
                            alert(`Error de Stripe: ${error.message}`);
                        }
                    });
                } catch (err) {
                    setCheckoutLoading(false);
                    alert(err.message);
                }
            };

            const getSelectedTeam = () => teams.find(t => t.id === selectedTeamId);
            const getActiveMatch = () => matches.find(m => m.id === activeMatchId);

            const updateTeamInDb = async (teamId, updates) => {
                const teamRef = doc(db, 'teams', teamId);
                await updateDoc(teamRef, updates);
            };

            const updateMatchInDb = async (matchId, updates) => {
                const matchRef = doc(db, 'matches', matchId);
                await updateDoc(matchRef, updates);
            };

            if (authLoading || (user && subscription === undefined)) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-50">
                    <div className="flex flex-col items-center gap-4">
                        <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                        <p className="text-slate-400 text-xs font-bold uppercase tracking-widest animate-pulse">Cargando perfil...</p>
                    </div>
                </div>
            );

            if (!user) return <AuthView />;

            return (
                <div className="min-h-screen flex flex-col">
                    <TopBar navigate={navigate} view={view} signOut={signOut} subscription={subscription} isOnline={isOnline} startTutorial={startTutorial} />

                    {showTutorial && (
                        <TutorialOverlay
                            steps={currentTutorialSteps}
                            currentStepIndex={tutorialStep}
                            onNext={handleNextTutorial}
                            onSkip={completeTutorial}
                        />
                    )}

                    <div className="flex-grow">
                        {view === 'teams-list' && <TeamsListView teams={teams} matches={matches} navigate={navigate} addDoc={addDoc} collection={collection} db={db} deleteDoc={deleteDoc} doc={doc} subscription={subscription} startCheckout={startCheckout} />}
                        {view === 'all-matches-calendar' && <AllMatchesCalendarView teams={teams} matches={matches} navigate={navigate} />}
                        {view === 'team-detail' && <TeamDetailView team={getSelectedTeam()} matches={matches} navigate={navigate} updateTeamInDb={updateTeamInDb} getRoles={getRoles} addDoc={addDoc} collection={collection} db={db} />}
                        {view === 'match-setup' && <MatchSetupView team={getSelectedTeam()} navigate={navigate} addDoc={addDoc} collection={collection} db={db} />}
                        {view === 'active-match' && <ActiveMatchView match={getActiveMatch()} teams={teams} updateMatchInDb={updateMatchInDb} navigate={navigate} getRoles={getRoles} />}
                        {view === 'calendar' && <CalendarView team={getSelectedTeam()} matches={matches} navigate={navigate} />}
                        {view === 'edit-match' && (
                            <div className="p-4 max-w-md mx-auto">

                                <EditMatchView
                                    match={getActiveMatch()}
                                    team={getSelectedTeam()}
                                    onSave={async (updates) => { await updateMatchInDb(activeMatchId, updates); navigate('team-detail', selectedTeamId); }}
                                />
                            </div>
                        )}
                        {view === 'manage-players' && <ManagePlayersView team={getSelectedTeam()} navigate={navigate} updateTeamInDb={updateTeamInDb} getRoles={getRoles} match={getActiveMatch()} updateMatchInDb={updateMatchInDb} />}
                        {view === 'manage-roles' && <ManageRolesView team={getSelectedTeam()} navigate={navigate} updateTeamInDb={updateTeamInDb} getRoles={getRoles} />}
                        {view === 'team-settings' && <TeamSettingsView team={getSelectedTeam()} navigate={navigate} updateTeamInDb={updateTeamInDb} deleteDoc={deleteDoc} doc={doc} db={db} />}
                    </div>
                    <footer className="p-4 text-center mt-auto border-t border-slate-100">
                        <div className="flex items-center justify-center gap-3">
                            {subscription === 'active' || subscription === 'trialing' ? (
                                <span className="text-[10px] font-bold text-amber-500 uppercase tracking-widest flex items-center gap-1.5 bg-amber-50 px-2 py-1 rounded-full border border-amber-100">
                                    <span dangerouslySetInnerHTML={{ __html: '<i data-lucide="crown" class="w-3 h-3"></i>' }}></span> Premium
                                </span>
                            ) : null}
                            <span className="text-[10px] font-bold text-slate-300 uppercase tracking-widest">v{APP_VERSION}</span>
                        </div>
                    </footer>

                    {checkoutLoading && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] flex items-center justify-center p-6 text-center">
                            <div className="bg-white rounded-3xl p-8 max-w-xs w-full shadow-2xl animate-in fade-in zoom-in duration-300">
                                <div className="w-16 h-16 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-6"></div>
                                <h3 className="text-xl font-bold text-slate-800 mb-2">Preparando pago</h3>
                                <p className="text-slate-500 text-sm">Te estamos redirigiendo a la pasarela segura de Stripe...</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW registrado', reg))
                    .catch(err => console.log('Error SW', err));
            });
        }
    </script>
</body>

</html>